<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Live User Tracker - ECG View</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #0c0f1c;
      margin: 0;
      padding: 20px;
      color: #fff;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
      font-weight: 600;
    }

    .user-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      max-width: 600px;
      margin: auto;
    }

    .user-card {
      display: flex;
      align-items: center;
      background-color: #1a1f2e;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.1);
    }

    .ecg {
      width: 120px;
      height: 40px;
    }

    .ecg polyline {
      fill: none;
      stroke-width: 2;
      stroke-linejoin: round;
      stroke-linecap: round;
    }

    .ecg.live polyline {
      stroke: #00ffcc;
      stroke-dasharray: 200;
      stroke-dashoffset: 200;
      animation: dash 1.5s linear infinite;
    }

    .ecg.offline polyline {
      stroke: red;
    }

    @keyframes dash {
      to {
        stroke-dashoffset: 0;
      }
    }

    .user-info {
      margin-left: 20px;
    }

    .user-info .name {
      font-size: 18px;
      font-weight: bold;
    }

    .user-info .time {
      font-size: 14px;
      color: #ccc;
    }

    select {
      display: block;
      margin: 0 auto 20px auto;
      padding: 10px;
      border-radius: 5px;
      border: none;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <h1>User Live Status - Lifeline</h1>
  <select id="userFilter" multiple></select>
  <div class="user-container" id="userContainer"></div>

  <script>
    const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSo76L7XI-AHGphJRHyTXCwMVuizeUUfb23MlzOvKRJBXF4JccS_gl5koNEzy6I61crp7dLXYPvYP2W/pub?gid=0&single=true&output=csv';

    let selectedUsers = JSON.parse(localStorage.getItem('selectedUsers') || '[]');

    async function fetchCSVData() {
      const res = await fetch(sheetUrl);
      const text = await res.text();
      const rows = text.trim().split('\n').map(row => row.split(','));
      const headers = rows[0];
      const data = rows.slice(1).map(row => {
        let obj = {};
        headers.forEach((h, i) => obj[h.trim()] = row[i]?.trim());
        return obj;
      });
      return data;
    }

    function calculateTimeDiff(lastLog) {
      const last = new Date(lastLog);
      const now = new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' }));
      if (isNaN(last)) return { status: 'offline', diff: '??:??' };
      const diffSec = Math.floor((now - last) / 1000);
      const mins = String(Math.floor(diffSec / 60)).padStart(2, '0');
      const secs = String(diffSec % 60).padStart(2, '0');
      const status = diffSec <= 240 ? 'live' : 'offline';
      return { status, diff: `${mins}:${secs}` };
    }

    function createECGSVG(status) {
      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.setAttribute('class', `ecg ${status}`);
      svg.setAttribute('viewBox', '0 0 100 20');
      const polyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
      polyline.setAttribute('points', status === 'live' ? '0,10 10,10 15,5 20,15 25,10 40,10 50,2 55,10 60,10 100,10' : '0,10 100,10');
      svg.appendChild(polyline);
      return svg;
    }

    function renderUsers(data) {
      const container = document.getElementById('userContainer');
      container.innerHTML = '';

      const latestLogs = {};
      data.forEach(row => {
        const user = row['User'];
        const log = row['Last Log'];
        if (!latestLogs[user] || new Date(log) > new Date(latestLogs[user]['Last Log'])) {
          latestLogs[user] = row;
        }
      });

      const filtered = selectedUsers.length > 0
        ? Object.entries(latestLogs).filter(([user]) => selectedUsers.includes(user))
        : Object.entries(latestLogs);

      filtered.forEach(([user, info]) => {
        const { status, diff } = calculateTimeDiff(info['Last Log']);
        const card = document.createElement('div');
        card.className = 'user-card';
        const svg = createECGSVG(status);
        const infoDiv = document.createElement('div');
        infoDiv.className = 'user-info';
        infoDiv.innerHTML = `<div class="name">${user}</div><div class="time">Time: ${diff}</div>`;
        card.appendChild(svg);
        card.appendChild(infoDiv);
        container.appendChild(card);
      });
    }

    function populateFilter(data) {
      const dropdown = document.getElementById('userFilter');
      const uniqueUsers = [...new Set(data.map(d => d['User']))];
      dropdown.innerHTML = '';

      uniqueUsers.forEach(user => {
        const option = document.createElement('option');
        option.value = user;
        option.textContent = user;
        if (selectedUsers.includes(user)) option.selected = true;
        dropdown.appendChild(option);
      });

      dropdown.addEventListener('change', () => {
        selectedUsers = Array.from(dropdown.selectedOptions).map(opt => opt.value);
        localStorage.setItem('selectedUsers', JSON.stringify(selectedUsers));
        updateData();
      });
    }

    async function updateData() {
      const data = await fetchCSVData();
      populateFilter(data);
      renderUsers(data);
    }

    updateData();
    setInterval(updateData, 60000); // every 1 minute
  </script>
</body>
</html>
