<!DOCTYPE html>
<html lang="en">
<head>
  <!-- [HEAD CONTENT START] -->
  <meta charset="UTF-8" />
  <title>360 Issue Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="https://spyne-prod-ai.s3.us-east-1.amazonaws.com/ai-dataset/2025/favicon.ico" type="image/x-icon" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
  <!-- [HEAD CONTENT END] -->
<script>
const qcSheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTaSxWZ-Y3M-wyNiCdN7FSH5kAMMy1cox7D_YRn2sWNkGfo1j4WCGbaedRXgnUKvELK5eAMv334UCaD/pub?gid=0&single=true&output=csv';
const dashboardSheet1 = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR1F4V8WG1U4oYT6HwjZ2Mnv83l_90MYfjNFduCRl7lsx4GBVkFrmAVTwdXLiJgfc6eaykGb8Ygo_GD/pub?gid=0&single=true&output=csv';
const dashboardSheet2 = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTmm6um2dDueAholFhs2olel5wv2mqH9f1jCAfdL8Qi76mzqbTfzu7OYRea5PwSJP0eD0RLuF6XOkTy/pub?gid=0&single=true&output=csv';
</script>
</head>
<body>
  <!-- [HEADER, FILTERS, TABS, DASHBOARD TAB START] -->
  <div class="header-bar">360 Issue Dashboard</div>
  <div class="filters" id="dashboardFilters"></div>
  <div class="tabs">
    <div class="tab active" data-tab="dashboardTab">Dashboard</div>
    <div class="tab" data-tab="summaryTab">Summary</div>
    <div class="tab" data-tab="qcReportTab">QC Report</div>
  </div>
  <div class="main-content tab-content active" id="dashboardTab">
    <div class="chart-row">
      <div class="chart-box issue"><canvas id="issueChart"></canvas></div>
      <div class="chart-box pie"><canvas id="severityPie"></canvas></div>
    </div>
    <div class="dual-table-row">
      <div class="full-width-table">
        <h3>Issue</h3>
        <table id="issueSummary">
          <thead>
            <tr><th>Issue</th><th>Total (%)</th><th>Blocker (%)</th><th>High (%)</th><th>Low (%)</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="full-width-table">
        <h3>Enterprise</h3>
        <table id="enterpriseSummary">
          <thead>
            <tr><th>Enterprise</th><th>Total (%)</th><th>Blocker (%)</th><th>High (%)</th><th>Low (%)</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <div class="bottom-row">
      <div class="table-box">
        <table id="spinTable">
          <thead>
            <tr><th>Spin ID</th><th>Issue</th><th>Severity</th><th>Enterprise</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="iframe-box">
        <iframe id="spinIframe" title="Spin Preview"></iframe>
      </div>
    </div>
  </div>
  <!-- [HEADER, FILTERS, TABS, DASHBOARD TAB END] -->

<div class="main-content tab-content" id="summaryTab">
  <div class="chart-row">
    <div class="chart-container">
      <h3>Severity Trend (%)</h3>
      <canvas id="severityTrendChart"></canvas>
    </div>
    <div class="chart-container">
      <h3>Issue Trend (%)</h3>
      <canvas id="issueTrendChart"></canvas>
    </div>
  </div>
  <div class="summary-tables">
    <h3>Severity Details (Week-wise)</h3>
    <table id="severityDetailsTable">
      <thead><tr id="severityDetailsHeader"><th onclick="sortTable(this)">Severity</th></tr></thead>
      <tbody id="severityDetailsBody"></tbody>
    </table>
    <h3>Issue Details (Week-wise)</h3>
    <table id="issueDetailsTable">
      <thead><tr id="issueDetailsHeader"><th onclick="sortTable(this)">Issue</th></tr></thead>
      <tbody id="issueDetailsBody"></tbody>
    </table>
  </div>
</div>

<!-- [QC REPORT TAB, SPIN MODAL START] -->
<div class="main-content tab-content" id="qcReportTab">
  <div class="sticky-header">
    <h1>QC Report Dashboard</h1>
    <div class="filters">
      <input type="text" id="dateRange" placeholder="Select Date Range..." readonly>
      <select id="enterpriseFilter" multiple placeholder="Select Enterprise..."></select>
      <select id="severityFilter">
        <option value="">All Severities</option>
        <option>Blocker</option>
        <option>High</option>
        <option>Low</option>
      </select>
      <select id="issueFilter" multiple placeholder="Select Issue..."></select>
      <select id="userFilter" multiple placeholder="Select User..."></select>
    </div>
  </div>
  <h2>Date-wise Summary</h2>
  <div class="table-wrapper">
    <table id="summaryTable">
      <thead>
        <tr><th>Date</th><th>SKU Count</th><th>Unique Enterprises</th><th>Total Edited Images</th><th>Average TAT</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <h2>Detailed Report</h2>
  <div class="table-wrapper">
    <table id="reportTable">
      <thead>
        <tr><th>Date</th><th>Spin ID</th><th>SKU ID</th><th>Enterprise Name</th><th>User</th><th>Edited</th><th>TAT (Min)</th><th>View Spin</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div id="spinModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:1000;justify-content:center;align-items:center;flex-direction:column;">
    <div style="background:#fff;padding:20px;width:80vw;height:80vh;overflow:auto;border-radius:8px;position:relative;display:flex;flex-direction:column;">
      <span onclick="document.getElementById('spinModal').style.display='none'" style="position:absolute;top:10px;right:15px;font-size:20px;cursor:pointer;">&times;</span>
      <div id="modalInfo" style="margin-bottom:10px;font-weight:bold;text-align:center;"></div>
      <div style="margin-bottom:10px;text-align:right;">
        <button onclick="navigateSpin(-1)">Previous</button>
        <button onclick="navigateSpin(1)">Next</button>
      </div>
      <iframe id="modalIframe" src="" style="width:100%;height:500px;border:none;display:block;margin:auto;"></iframe>
    </div>
  </div>
</div>
<!-- [QC REPORT TAB, SPIN MODAL END] -->

<script>
function getWeekLabel(dateStr) {
  const d = new Date(dateStr);
  const day = d.getDay();
  const diffToMonday = d.getDate() - day + (day === 0 ? -6 : 1); // Monday
  const monday = new Date(d.setDate(diffToMonday));
  const sunday = new Date(monday);
  sunday.setDate(monday.getDate() + 6);
  return `${monday.toISOString().slice(0, 10)} to ${sunday.toISOString().slice(0, 10)}`;
}

function filterLast4Weeks(data) {
  const now = new Date();
  const fourWeeksAgo = new Date();
  fourWeeksAgo.setDate(now.getDate() - 28);
  return data.filter(row => {
    const d = new Date(row.Date || row.date || row.created_on);
    return d >= fourWeeksAgo && d <= now;
  });
}

function transformDataToWeek(data) {
  return data.map(row => {
    const week = getWeekLabel(row.Date || row.date || row.created_on);
    return { ...row, Week: week };
  });
}

function renderSeverityTrendChart(data) {
  const recentData = transformDataToWeek(filterLast4Weeks(data));
  const weeks = Array.from(new Set(recentData.map(d => d.Week))).sort();
  const severities = Array.from(new Set(recentData.map(d => d.Severity).filter(Boolean)));
  const totalPerWeek = {};
  const matrix = {};
  recentData.forEach(row => {
    const w = row.Week;
    if (!totalPerWeek[w]) totalPerWeek[w] = 0;
    totalPerWeek[w]++;
    if (!matrix[row.Severity]) matrix[row.Severity] = {};
    if (!matrix[row.Severity][w]) matrix[row.Severity][w] = 0;
    matrix[row.Severity][w]++;
  });
  const colors = { Blocker: '#FF0000', High: '#FF6384', Low: '#36A2EB' };
  const datasets = severities.map(sev => ({
    label: sev,
    data: weeks.map(w => ((matrix[sev]?.[w] || 0) / (totalPerWeek[w] || 1) * 100).toFixed(1)),
    borderColor: colors[sev] || '#000',
    fill: false, tension: 0.4
  }));
  new Chart(document.getElementById('severityTrendChart'), {
    type: 'line', data: { labels: weeks, datasets },
    options: { responsive: true, plugins: { legend: { position: 'top' } } }
  });
}

function renderIssueTrendChart(data) {
  const recentData = transformDataToWeek(filterLast4Weeks(data));
  const weeks = Array.from(new Set(recentData.map(d => d.Week))).sort();
  const issues = Array.from(new Set(recentData.map(d => d.Issue).filter(Boolean)));
  const totalPerWeek = {};
  const matrix = {};
  recentData.forEach(row => {
    const w = row.Week;
    if (!totalPerWeek[w]) totalPerWeek[w] = 0;
    totalPerWeek[w]++;
    if (!matrix[row.Issue]) matrix[row.Issue] = {};
    if (!matrix[row.Issue][w]) matrix[row.Issue][w] = 0;
    matrix[row.Issue][w]++;
  });
  const colors = ['#FF9F40', '#9966FF', '#FFCD56', '#4BC0C0', '#36A2EB', '#FF6384'];
  const datasets = issues.map((issue, i) => ({
    label: issue,
    data: weeks.map(w => ((matrix[issue]?.[w] || 0) / (totalPerWeek[w] || 1) * 100).toFixed(1)),
    borderColor: colors[i % colors.length],
    fill: false, tension: 0.4
  }));
  new Chart(document.getElementById('issueTrendChart'), {
    type: 'line', data: { labels: weeks, datasets },
    options: { responsive: true, plugins: { legend: { position: 'top' } } }
  });
}

function renderSeverityDetailsTable(data) {
  const recentData = transformDataToWeek(filterLast4Weeks(data));
  const weeks = Array.from(new Set(recentData.map(d => d.Week))).sort();
  const severities = Array.from(new Set(recentData.map(d => d.Severity).filter(Boolean)));
  const header = document.getElementById('severityDetailsHeader');
  const body = document.getElementById('severityDetailsBody');
  const matrix = {}, totals = {};
  recentData.forEach(row => {
    const { Severity: sev, Week: w } = row;
    matrix[sev] = matrix[sev] || {}; matrix[sev][w] = (matrix[sev][w] || 0) + 1;
    totals[w] = (totals[w] || 0) + 1;
  });
  header.innerHTML = '<th>Severity</th>' + weeks.map(w => `<th>${w}</th>`).join('');
  body.innerHTML = severities.map(sev => {
    const cells = weeks.map(w => {
      const count = matrix[sev]?.[w] || 0;
      const percent = ((count / (totals[w] || 1)) * 100).toFixed(1);
      return `<td>${count} <span style='font-size:0.6em;color:#888;'>(${percent}%)</span></td>`;
    });
    return `<tr><td>${sev}</td>${cells.join('')}</tr>`;
  }).join('');
}

function renderIssueDetailsTable(data) {
  const recentData = transformDataToWeek(filterLast4Weeks(data));
  const weeks = Array.from(new Set(recentData.map(d => d.Week))).sort();
  const issues = Array.from(new Set(recentData.map(d => d.Issue).filter(Boolean)));
  const header = document.getElementById('issueDetailsHeader');
  const body = document.getElementById('issueDetailsBody');
  const matrix = {}, totals = {};
  recentData.forEach(row => {
    const { Issue: issue, Week: w } = row;
    matrix[issue] = matrix[issue] || {}; matrix[issue][w] = (matrix[issue][w] || 0) + 1;
    totals[w] = (totals[w] || 0) + 1;
  });
  header.innerHTML = '<th>Issue</th>' + weeks.map(w => `<th>${w}</th>`).join('');
  body.innerHTML = issues.map(issue => {
    const cells = weeks.map(w => {
      const count = matrix[issue]?.[w] || 0;
      const percent = ((count / (totals[w] || 1)) * 100).toFixed(1);
      return `<td>${count} <span style='font-size:0.6em;color:#888;'>(${percent}%)</span></td>`;
    });
    return `<tr><td>${issue}</td>${cells.join('')}</tr>`;
  }).join('');
}
</script>

</body>
</html>
