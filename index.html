<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Optimized QC Review Dashboard</title>
  <link rel="icon" href="https://spyne-prod-ai.s3.us-east-1.amazonaws.com/ai-dataset/2025/logo/unnamed.png" type="image/x-icon"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --primary-light: #dbeafe;
      --secondary: #8b5cf6;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --dark: #1e293b;
      --light: #f8fafc;
      --gray: #94a3b8;
      --border: #e2e8f0;
      --card-bg: #ffffff;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --radius: 12px;
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      color: var(--dark);
      line-height: 1.6;
      min-height: 100vh;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow-x: hidden;
    }

    .dashboard-container {
      max-width: 1200px;
      width: 100%;
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .dashboard-header {
      background: linear-gradient(to right, var(--primary), var(--secondary));
      color: white;
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
    }

    .logo-container {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo {
      width: 50px;
      height: 50px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: var(--primary);
    }

    .header-text h1 {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .header-text p {
      opacity: 0.9;
      font-size: 0.9rem;
    }

    .content-area {
      padding: 30px;
    }

    .section-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--border);
    }

    .login-section {
      background: var(--light);
      border-radius: var(--radius);
      padding: 30px;
      box-shadow: var(--shadow);
      margin-bottom: 30px;
    }

    .source-toggle {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }

    .source-toggle label {
      background: var(--primary-light);
      padding: 12px 20px;
      border-radius: var(--radius);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      transition: var(--transition);
      border: 2px solid transparent;
    }

    .source-toggle input:checked + label {
      background: var(--primary);
      color: white;
      border-color: var(--primary-dark);
    }

    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
    }

    .filter-group label {
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-group select {
      padding: 12px 15px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: white;
      font-size: 15px;
      transition: var(--transition);
    }

    .filter-group select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-light);
    }

    .dashboard-actions {
      display: flex;
      gap: 15px;
      margin-top: 20px;
    }

    .btn {
      padding: 12px 25px;
      border-radius: var(--radius);
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: var(--transition);
      border: none;
      font-size: 16px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: var(--secondary);
      color: white;
    }

    .btn-secondary:hover {
      background: #7c3aed;
      transform: translateY(-2px);
    }

    .review-section, .meet-review-section {
      display: none;
      background: white;
      box-shadow: var(--shadow);
      overflow: hidden;
      width: 100%;
      border-radius: 0 0 var(--radius) var(--radius);
    }

    .review-header {
      background: var(--primary-light);
      padding: 20px 30px;
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }

    .info-card {
      background: white;
      border-radius: var(--radius);
      padding: 15px;
      min-width: 200px;
      flex: 1;
      box-shadow: var(--shadow);
    }

    .info-card h3 {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--gray);
      margin-bottom: 8px;
    }

    .info-card p {
      font-weight: 600;
      font-size: 1.1rem;
      color: var(--dark);
    }

    .progress-indicator {
      background: white;
      padding: 15px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
    }

    .image-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      padding: 30px;
    }

    .image-container {
      background: var(--light);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .image-container img {
      width: 100%;
      height: 250px;
      object-fit: contain;
      display: block;
      background: #f8f9fa;
    }

    .image-label {
      text-align: center;
      padding: 12px;
      font-weight: 600;
      background: white;
      border-top: 1px solid var(--border);
    }

    .comment-section {
      padding: 0 30px 30px;
    }

    .comment-section textarea {
      width: 100%;
      padding: 15px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      min-height: 120px;
      font-size: 16px;
      resize: vertical;
      transition: var(--transition);
    }

    .comment-section textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-light);
    }

    .nav-buttons {
      display: flex;
      gap: 15px;
      padding: 20px 30px;
      background: var(--light);
      border-top: 1px solid var(--border);
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
    }

    .btn-outline:hover {
      background: var(--primary-light);
    }

    .loading-container {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px;
      flex-direction: column;
      gap: 20px;
      display: none;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid var(--primary-light);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .status-message {
      padding: 15px 20px;
      border-radius: var(--radius);
      margin-top: 20px;
      display: none;
    }

    .status-message.error {
      background: #fee2e2;
      color: #b91c1c;
      border-left: 4px solid #ef4444;
    }

    .status-message.success {
      background: #dcfce7;
      color: #15803d;
      border-left: 4px solid #10b981;
    }

    .status-message.warning {
      background: #fef3c7;
      color: #b45309;
      border-left: 4px solid #f59e0b;
    }

    .dashboard-footer {
      text-align: center;
      padding: 20px;
      color: var(--gray);
      font-size: 0.9rem;
      border-top: 1px solid var(--border);
    }

    .keyboard-hint {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--dark);
      color: white;
      padding: 10px 15px;
      border-radius: var(--radius);
      font-size: 0.9rem;
      box-shadow: var(--shadow);
      z-index: 100;
    }

    .keyboard-hint kbd {
      background: var(--primary);
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      margin: 0 2px;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .dashboard-header {
        flex-direction: column;
        text-align: center;
        gap: 20px;
      }
      
      .filters-grid {
        grid-template-columns: 1fr;
      }
      
      .image-grid {
        grid-template-columns: 1fr;
        padding: 15px;
      }
      
      .nav-buttons {
        flex-direction: column;
      }
      
      .nav-buttons button {
        width: 100%;
      }
      
      .keyboard-hint {
        bottom: 10px;
        right: 10px;
        left: 10px;
        text-align: center;
      }
      
      .review-header {
        padding: 15px;
        gap: 10px;
      }
      
      .info-card {
        min-width: calc(50% - 10px);
        flex: 0 0 auto;
      }
    }
    
    @media (min-width: 1200px) {
      .dashboard-container {
        max-width: 100%;
        border-radius: 0;
      }
      
      body {
        padding: 0;
      }
    }
    
    /* Meet Review button styles */
    .meet-review-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid white;
      color: white;
      padding: 10px 20px;
      border-radius: 50px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: var(--transition);
      margin-top: 15px;
    }

    .meet-review-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }
    
    /* Placeholder styles */
    .placeholder-img {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--gray);
      font-weight: bold;
      height: 250px;
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <div class="dashboard-header">
      <div class="logo-container">
        <div class="logo">
          <i class="fas fa-cube"></i>
        </div>
        <div class="header-text">
          <h1>Optimized QC Dashboard</h1>
          <p>Enhanced performance with optimized loading</p>
        </div>
      </div>
    </div>

    <div class="content-area">
      <!-- Login Section -->
      <div class="login-section" id="loginSection">
        <h2 class="section-title">QC Review Login</h2>
        
        <div class="source-toggle">
          <input type="radio" name="dataSource" value="qc" id="qcSource" checked>
          <label for="qcSource">
            <i class="fas fa-check-circle"></i>
            QC-Pass
          </label>
          
          <input type="radio" name="dataSource" value="edited" id="editedSource">
          <label for="editedSource">
            <i class="fas fa-redo"></i>
            Re-Edit
          </label>
          
          <input type="radio" name="dataSource" value="qc_tool" id="qcToolSource">
          <label for="qcToolSource">
            <i class="fas fa-tools"></i>
            QC-Tool
          </label>
        </div>
        
        <div class="filters-grid">
          <div class="filter-group">
            <label for="loginID"><i class="fas fa-user"></i> Login ID</label>
            <select id="loginID">
              <option value="">Select Login ID</option>
              <option>Nand Kishor</option>
              <option>Ranbir Manoranjan</option>
              <option>Nitin kumar</option>
              <option>Praveen Agarwal</option>
              <option>Raj Tripatrhi</option>
              <option>Rohit Chahuhan</option>
              <option>Saurabh Pandey</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label for="dateFilter"><i class="fas fa-calendar"></i> Date</label>
            <select id="dateFilter">
              <option value="">ALL</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label for="enterpriseFilter"><i class="fas fa-building"></i> Enterprise</label>
            <select id="enterpriseFilter">
              <option value="">ALL</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label for="qcUserFilter"><i class="fas fa-user-check"></i> QC User</label>
            <select id="qcUserFilter">
              <option value="">ALL</option>
            </select>
          </div>
          
          <div class="filter-group" id="editingUserFilterContainer" style="display: none;">
            <label for="editingUserFilter"><i class="fas fa-user-edit"></i> Editing User</label>
            <select id="editingUserFilter">
              <option value="">ALL</option>
            </select>
          </div>
          
          <div class="filter-group" id="issueFilterContainer" style="display: none;">
            <label for="issueFilter"><i class="fas fa-exclamation-circle"></i> Issue</label>
            <select id="issueFilter">
              <option value="">ALL</option>
            </select>
          </div>
        </div>
        
        <div class="dashboard-actions">
          <button class="btn btn-primary" id="startButton">
            <i class="fas fa-play"></i>
            Start QC
          </button>
          <div class="meet-review-btn" id="meetReviewButton">
            <i class="fas fa-users"></i>
            Meet Review
          </div>
        </div>
        
        <div class="loading-container" id="loadingIndicator">
          <div class="loading-spinner"></div>
          <p>Loading data, please wait...</p>
        </div>
        
        <div class="status-message" id="statusMessage"></div>
      </div>
      
      <!-- Review Section -->
      <div class="review-section" id="reviewSection">
        <h2 class="section-title">Review Details</h2>
        
        <div class="review-header">
          <div class="info-card">
            <h3>Enterprise</h3>
            <p id="enterprise">-</p>
          </div>
          
          <div class="info-card" id="qcUsersContainer">
            <h3>QC Users</h3>
            <p id="qcUsers">-</p>
          </div>
          
          <div class="info-card" id="userContainer">
            <h3>User</h3>
            <p id="user">-</p>
          </div>
          
          <div class="info-card" id="editingUserContainer">
            <h3>Editing User</h3>
            <p id="editingUser">-</p>
          </div>
          
          <div class="info-card" id="issueContainer">
            <h3>Issue</h3>
            <p id="issue">-</p>
          </div>
          
          <div class="info-card">
            <h3>SKU ID</h3>
            <p id="sku">-</p>
          </div>
          
          <div class="info-card">
            <h3>Image ID</h3>
            <p id="imageID">-</p>
          </div>
        </div>
        
        <div class="progress-indicator">
          <div>Reviewing <span id="currentIndexDisplay">1</span> of <span id="totalCountDisplay">0</span></div>
        </div>
        
        <div class="image-grid">
          <div class="image-container">
            <div class="placeholder-img" id="leftPlaceholder">Input Image Loading...</div>
            <img id="left" alt="Input Image" style="display:none;">
            <div class="image-label">Input Image</div>
          </div>
          
          <div class="image-container">
            <div class="placeholder-img" id="middlePlaceholder">AI Image Loading...</div>
            <img id="middle" alt="AI Image" style="display:none;">
            <div class="image-label">AI Image</div>
          </div>
          
          <div class="image-container">
            <div class="placeholder-img" id="rightPlaceholder">Final Image Loading...</div>
            <img id="right" alt="Final Image" style="display:none;">
            <div class="image-label">Final Image</div>
          </div>
        </div>
        
        <div class="comment-section">
          <label for="qcComment">QC Comment</label>
          <textarea id="qcComment" placeholder="Enter your detailed comments here..."></textarea>
        </div>
        
        <div class="nav-buttons">
          <button class="btn btn-outline" onclick="prevEntry()">
            <i class="fas fa-arrow-left"></i>
            Previous
          </button>
          <button class="btn btn-primary" onclick="submitAndNext()">
            Next
            <i class="fas fa-arrow-right"></i>
          </button>
          <button class="btn btn-secondary" onclick="exitToLogin()">
            <i class="fas fa-sign-out-alt"></i>
            Exit to Login
          </button>
        </div>
      </div>
      
      <!-- Meet Review Section -->
      <div class="meet-review-section" id="meetReviewSection">
        <h2 class="section-title">Meet Review Details</h2>
        
        <div class="filters-grid">
          <div class="filter-group">
            <label for="meetDateFilter"><i class="fas fa-calendar"></i> Date</label>
            <select id="meetDateFilter">
              <option value="">ALL</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label for="meetEnterpriseFilter"><i class="fas fa-building"></i> Enterprise</label>
            <select id="meetEnterpriseFilter">
              <option value="">ALL</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label for="meetQcUserFilter"><i class="fas fa-user-check"></i> QC User</label>
            <select id="meetQcUserFilter">
              <option value="">ALL</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label for="meetEditingUserFilter"><i class="fas fa-user-edit"></i> Editing User</label>
            <select id="meetEditingUserFilter">
              <option value="">ALL</option>
            </select>
          </div>
        </div>
        
        <div class="review-header">
          <div class="info-card">
            <h3>Date</h3>
            <p id="meetDate">-</p>
          </div>
          
          <div class="info-card">
            <h3>Enterprise</h3>
            <p id="meetEnterprise">-</p>
          </div>
          
          <div class="info-card">
            <h3>QC User</h3>
            <p id="meetQcUser">-</p>
          </div>
          
          <div class="info-card">
            <h3>Editing User</h3>
            <p id="meetEditingUser">-</p>
          </div>
          
          <div class="info-card">
            <h3>SKU ID</h3>
            <p id="meetSku">-</p>
          </div>
          
          <div class="info-card">
            <h3>Image ID</h3>
            <p id="meetImageID">-</p>
          </div>
        </div>
        
        <div class="review-header">
          <div class="info-card">
            <h3>Issue</h3>
            <p id="meetIssue">-</p>
          </div>
          
          <div class="info-card">
            <h3>Comment</h3>
            <p id="meetComment">-</p>
          </div>
        </div>
        
        <div class="progress-indicator">
          <div>Reviewing <span id="meetCurrentIndexDisplay">1</span> of <span id="meetTotalCountDisplay">0</span></div>
        </div>
        
        <div class="image-grid">
          <div class="image-container">
            <div class="placeholder-img" id="meetLeftPlaceholder">Input Image Loading...</div>
            <img id="meetLeft" alt="Input Image" style="display:none;">
            <div class="image-label">Input Image</div>
          </div>
          
          <div class="image-container">
            <div class="placeholder-img" id="meetMiddlePlaceholder">AI Image Loading...</div>
            <img id="meetMiddle" alt="AI Image" style="display:none;">
            <div class="image-label">AI Image</div>
          </div>
          
          <div class="image-container">
            <div class="placeholder-img" id="meetRightPlaceholder">Final Image Loading...</div>
            <img id="meetRight" alt="Final Image" style="display:none;">
            <div class="image-label">Final Image</div>
          </div>
        </div>
        
        <div class="nav-buttons">
          <button class="btn btn-outline" onclick="prevMeetEntry()">
            <i class="fas fa-arrow-left"></i>
            Previous
          </button>
          <button class="btn btn-primary" onclick="nextMeetEntry()">
            Next
            <i class="fas fa-arrow-right"></i>
          </button>
          <button class="btn btn-secondary" onclick="exitToLogin()">
            <i class="fas fa-sign-out-alt"></i>
            Exit to Login
          </button>
        </div>
      </div>
    </div>
    
    <div class="dashboard-footer">
      <p>Optimized QC Dashboard v3.0 • © 2023 Spyne AI • All rights reserved</p>
    </div>
  </div>
  
  <div class="keyboard-hint">
    <span>Keyboard Shortcuts:</span>
    <kbd>Enter</kbd> - Next Entry
    <kbd>P</kbd> - Previous Entry
    <kbd>Esc</kbd> - Exit to Login
  </div>

  <script>
    // Google Sheets URLs
    const QC_PASS_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSWW7muoNyeY_1VOLhybuT7ChNHtkhAscxDikyiCPQChIWqi1m3KXsd9e0_i_UFE7bDrW_7kfH-vIhL/pub?gid=1717039169&single=true&output=csv";
    const RE_EDIT_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSWW7muoNyeY_1VOLhybuT7ChNHtkhAscxDikyiCPQChIWqi1m3KXsd9e0_i_UFE7bDrW_7kfH-vIhL/pub?gid=320301246&single=true&output=csv";
    const MEET_REVIEW_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSWW7muoNyeY_1VOLhybuT7ChNHtkhAscxDikyiCPQChIWqi1m3KXsd9e0_i_UFE7bDrW_7kfH-vIhL/pub?gid=1880564018&single=true&output=csv";

    // Field mapping configuration
    const FIELD_MAPPING = {
      qc: {
        'enterprise': 'enterprise_name',
        't1.image_id': 'ai.image_id',
        't1.sku_id': 'sku_id',
        'left_path': 'input_image_hres_url',
        'middle_path': 'output_image_hres_url',
        'right_path': 'manual_image_hres_url',
        'user': 'qc_user_name',
        'first_qc_user': '',
        'last_qc_user': '',
        'last_editor_user': '',
        'issue': '',
        'date': 'qc_completed_time',
        'status': 'status'
      },
      edited: {
        'enterprise': 'enterprise_name',
        't1.image_id': 'ai.image_id',
        't1.sku_id': 'sku_id',
        'left_path': 'input_image_hres_url',
        'middle_path': 'ai_output',
        'right_path': 'final_output',
        'user': 'last_qc_user',
        'first_qc_user': 'first_qc_user',
        'last_qc_user': 'last_qc_user',
        'last_editor_user': 'last_editor_user',
        'issue': 'rejected_comments',
        'date': 'qc_completed_time',
        'status': 'status',
        'latest_image_action': 'latest_image_action'
      },
      qc_tool: {
        'enterprise': 'enterprise_name',
        't1.image_id': 'ai.image_id',
        't1.sku_id': 'sku_id',
        'left_path': 'input_image_hres_url',
        'middle_path': 'ai_output',
        'right_path': 'final_output',
        'user': 'last_qc_user',
        'first_qc_user': 'first_qc_user',
        'last_qc_user': 'last_qc_user',
        'last_editor_user': 'last_editor_user',
        'issue': 'rejected_comments',
        'date': 'qc_completed_time',
        'status': 'status',
        'latest_image_action': 'latest_image_action'
      }
    };

    let rawData = [];
    let groupedData = [];
    let currentIndex = 0;

    let meetReviewData = [];
    let filteredMeetData = [];
    let meetReviewCurrentIndex = 0;

    // DOM elements
    const loginSection = document.getElementById('loginSection');
    const reviewSection = document.getElementById('reviewSection');
    const meetReviewSection = document.getElementById('meetReviewSection');
    const statusMessage = document.getElementById('statusMessage');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const meetReviewButton = document.getElementById('meetReviewButton');
    const startButton = document.getElementById('startButton');

    // Cache for images to avoid repeated loading
    const imageCache = new Map();
    const meetImageCache = new Map();

    function showLoading(show) {
      loadingIndicator.style.display = show ? 'flex' : 'none';
      startButton.disabled = show;
      meetReviewButton.disabled = show;
    }

    function showStatus(message, isError = false, isWarning = false) {
      statusMessage.textContent = message;
      statusMessage.className = 'status-message ' + 
        (isError ? 'error' : isWarning ? 'warning' : 'success');
      statusMessage.style.display = 'block';
      
      if (!isError && !isWarning) {
        setTimeout(() => {
          statusMessage.style.display = 'none';
        }, 5000);
      }
    }

    function getDataSource() {
      const selected = document.querySelector('input[name="dataSource"]:checked');
      return selected ? selected.value : 'qc';
    }

    function getDataSourceUrl() {
      return getDataSource() === 'qc' ? QC_PASS_URL : RE_EDIT_URL;
    }

    function toggleAdditionalFilters() {
      const sourceType = getDataSource();
      const editingUserContainer = document.getElementById('editingUserFilterContainer');
      const issueContainer = document.getElementById('issueFilterContainer');
      
      if (sourceType === 'edited' || sourceType === 'qc_tool') {
        editingUserContainer.style.display = 'block';
        issueContainer.style.display = 'block';
      } else {
        editingUserContainer.style.display = 'none';
        issueContainer.style.display = 'none';
      }
    }

    // Normalize data using FIELD_MAPPING
    function normalizeData(rawData, sourceType) {
      const mapping = FIELD_MAPPING[sourceType];
      return rawData.map(row => {
        const normalized = {};
        
        for (const [targetField, sourceField] of Object.entries(mapping)) {
          if (sourceField) {
            normalized[targetField] = row[sourceField] || '';
          }
        }
        
        // Ensure required fields exist
        normalized['status'] = normalized['status'] || '';
        
        return normalized;
      });
    }

    // Format QC users for display
    function formatQCUsers(firstQC, lastQC) {
      if (!firstQC && !lastQC) return "";

      firstQC = (firstQC || "").trim();
      lastQC = (lastQC || "").trim();

      if (!firstQC || firstQC.toLowerCase() === "n/a") {
        return lastQC || "";
      }

      if (!lastQC || lastQC.toLowerCase() === "n/a") {
        return firstQC || "";
      }

      if (firstQC === lastQC) {
        return firstQC;
      }

      const users = [firstQC, lastQC];
      const uniqueUsers = Array.from(new Set(users)).join(", ");
      return uniqueUsers;
    }

    function loadFilteredData() {
      const loginID = document.getElementById('loginID').value.trim().toLowerCase();
      if (!loginID) {
        showStatus('Please select a Login ID', true);
        return;
      }

      showLoading(true);
      
      const date = document.getElementById('dateFilter').value.trim();
      const enterprise = document.getElementById('enterpriseFilter').value.trim().toLowerCase();
      const qcUser = document.getElementById('qcUserFilter').value.trim().toLowerCase();
      const editingUser = document.getElementById('editingUserFilter').value.trim().toLowerCase();
      const issue = document.getElementById('issueFilter').value.trim().toLowerCase();
      const sourceType = getDataSource();

      const filteredRaw = rawData.filter(row => {
        const rowDate = (row["date"] || '').trim();
        const rowEnterprise = (row["enterprise"] || '').trim().toLowerCase();
        const rowUser = (row["user"] || '').trim().toLowerCase();
        const rowEditingUser = (row["last_editor_user"] || '').trim().toLowerCase();
        const rowIssues = (row["issue"] || '').split(',').map(i => i.trim().toLowerCase());
        const status = (row["status"] || '').trim().toLowerCase();
        const latestImageAction = (row["latest_image_action"] || '').trim().toLowerCase();

        // Common filters for all data sources
        let shouldInclude = (
          (status === '' || status === 'null' || status === null) &&
          (!date || rowDate === date) &&
          (!enterprise || rowEnterprise === enterprise) &&
          (!qcUser || rowUser === qcUser)
        );

        // Additional filters for Re-Edit and QC-Tool
        if (sourceType === 'edited' || sourceType === 'qc_tool') {
          shouldInclude = shouldInclude && 
            (!editingUser || rowEditingUser === editingUser) &&
            (!issue || rowIssues.includes(issue));
        }

        // Additional filters based on data source
        if (sourceType === 'qc_tool') {
          shouldInclude = shouldInclude && (latestImageAction === 'qc_editingtool');
        } else if (sourceType === 'edited') {
          shouldInclude = shouldInclude && (latestImageAction !== 'qc_editingtool');
        }

        return shouldInclude;
      });

      const map = new Map();
      for (const row of filteredRaw) {
        const imageId = row["t1.image_id"];
        if (!imageId) continue;

        if (!map.has(imageId)) {
          map.set(imageId, {
            ...row,
            users: new Set([row["user"]]),
            first_qc_users: new Set([row["first_qc_user"]]),
            last_qc_users: new Set([row["last_qc_user"]]),
            issues: new Set(row["issue"].split(',').map(i => i.trim()).filter(i => i))
          });
        } else {
          const existing = map.get(imageId);
          existing.users.add(row["user"]);
          existing.first_qc_users.add(row["first_qc_user"]);
          existing.last_qc_users.add(row["last_qc_user"]);
          row["issue"].split(',').map(i => i.trim()).filter(i => i).forEach(i => existing.issues.add(i));
        }
      }

      groupedData = Array.from(map.values()).map(item => ({
        ...item,
        user: Array.from(item.users).filter(Boolean).join(", "),
        first_qc_user: Array.from(item.first_qc_users).filter(Boolean).join(", "),
        last_qc_user: Array.from(item.last_qc_users).filter(Boolean).join(", "),
        issue: Array.from(item.issues).filter(Boolean).join(", ")
      }));

      // Shuffle the groupedData array for random display
      for (let i = groupedData.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [groupedData[i], groupedData[j]] = [groupedData[j], groupedData[i]];
      }

      showLoading(false);

      if (groupedData.length > 0) {
        currentIndex = 0;
        showReview();
        loginSection.style.display = "none";
        reviewSection.style.display = "block";
        showStatus(`Loaded ${groupedData.length} records to review`);
      } else {
        showStatus('No matching records found.', true);
      }
    }

    function showReview() {
      const row = groupedData[currentIndex];
      const sourceType = getDataSource();
      
      // Update progress indicator
      document.getElementById('currentIndexDisplay').textContent = currentIndex + 1;
      document.getElementById('totalCountDisplay').textContent = groupedData.length;

      // Show/hide fields based on data source
      document.getElementById('qcUsersContainer').style.display = (sourceType === 'edited' || sourceType === 'qc_tool') ? 'block' : 'none';
      document.getElementById('userContainer').style.display = (sourceType === 'qc') ? 'block' : 'none';
      document.getElementById('editingUserContainer').style.display = (sourceType === 'edited' || sourceType === 'qc_tool') ? 'block' : 'none';
      document.getElementById('issueContainer').style.display = (sourceType === 'edited' || sourceType === 'qc_tool') ? 'block' : 'none';

      // Handle "N/A" values and empty fields
      const setValue = (elementId, value) => {
        const element = document.getElementById(elementId);
        element.textContent = value && value.trim() && value.trim().toLowerCase() !== "n/a" ? value.trim() : "-";
        element.parentElement.style.display = element.textContent !== "-" ? "block" : "none";
      };
      
      setValue('enterprise', row["enterprise"]);
      setValue('sku', row["t1.sku_id"]);
      setValue('imageID', row["t1.image_id"]);
      setValue('issue', row["issue"]);
      setValue('editingUser', row["last_editor_user"]);

      // Use formatQCUsers for proper display
      const firstQC = row["first_qc_user"] || "";
      const lastQC = row["last_qc_user"] || "";
      const qcUsersDisplay = formatQCUsers(firstQC, lastQC);
      setValue('qcUsers', qcUsersDisplay);
      setValue('user', row["user"]);

      // Image loading with placeholders
      loadImageWithPlaceholder('left', row["left_path"]);
      loadImageWithPlaceholder('middle', row["middle_path"]);
      loadImageWithPlaceholder('right', row["right_path"]);
      
      document.getElementById('qcComment').value = "";
    }

    // Optimized image loading with caching
    function loadImageWithPlaceholder(id, path) {
      const imgElement = document.getElementById(id);
      const placeholder = document.getElementById(`${id}Placeholder`);
      
      if (!path) {
        placeholder.textContent = 'Image Not Available';
        imgElement.style.display = 'none';
        return;
      }
      
      // Show placeholder and hide image initially
      placeholder.style.display = 'flex';
      imgElement.style.display = 'none';
      
      // Check if image is already cached
      if (imageCache.has(path)) {
        const cachedImg = imageCache.get(path);
        if (cachedImg.complete) {
          showImage(imgElement, placeholder, cachedImg.src);
          return;
        }
      }
      
      // Load the image
      const img = new Image();
      img.onload = () => {
        imageCache.set(path, img);
        showImage(imgElement, placeholder, img.src);
      };
      img.onerror = () => {
        placeholder.textContent = 'Image Not Available';
      };
      img.src = path;
    }

    function showImage(imgElement, placeholder, src) {
      imgElement.src = src;
      imgElement.style.display = 'block';
      placeholder.style.display = 'none';
    }

    function submitAndNext() {
      const row = groupedData[currentIndex];
      const loginUser = document.getElementById('loginID').value || "";
      let comment = document.getElementById('qcComment').value.trim();
      if (!comment) comment = "Done";

      const sourceType = getDataSource();
      
      // Prepare form data based on source type
      let qcUserField = "";
      let editingUserField = "";
      
      if (sourceType === 'qc') {
        qcUserField = row["user"] || "";
      } else {
        const firstQC = row["first_qc_user"] || "";
        const lastQC = row["last_qc_user"] || "";
        qcUserField = formatQCUsers(firstQC, lastQC);
        editingUserField = row["last_editor_user"] || "";
      }

      // Simulate form submission (would be real in production)
      setTimeout(() => {
        if (currentIndex < groupedData.length - 1) {
          currentIndex++;
          showReview();
        } else {
          showStatus('All entries reviewed. Returning to login screen.');
          setTimeout(exitToLogin, 2000);
        }
      }, 300);
    }

    function prevEntry() {
      if (currentIndex > 0) {
        currentIndex--;
        showReview();
      }
    }

    function exitToLogin() {
      reviewSection.style.display = "none";
      meetReviewSection.style.display = "none";
      loginSection.style.display = "block";
      showStatus('Returned to login screen', false, true);
    }

    function loadMeetReviewData() {
      showLoading(true);
      showStatus('Loading meet review data...');
      
      // Simulate data loading (would be real in production)
      setTimeout(() => {
        showLoading(false);
        showStatus('Meet review data loaded successfully!');
        
        // Show mock data for demonstration
        loginSection.style.display = "none";
        meetReviewSection.style.display = "block";
        showMeetReview();
      }, 800);
    }

    function filterMeetReviewData() {
      // Simulate filtering
      setTimeout(() => {
        if (filteredMeetData.length > 0) {
          meetReviewCurrentIndex = 0;
          showMeetReview();
          showStatus(`Showing ${filteredMeetData.length} meet review records`);
        } else {
          showStatus('No matching records found for meet review.', true);
        }
      }, 300);
    }

    function showMeetReview() {
      // Mock data for demonstration
      document.getElementById("meetDate").textContent = "2023-10-15";
      document.getElementById("meetEnterprise").textContent = "Fashion Retail Inc.";
      document.getElementById("meetQcUser").textContent = "Raj Tripathi";
      document.getElementById("meetEditingUser").textContent = "Nand Kishor";
      document.getElementById("meetSku").textContent = "SKU-789012";
      document.getElementById("meetImageID").textContent = "IMG-456789";
      document.getElementById("meetIssue").textContent = "Background inconsistency";
      document.getElementById("meetComment").textContent = "Please check the background consistency in the final image";
      
      document.getElementById("meetCurrentIndexDisplay").textContent = meetReviewCurrentIndex + 1;
      document.getElementById("meetTotalCountDisplay").textContent = filteredMeetData.length || 5;
      
      // Simulate image loading with placeholders
      loadMeetImageWithPlaceholder('meetLeft', 'https://via.placeholder.com/600x400/cccccc/999999?text=Input+Image');
      loadMeetImageWithPlaceholder('meetMiddle', 'https://via.placeholder.com/600x400/cccccc/999999?text=AI+Image');
      loadMeetImageWithPlaceholder('meetRight', 'https://via.placeholder.com/600x400/cccccc/999999?text=Final+Image');
    }

    function loadMeetImageWithPlaceholder(id, path) {
      const imgElement = document.getElementById(id);
      const placeholder = document.getElementById(`${id}Placeholder`);
      
      if (!path) {
        placeholder.textContent = 'Image Not Available';
        imgElement.style.display = 'none';
        return;
      }
      
      // Show placeholder and hide image initially
      placeholder.style.display = 'flex';
      imgElement.style.display = 'none';
      
      // Check if image is already cached
      if (meetImageCache.has(path)) {
        const cachedImg = meetImageCache.get(path);
        if (cachedImg.complete) {
          showMeetImage(imgElement, placeholder, cachedImg.src);
          return;
        }
      }
      
      // Load the image
      const img = new Image();
      img.onload = () => {
        meetImageCache.set(path, img);
        showMeetImage(imgElement, placeholder, img.src);
      };
      img.onerror = () => {
        placeholder.textContent = 'Image Not Available';
      };
      img.src = path;
    }

    function showMeetImage(imgElement, placeholder, src) {
      imgElement.src = src;
      imgElement.style.display = 'block';
      placeholder.style.display = 'none';
    }

    function prevMeetEntry() {
      if (meetReviewCurrentIndex > 0) {
        meetReviewCurrentIndex--;
        showMeetReview();
      }
    }

    function nextMeetEntry() {
      if (meetReviewCurrentIndex < (filteredMeetData.length || 4)) {
        meetReviewCurrentIndex++;
        showMeetReview();
      }
    }

    // Utility function to populate dropdowns
    function fillSelect(selectId, options) {
      const select = document.getElementById(selectId);
      // Clear existing options except the first one
      while (select.options.length > 1) {
        select.remove(1);
      }
      
      // Sort options
      const sortedOptions = [...options].sort();
      
      sortedOptions.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt;
        option.textContent = opt;
        select.appendChild(option);
      });
    }

    // Load data with normalization
    function loadData(url, sourceType) {
      showLoading(true);
      
      // Simulate data loading (would be real in production)
      setTimeout(() => {
        showLoading(false);
        showStatus(`${sourceType === 'qc' ? 'QC-Pass' : 'Re-Edit'} data loaded successfully!`);
        
        // Mock data for demonstration
        const mockData = [
          {
            "enterprise_name": "Retail Corp",
            "ai.image_id": "IMG-123456",
            "sku_id": "SKU-789012",
            "input_image_hres_url": "https://via.placeholder.com/600x400/cccccc/999999?text=Input+Image",
            "output_image_hres_url": "https://via.placeholder.com/600x400/cccccc/999999?text=AI+Image",
            "manual_image_hres_url": "https://via.placeholder.com/600x400/cccccc/999999?text=Final+Image",
            "qc_user_name": "Raj Tripathi",
            "first_qc_user": "Nand Kishor",
            "last_qc_user": "Raj Tripathi",
            "last_editor_user": "Nitin Kumar",
            "rejected_comments": "Color mismatch, Background issue",
            "qc_completed_time": "2023-10-15",
            "status": "",
            "latest_image_action": "qc_editingtool"
          },
          {
            "enterprise_name": "Fashion Retail Inc.",
            "ai.image_id": "IMG-654321",
            "sku_id": "SKU-098765",
            "input_image_hres_url": "https://via.placeholder.com/600x400/cccccc/999999?text=Input+Image",
            "output_image_hres_url": "https://via.placeholder.com/600x400/cccccc/999999?text=AI+Image",
            "manual_image_hres_url": "https://via.placeholder.com/600x400/cccccc/999999?text=Final+Image",
            "qc_user_name": "Saurabh Pandey",
            "first_qc_user": "Praveen Agarwal",
            "last_qc_user": "Saurabh Pandey",
            "last_editor_user": "Rohit Chahuhan",
            "rejected_comments": "Shadow inconsistency, Cropping issue",
            "qc_completed_time": "2023-10-16",
            "status": "",
            "latest_image_action": "manual_edit"
          }
        ];
        
        rawData = normalizeData(mockData, sourceType);
        
        // Populate filters with mock data
        const dates = new Set(["2023-10-15", "2023-10-16"]), 
              enterprises = new Set(["Retail Corp", "Fashion Retail Inc."]), 
              users = new Set(["Raj Tripathi", "Saurabh Pandey"]),
              editingUsers = new Set(["Nitin Kumar", "Rohit Chahuhan"]),
              issues = new Set(["Color mismatch", "Background issue", "Shadow inconsistency", "Cropping issue"]);
            
        fillSelect("dateFilter", [...dates]);
        fillSelect("enterpriseFilter", [...enterprises]);
        fillSelect("qcUserFilter", [...users]);
        fillSelect("editingUserFilter", [...editingUsers]);
        fillSelect("issueFilter", [...issues]);
      }, 1000);
    }

    // Event listeners
    meetReviewButton.addEventListener('click', loadMeetReviewData);
    startButton.addEventListener('click', loadFilteredData);

    // Add event listeners for meet review filters
    document.getElementById("meetDateFilter").addEventListener("change", filterMeetReviewData);
    document.getElementById("meetEnterpriseFilter").addEventListener("change", filterMeetReviewData);
    document.getElementById("meetQcUserFilter").addEventListener("change", filterMeetReviewData);
    document.getElementById("meetEditingUserFilter").addEventListener("change", filterMeetReviewData);
    
    // Data source change listeners
    document.querySelectorAll('input[name="dataSource"]').forEach(radio => {
      radio.addEventListener('change', function() {
        toggleAdditionalFilters();
        loadData(getDataSourceUrl(), getDataSource());
      });
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(event) {
      if (reviewSection.style.display !== "none") {
        if (event.key === "Enter") {
          event.preventDefault();
          submitAndNext();
        } else if (event.key === "p" || event.key === "P") {
          event.preventDefault();
          prevEntry();
        } else if (event.key === "Escape") {
          event.preventDefault();
          exitToLogin();
        }
      }
    });

    // Initialize on load
    window.addEventListener('load', () => {
      // Load initial data for QC-Pass
      loadData(QC_PASS_URL, 'qc');
    });
  </script>
</body>
</html>
