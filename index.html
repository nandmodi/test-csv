<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QC Review Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --primary-light: #dbeafe;
      --secondary: #8b5cf6;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --dark: #1e293b;
      --light: #f8fafc;
      --gray: #94a3b8;
      --border: #e2e8f0;
      --card-bg: #ffffff;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --radius: 12px;
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      color: var(--dark);
      line-height: 1.6;
      min-height: 100vh;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .dashboard-container {
      max-width: 1200px;
      width: 100%;
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    /* Header styles */
    .dashboard-header {
      background: linear-gradient(to right, var(--primary), var(--secondary));
      color: white;
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
    }

    .logo-container {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo {
      width: 50px;
      height: 50px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: var(--primary);
    }

    .header-text h1 {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .header-text p {
      opacity: 0.9;
      font-size: 0.9rem;
    }

    .header-actions {
      display: flex;
      gap: 15px;
    }

    .meet-review-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid white;
      color: white;
      padding: 10px 20px;
      border-radius: 50px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: var(--transition);
    }

    .meet-review-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    /* Content area */
    .content-area {
      padding: 30px;
    }

    .section-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--border);
    }

    /* Login section */
    .login-section {
      background: var(--light);
      border-radius: var(--radius);
      padding: 30px;
      box-shadow: var(--shadow);
      margin-bottom: 30px;
    }

    .source-toggle {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }

    .source-toggle label {
      background: var(--primary-light);
      padding: 12px 20px;
      border-radius: var(--radius);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      transition: var(--transition);
      border: 2px solid transparent;
    }

    .source-toggle input:checked + label {
      background: var(--primary);
      color: white;
      border-color: var(--primary-dark);
    }

    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
    }

    .filter-group label {
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-group select {
      padding: 12px 15px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: white;
      font-size: 15px;
      transition: var(--transition);
    }

    .filter-group select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-light);
    }

    .dashboard-actions {
      display: flex;
      gap: 15px;
      margin-top: 20px;
    }

    .btn {
      padding: 12px 25px;
      border-radius: var(--radius);
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: var(--transition);
      border: none;
      font-size: 16px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: var(--secondary);
      color: white;
    }

    .btn-secondary:hover {
      background: #7c3aed;
      transform: translateY(-2px);
    }

    /* Review section */
    .review-section, .meet-review-section {
      display: none;
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .review-header {
      background: var(--primary-light);
      padding: 20px 30px;
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }

    .info-card {
      background: white;
      border-radius: var(--radius);
      padding: 15px;
      min-width: 200px;
      flex: 1;
      box-shadow: var(--shadow);
    }

    .info-card h3 {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--gray);
      margin-bottom: 8px;
    }

    .info-card p {
      font-weight: 600;
      font-size: 1.1rem;
      color: var(--dark);
    }

    .progress-indicator {
      background: white;
      padding: 15px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
    }

    .image-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      padding: 30px;
    }

    .image-container {
      background: var(--light);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .image-container img {
      width: 100%;
      height: 250px;
      object-fit: contain;
      display: block;
      background: #f8f9fa;
    }

    .image-label {
      text-align: center;
      padding: 12px;
      font-weight: 600;
      background: white;
      border-top: 1px solid var(--border);
    }

    .comment-section {
      padding: 0 30px 30px;
    }

    .comment-section textarea {
      width: 100%;
      padding: 15px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      min-height: 120px;
      font-size: 16px;
      resize: vertical;
      transition: var(--transition);
    }

    .comment-section textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-light);
    }

    .nav-buttons {
      display: flex;
      gap: 15px;
      padding: 20px 30px;
      background: var(--light);
      border-top: 1px solid var(--border);
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
    }

    .btn-outline:hover {
      background: var(--primary-light);
    }

    /* Loading and status */
    .loading-container {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px;
      flex-direction: column;
      gap: 20px;
      display: none;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid var(--primary-light);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .status-message {
      padding: 15px 20px;
      border-radius: var(--radius);
      margin-top: 20px;
      display: none;
    }

    .status-message.error {
      background: #fee2e2;
      color: #b91c1c;
      border-left: 4px solid #ef4444;
    }

    .status-message.success {
      background: #dcfce7;
      color: #15803d;
      border-left: 4px solid #10b981;
    }

    .status-message.warning {
      background: #fef3c7;
      color: #b45309;
      border-left: 4px solid #f59e0b;
    }

    /* Footer */
    .dashboard-footer {
      text-align: center;
      padding: 20px;
      color: var(--gray);
      font-size: 0.9rem;
      border-top: 1px solid var(--border);
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .dashboard-header {
        flex-direction: column;
        text-align: center;
        gap: 20px;
      }
      
      .header-actions {
        width: 100%;
        justify-content: center;
      }
      
      .filters-grid {
        grid-template-columns: 1fr;
      }
      
      .image-grid {
        grid-template-columns: 1fr;
      }
      
      .nav-buttons {
        flex-direction: column;
      }
      
      .nav-buttons button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <div class="dashboard-header">
      <div class="logo-container">
        <div class="logo">
          <i class="fas fa-cube"></i>
        </div>
        <div class="header-text">
          <h1>Quality Control Dashboard</h1>
          <p>Review and manage quality control processes</p>
        </div>
      </div>
      <div class="header-actions">
        <div class="meet-review-btn" id="meetReviewButton">
          <i class="fas fa-users"></i>
          Meet Review
        </div>
      </div>
    </div>

    <div class="content-area">
      <!-- Login Section -->
      <div class="login-section" id="loginSection">
        <h2 class="section-title">QC Review Login</h2>
        
        <div class="source-toggle">
          <input type="radio" name="dataSource" value="qc" id="qcSource" checked>
          <label for="qcSource">
            <i class="fas fa-check-circle"></i>
            QC-Pass
          </label>
          
          <input type="radio" name="dataSource" value="edited" id="editedSource">
          <label for="editedSource">
            <i class="fas fa-redo"></i>
            Re-Edit
          </label>
          
          <input type="radio" name="dataSource" value="qc_tool" id="qcToolSource">
          <label for="qcToolSource">
            <i class="fas fa-tools"></i>
            QC-Tool
          </label>
        </div>
        
        <div class="filters-grid">
          <div class="filter-group">
            <label for="loginID"><i class="fas fa-user"></i> Login ID</label>
            <select id="loginID">
              <option value="">Select Login ID</option>
              <option>Nand Kishor</option>
              <option>Ranbir Manoranjan</option>
              <option>Nitin kumar</option>
              <option>Praveen Agarwal</option>
              <option>Raj Tripatrhi</option>
              <option>Rohit Chahuhan</option>
              <option>Saurabh Pandey</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label for="dateFilter"><i class="fas fa-calendar"></i> Date</label>
            <select id="dateFilter">
              <option value="">ALL</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label for="enterpriseFilter"><i class="fas fa-building"></i> Enterprise</label>
            <select id="enterpriseFilter">
              <option value="">ALL</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label for="qcUserFilter"><i class="fas fa-user-check"></i> QC User</label>
            <select id="qcUserFilter">
              <option value="">ALL</option>
            </select>
          </div>
          
          <div class="filter-group" id="editingUserFilterContainer" style="display: none;">
            <label for="editingUserFilter"><i class="fas fa-user-edit"></i> Editing User</label>
            <select id="editingUserFilter">
              <option value="">ALL</option>
            </select>
          </div>
          
          <div class="filter-group" id="issueFilterContainer" style="display: none;">
            <label for="issueFilter"><i class="fas fa-exclamation-circle"></i> Issue</label>
            <select id="issueFilter">
              <option value="">ALL</option>
            </select>
          </div>
        </div>
        
        <div class="dashboard-actions">
          <button class="btn btn-primary" id="startButton">
            <i class="fas fa-play"></i>
            Start QC
          </button>
        </div>
        
        <div class="loading-container" id="loadingIndicator">
          <div class="loading-spinner"></div>
          <p>Loading data, please wait...</p>
        </div>
        
        <div class="status-message" id="statusMessage"></div>
      </div>
      
      <!-- Review Section -->
      <div class="review-section" id="reviewSection">
        <h2 class="section-title">Review Details</h2>
        
        <div class="review-header">
          <div class="info-card">
            <h3>Enterprise</h3>
            <p id="enterprise">-</p>
          </div>
          
          <div class="info-card" id="qcUsersContainer">
            <h3>QC Users</h3>
            <p id="qcUsers">-</p>
          </div>
          
          <div class="info-card" id="userContainer">
            <h3>User</h3>
            <p id="user">-</p>
          </div>
          
          <div class="info-card" id="editingUserContainer">
            <h3>Editing User</h3>
            <p id="editingUser">-</p>
          </div>
          
          <div class="info-card" id="issueContainer">
            <h3>Issue</h3>
            <p id="issue">-</p>
          </div>
          
          <div class="info-card">
            <h3>SKU ID</h3>
            <p id="sku">-</p>
          </div>
          
          <div class="info-card">
            <h3>Image ID</h3>
            <p id="imageID">-</p>
          </div>
        </div>
        
        <div class="progress-indicator">
          <div>Reviewing <span id="currentIndexDisplay">1</span> of <span id="totalCountDisplay">0</span></div>
        </div>
        
        <div class="image-grid">
          <div class="image-container">
            <img id="left" alt="Input Image">
            <div class="image-label">Input Image</div>
          </div>
          
          <div class="image-container">
            <img id="middle" alt="AI Image">
            <div class="image-label">AI Image</div>
          </div>
          
          <div class="image-container">
            <img id="right" alt="Final Image">
            <div class="image-label">Final Image</div>
          </div>
        </div>
        
        <div class="comment-section">
          <label for="qcComment">QC Comment</label>
          <textarea id="qcComment" placeholder="Enter your detailed comments here..."></textarea>
        </div>
        
        <div class="nav-buttons">
          <button class="btn btn-outline" onclick="prevEntry()">
            <i class="fas fa-arrow-left"></i>
            Previous
          </button>
          <button class="btn btn-primary" onclick="submitAndNext()">
            Next
            <i class="fas fa-arrow-right"></i>
          </button>
          <button class="btn btn-secondary" onclick="exitToLogin()">
            <i class="fas fa-sign-out-alt"></i>
            Exit to Login
          </button>
        </div>
      </div>
      
      <!-- Meet Review Section -->
      <div class="meet-review-section" id="meetReviewSection">
        <h2 class="section-title">Meet Review Details</h2>
        
        <div class="filters-grid">
          <div class="filter-group">
            <label for="meetDateFilter"><i class="fas fa-calendar"></i> Date</label>
            <select id="meetDateFilter">
              <option value="">ALL</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label for="meetEnterpriseFilter"><i class="fas fa-building"></i> Enterprise</label>
            <select id="meetEnterpriseFilter">
              <option value="">ALL</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label for="meetQcUserFilter"><i class="fas fa-user-check"></i> QC User</label>
            <select id="meetQcUserFilter">
              <option value="">ALL</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label for="meetEditingUserFilter"><i class="fas fa-user-edit"></i> Editing User</label>
            <select id="meetEditingUserFilter">
              <option value="">ALL</option>
            </select>
          </div>
        </div>
        
        <div class="review-header">
          <div class="info-card">
            <h3>Date</h3>
            <p id="meetDate">-</p>
          </div>
          
          <div class="info-card">
            <h3>Enterprise</h3>
            <p id="meetEnterprise">-</p>
          </div>
          
          <div class="info-card">
            <h3>QC User</h3>
            <p id="meetQcUser">-</p>
          </div>
          
          <div class="info-card">
            <h3>Editing User</h3>
            <p id="meetEditingUser">-</p>
          </div>
          
          <div class="info-card">
            <h3>SKU ID</h3>
            <p id="meetSku">-</p>
          </div>
          
          <div class="info-card">
            <h3>Image ID</h3>
            <p id="meetImageID">-</p>
          </div>
        </div>
        
        <div class="review-header">
          <div class="info-card">
            <h3>Issue</h3>
            <p id="meetIssue">-</p>
          </div>
          
          <div class="info-card">
            <h3>Comment</h3>
            <p id="meetComment">-</p>
          </div>
        </div>
        
        <div class="progress-indicator">
          <div>Reviewing <span id="meetCurrentIndexDisplay">1</span> of <span id="meetTotalCountDisplay">0</span></div>
        </div>
        
        <div class="image-grid">
          <div class="image-container">
            <img id="meetLeft" alt="Input Image">
            <div class="image-label">Input Image</div>
          </div>
          
          <div class="image-container">
            <img id="meetMiddle" alt="AI Image">
            <div class="image-label">AI Image</div>
          </div>
          
          <div class="image-container">
            <img id="meetRight" alt="Final Image">
            <div class="image-label">Final Image</div>
          </div>
        </div>
        
        <div class="nav-buttons">
          <button class="btn btn-outline" onclick="prevMeetEntry()">
            <i class="fas fa-arrow-left"></i>
            Previous
          </button>
          <button class="btn btn-primary" onclick="nextMeetEntry()">
            Next
            <i class="fas fa-arrow-right"></i>
          </button>
          <button class="btn btn-secondary" onclick="exitToLogin()">
            <i class="fas fa-sign-out-alt"></i>
            Exit to Login
          </button>
        </div>
      </div>
    </div>
    
    <div class="dashboard-footer">
      <p>QC Review Dashboard v2.0 • © 2023 Spyne AI • All rights reserved</p>
    </div>
  </div>

  <script>
    // Google Sheets URLs
    const QC_PASS_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSWW7muoNyeY_1VOLhybuT7ChNHtkhAscxDikyiCPQChIWqi1m3KXsd9e0_i_UFE7bDrW_7kfH-vIhL/pub?gid=1717039169&single=true&output=csv";
    const RE_EDIT_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSWW7muoNyeY_1VOLhybuT7ChNHtkhAscxDikyiCPQChIWqi1m3KXsd9e0_i_UFE7bDrW_7kfH-vIhL/pub?gid=320301246&single=true&output=csv";
    const MEET_REVIEW_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSWW7muoNyeY_1VOLhybuT7ChNHtkhAscxDikyiCPQChIWqi1m3KXsd9e0_i_UFE7bDrW_7kfH-vIhL/pub?gid=1880564018&single=true&output=csv";

    // Field mapping configuration
    const FIELD_MAPPING = {
      qc: {
        'enterprise': 'enterprise_name',
        't1.image_id': 'ai.image_id',
        't1.sku_id': 'sku_id',
        'left_path': 'input_image_hres_url',
        'middle_path': 'output_image_hres_url',
        'right_path': 'manual_image_hres_url',
        'user': 'qc_user_name',
        'first_qc_user': '',
        'last_qc_user': '',
        'last_editor_user': '',
        'issue': '',
        'date': 'qc_completed_time',
        'status': 'status'
      },
      edited: {
        'enterprise': 'enterprise_name',
        't1.image_id': 'ai.image_id',
        't1.sku_id': 'sku_id',
        'left_path': 'input_image_hres_url',
        'middle_path': 'ai_output',
        'right_path': 'final_output',
        'user': 'last_qc_user',
        'first_qc_user': 'first_qc_user',
        'last_qc_user': 'last_qc_user',
        'last_editor_user': 'last_editor_user',
        'issue': 'rejected_comments',
        'date': 'qc_completed_time',
        'status': 'status',
        'latest_image_action': 'latest_image_action'
      },
      qc_tool: {
        'enterprise': 'enterprise_name',
        't1.image_id': 'ai.image_id',
        't1.sku_id': 'sku_id',
        'left_path': 'input_image_hres_url',
        'middle_path': 'ai_output',
        'right_path': 'final_output',
        'user': 'last_qc_user',
        'first_qc_user': 'first_qc_user',
        'last_qc_user': 'last_qc_user',
        'last_editor_user': 'last_editor_user',
        'issue': 'rejected_comments',
        'date': 'qc_completed_time',
        'status': 'status',
        'latest_image_action': 'latest_image_action'
      }
    };

    let rawData = [];
    let groupedData = [];
    let currentIndex = 0;

    let meetReviewData = [];
    let filteredMeetData = [];
    let meetReviewCurrentIndex = 0;

    // DOM elements
    const loginSection = document.getElementById('loginSection');
    const reviewSection = document.getElementById('reviewSection');
    const meetReviewSection = document.getElementById('meetReviewSection');
    const statusMessage = document.getElementById('statusMessage');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const meetReviewButton = document.getElementById('meetReviewButton');
    const startButton = document.getElementById('startButton');

    function showLoading(show) {
      loadingIndicator.style.display = show ? 'flex' : 'none';
    }

    function showStatus(message, isError = false, isWarning = false) {
      statusMessage.textContent = message;
      statusMessage.className = 'status-message ' + 
        (isError ? 'error' : isWarning ? 'warning' : 'success');
      statusMessage.style.display = 'block';
      
      if (!isError && !isWarning) {
        setTimeout(() => {
          statusMessage.style.display = 'none';
        }, 5000);
      }
    }

    function getDataSource() {
      const selected = document.querySelector('input[name="dataSource"]:checked');
      return selected ? selected.value : 'qc';
    }

    function getDataSourceUrl() {
      return getDataSource() === 'qc' ? QC_PASS_URL : RE_EDIT_URL;
    }

    function toggleAdditionalFilters() {
      const sourceType = getDataSource();
      const editingUserContainer = document.getElementById('editingUserFilterContainer');
      const issueContainer = document.getElementById('issueFilterContainer');
      
      if (sourceType === 'edited' || sourceType === 'qc_tool') {
        editingUserContainer.style.display = 'block';
        issueContainer.style.display = 'block';
      } else {
        editingUserContainer.style.display = 'none';
        issueContainer.style.display = 'none';
      }
    }

    function loadFilteredData() {
      const loginID = document.getElementById('loginID').value.trim().toLowerCase();
      if (!loginID) {
        showStatus('Please select a Login ID', true);
        return;
      }

      showLoading(true);
      
      const date = document.getElementById('dateFilter').value.trim();
      const enterprise = document.getElementById('enterpriseFilter').value.trim().toLowerCase();
      const qcUser = document.getElementById('qcUserFilter').value.trim().toLowerCase();
      const editingUser = document.getElementById('editingUserFilter').value.trim().toLowerCase();
      const issue = document.getElementById('issueFilter').value.trim().toLowerCase();
      const sourceType = getDataSource();

      const filteredRaw = rawData.filter(row => {
        const rowDate = (row["date"] || '').trim();
        const rowEnterprise = (row["enterprise"] || '').trim().toLowerCase();
        const rowUser = (row["user"] || '').trim().toLowerCase();
        const rowEditingUser = (row["last_editor_user"] || '').trim().toLowerCase();
        const rowIssues = (row["issue"] || '').split(',').map(i => i.trim().toLowerCase());
        const status = (row["status"] || '').trim().toLowerCase();
        const latestImageAction = (row["latest_image_action"] || '').trim().toLowerCase();

        // Common filters for all data sources
        let shouldInclude = (
          (status === '' || status === 'null' || status === null) && // Only include blank/null status
          (!date || rowDate === date) &&
          (!enterprise || rowEnterprise === enterprise) &&
          (!qcUser || rowUser === qcUser)
        );

        // Additional filters for Re-Edit and QC-Tool
        if (sourceType === 'edited' || sourceType === 'qc_tool') {
          shouldInclude = shouldInclude && 
            (!editingUser || rowEditingUser === editingUser) &&
            (!issue || rowIssues.includes(issue));
        }

        // Additional filters based on data source
        if (sourceType === 'qc_tool') {
          shouldInclude = shouldInclude && (latestImageAction === 'qc_editingtool');
        } else if (sourceType === 'edited') {
          shouldInclude = shouldInclude && (latestImageAction !== 'qc_editingtool');
        }

        return shouldInclude;
      });

      const map = new Map();
      for (const row of filteredRaw) {
        const imageId = row["t1.image_id"];
        if (!imageId) continue;

        if (!map.has(imageId)) {
          map.set(imageId, {
            ...row,
            users: new Set([row["user"]]),
            first_qc_users: new Set([row["first_qc_user"]]),
            last_qc_users: new Set([row["last_qc_user"]]),
            issues: new Set(row["issue"].split(',').map(i => i.trim()).filter(i => i))
          });
        } else {
          const existing = map.get(imageId);
          existing.users.add(row["user"]);
          existing.first_qc_users.add(row["first_qc_user"]);
          existing.last_qc_users.add(row["last_qc_user"]);
          row["issue"].split(',').map(i => i.trim()).filter(i => i).forEach(i => existing.issues.add(i));
        }
      }

      groupedData = Array.from(map.values()).map(item => ({
        ...item,
        user: Array.from(item.users).filter(Boolean).join(", "),
        first_qc_user: Array.from(item.first_qc_users).filter(Boolean).join(", "),
        last_qc_user: Array.from(item.last_qc_users).filter(Boolean).join(", "),
        issue: Array.from(item.issues).filter(Boolean).join(", ")
      }));

      // Shuffle the groupedData array for random display
      for (let i = groupedData.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [groupedData[i], groupedData[j]] = [groupedData[j], groupedData[i]];
      }

      showLoading(false);

      if (groupedData.length > 0) {
        currentIndex = 0;
        showReview();
        loginSection.style.display = "none";
        reviewSection.style.display = "block";
        showStatus(`Loaded ${groupedData.length} records to review`);
      } else {
        showStatus('No matching records found.', true);
      }
    }

    function showReview() {
      const row = groupedData[currentIndex];
      const sourceType = getDataSource();
      
      // Update progress indicator
      document.getElementById('currentIndexDisplay').textContent = currentIndex + 1;
      document.getElementById('totalCountDisplay').textContent = groupedData.length;

      // Show/hide fields based on data source
      document.getElementById('qcUsersContainer').style.display = (sourceType === 'edited' || sourceType === 'qc_tool') ? 'block' : 'none';
      document.getElementById('userContainer').style.display = (sourceType === 'qc') ? 'block' : 'none';
      document.getElementById('editingUserContainer').style.display = (sourceType === 'edited' || sourceType === 'qc_tool') ? 'block' : 'none';
      document.getElementById('issueContainer').style.display = (sourceType === 'edited' || sourceType === 'qc_tool') ? 'block' : 'none';

      // Set values
      document.getElementById('enterprise').textContent = row["enterprise"] || "-";
      document.getElementById('sku').textContent = row["t1.sku_id"] || "-";
      document.getElementById('imageID').textContent = row["t1.image_id"] || "-";
      document.getElementById('issue').textContent = row["issue"] || "-";
      document.getElementById('editingUser').textContent = row["last_editor_user"] || "-";
      document.getElementById('qcUsers').textContent = row["user"] || "-";
      document.getElementById('user').textContent = row["user"] || "-";

      // Set image sources
      document.getElementById('left').src = row["left_path"] || "https://via.placeholder.com/600x400/cccccc/999999?text=Image+Not+Available";
      document.getElementById('middle').src = row["middle_path"] || "https://via.placeholder.com/600x400/cccccc/999999?text=Image+Not+Available";
      document.getElementById('right').src = row["right_path"] || "https://via.placeholder.com/600x400/cccccc/999999?text=Image+Not+Available";
      
      document.getElementById('qcComment').value = "";
    }

    function submitAndNext() {
      const row = groupedData[currentIndex];
      const loginUser = document.getElementById('loginID').value || "";
      let comment = document.getElementById('qcComment').value.trim();
      if (!comment) comment = "Done";

      const sourceType = getDataSource();
      
      // Prepare form data based on source type
      let qcUserField = "";
      let editingUserField = "";
      
      if (sourceType === 'qc') {
        qcUserField = row["user"] || "";
      } else {
        const firstQC = row["first_qc_user"] || "";
        const lastQC = row["last_qc_user"] || "";
        qcUserField = `${firstQC}, ${lastQC}`;
        editingUserField = row["last_editor_user"] || "";
      }

      const url = new URL("https://docs.google.com/forms/d/e/1FAIpQLSdrjhynjWITfOqHpkgKX8enCmDKg1b3s0Ij05Cux36kPmZEUA/formResponse");
      const params = new URLSearchParams({
        "entry.890284089": row["enterprise"] || "",
        "entry.5932044": qcUserField,
        "entry.1880389842": editingUserField,
        "entry.1139236247": row["t1.sku_id"] || "",
        "entry.661750446": row["t1.image_id"] || "",
        "entry.1317530325": row["issue"] || "",
        "entry.1455673211": row["left_path"] || "",
        "entry.772576827": row["middle_path"] || "",
        "entry.780536997": row["right_path"] || "",
        "entry.865196657": loginUser,
        "entry.778698303": comment
      });

      fetch(`${url}?${params.toString()}`, { method: 'POST', mode: 'no-cors' })
        .then(() => {
          if (currentIndex < groupedData.length - 1) {
            currentIndex++;
            showReview();
          } else {
            showStatus('All entries reviewed. Returning to login screen.');
            setTimeout(exitToLogin, 2000);
          }
        })
        .catch(error => {
          console.error('Submission error:', error);
          showStatus('Error submitting data', true);
        });
    }

    function prevEntry() {
      if (currentIndex > 0) {
        currentIndex--;
        showReview();
      }
    }

    function exitToLogin() {
      reviewSection.style.display = "none";
      meetReviewSection.style.display = "none";
      loginSection.style.display = "block";
      showStatus('Returned to login screen', false, true);
    }

    // Meet Review Functions
    function loadMeetReviewData() {
      showLoading(true);
      showStatus('Loading meet review data...');
      
      // Clear previous meet review data
      meetReviewData = [];
      filteredMeetData = [];
      
      Papa.parse(MEET_REVIEW_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          showLoading(false);
          
          if (results.data && results.data.length > 0) {
            showStatus('Meet review data loaded successfully!');
            
            // Filter out records where Comment is "Done" or similar
            meetReviewData = results.data.filter(row => {
              const comment = (row["Comment"] || "").trim().toLowerCase();
              return !comment.includes("done") && comment !== "";
            });
            
            if (meetReviewData.length === 0) {
              showStatus('No meet review records available (all are done)', true);
              return;
            }
            
            // Populate meet review filters
            const dates = new Set(), 
                  enterprises = new Set(), 
                  qcUsers = new Set(), 
                  editingUsers = new Set();
                  
            meetReviewData.forEach(row => {
              if (row["Timestamp"]) dates.add(row["Timestamp"]);
              if (row["Enterprise"]) enterprises.add(row["Enterprise"]);
              if (row["qc-user"]) qcUsers.add(row["qc-user"]);
              if (row["editing user"]) editingUsers.add(row["editing user"]);
            });
            
            fillSelect("meetDateFilter", [...dates]);
            fillSelect("meetEnterpriseFilter", [...enterprises]);
            fillSelect("meetQcUserFilter", [...qcUsers]);
            fillSelect("meetEditingUserFilter", [...editingUsers]);
            
            // Apply initial filtering
            filterMeetReviewData();
          } else {
            showStatus('No meet review data found in the file.', true);
          }
        },
        error: function(error) {
          showLoading(false);
          console.error("Error loading meet review data:", error);
          showStatus('Error loading meet review data. Please try again. ' + error.message, true);
        }
      });
    }

    function filterMeetReviewData() {
      const date = document.getElementById("meetDateFilter").value.trim();
      const enterprise = document.getElementById("meetEnterpriseFilter").value.trim().toLowerCase();
      const qcUser = document.getElementById("meetQcUserFilter").value.trim().toLowerCase();
      const editingUser = document.getElementById("meetEditingUserFilter").value.trim().toLowerCase();
      
      filteredMeetData = meetReviewData.filter(row => {
        const rowDate = (row["Timestamp"] || "").trim();
        const rowEnterprise = (row["Enterprise"] || "").trim().toLowerCase();
        const rowQcUser = (row["qc-user"] || "").trim().toLowerCase();
        const rowEditingUser = (row["editing user"] || "").trim().toLowerCase();
        
        return (
          (!date || rowDate === date) &&
          (!enterprise || rowEnterprise === enterprise) &&
          (!qcUser || rowQcUser === qcUser) &&
          (!editingUser || rowEditingUser === editingUser)
        );
      });
      
      if (filteredMeetData.length > 0) {
        meetReviewCurrentIndex = 0;
        showMeetReview();
        loginSection.style.display = "none";
        meetReviewSection.style.display = "block";
        document.getElementById("meetTotalCountDisplay").textContent = filteredMeetData.length;
        showStatus(`Showing ${filteredMeetData.length} meet review records`);
      } else {
        showStatus('No matching records found for meet review.', true);
      }
    }

    function showMeetReview() {
      if (filteredMeetData.length === 0) return;
      
      const row = filteredMeetData[meetReviewCurrentIndex];
      
      // Update progress indicator
      document.getElementById("meetCurrentIndexDisplay").textContent = meetReviewCurrentIndex + 1;
      document.getElementById("meetTotalCountDisplay").textContent = filteredMeetData.length;
      
      // Set values
      document.getElementById("meetDate").textContent = row["Timestamp"] || "-";
      document.getElementById("meetEnterprise").textContent = row["Enterprise"] || "-";
      document.getElementById("meetQcUser").textContent = row["qc-user"] || "-";
      document.getElementById("meetEditingUser").textContent = row["editing user"] || "-";
      document.getElementById("meetSku").textContent = row["sku_id"] || "-";
      document.getElementById("meetImageID").textContent = row["image_id"] || "-";
      document.getElementById("meetIssue").textContent = row["Issue"] || "-";
      document.getElementById("meetComment").textContent = row["Comment"] || "-";
      
      // Set image sources
      document.getElementById("meetLeft").src = row["input image"] || "https://via.placeholder.com/600x400/cccccc/999999?text=Image+Not+Available";
      document.getElementById("meetMiddle").src = row["Ai image"] || "https://via.placeholder.com/600x400/cccccc/999999?text=Image+Not+Available";
      document.getElementById("meetRight").src = row["Final Image"] || "https://via.placeholder.com/600x400/cccccc/999999?text=Image+Not+Available";
    }

    function prevMeetEntry() {
      if (meetReviewCurrentIndex > 0) {
        meetReviewCurrentIndex--;
        showMeetReview();
      }
    }

    function nextMeetEntry() {
      if (meetReviewCurrentIndex < filteredMeetData.length - 1) {
        meetReviewCurrentIndex++;
        showMeetReview();
      }
    }

    // Utility function to populate dropdowns
    function fillSelect(selectId, options) {
      const select = document.getElementById(selectId);
      // Clear existing options except the first one
      while (select.options.length > 1) {
        select.remove(1);
      }
      
      // Sort options
      const sortedOptions = [...options].sort();
      
      sortedOptions.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt;
        option.textContent = opt;
        select.appendChild(option);
      });
    }

    // Event listeners
    meetReviewButton.addEventListener('click', loadMeetReviewData);
    startButton.addEventListener('click', loadFilteredData);

    // Add event listeners for meet review filters
    document.getElementById("meetDateFilter").addEventListener("change", filterMeetReviewData);
    document.getElementById("meetEnterpriseFilter").addEventListener("change", filterMeetReviewData);
    document.getElementById("meetQcUserFilter").addEventListener("change", filterMeetReviewData);
    document.getElementById("meetEditingUserFilter").addEventListener("change", filterMeetReviewData);

    // Initialize on load
    window.addEventListener('load', () => {
      // Load initial data for QC-Pass
      showLoading(true);
      
      Papa.parse(QC_PASS_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          showLoading(false);
          if (results.data && results.data.length > 0) {
            rawData = results.data;
            
            // Populate filters
            const dates = new Set(), 
                  enterprises = new Set(), 
                  users = new Set();
            
            rawData.forEach(row => {
              if (row["qc_completed_time"]) dates.add(row["qc_completed_time"]);
              if (row["enterprise_name"]) enterprises.add(row["enterprise_name"]);
              if (row["qc_user_name"]) users.add(row["qc_user_name"]);
            });
            
            fillSelect("dateFilter", [...dates]);
            fillSelect("enterpriseFilter", [...enterprises]);
            fillSelect("qcUserFilter", [...users]);
            
            showStatus('QC-Pass data loaded successfully!');
          } else {
            showStatus('No data found in the QC-Pass source', true);
          }
        },
        error: function(error) {
          showLoading(false);
          showStatus('Error loading QC-Pass data', true);
        }
      });
    });
  </script>
</body>
</html>
