<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>360 Issue Summary</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="https://spyne-prod-ai.s3.us-east-1.amazonaws.com/ai-dataset/2025/favicon.ico" type="image/x-icon" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; margin: 0; padding: 20px; }
    .tabs { display: flex; background: #fff; border-bottom: 2px solid #ccc; margin-bottom: 20px; }
    .tab { padding: 12px 20px; cursor: pointer; font-weight: bold; color: #555; border-bottom: 3px solid transparent; }
    .tab.active { color: #007bff; border-color: #007bff; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .summary-tables { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px 12px; text-align: center; }
    th { background-color: #0057a3; color: white; position: sticky; top: 0; }
    tr:nth-child(even) { background-color: #f2f2f2; }
  </style>
</head>
<body>
<div class="tabs">
  <div class="tab active" data-tab="weeklyTab">Week-wise Summary</div>
</div>

<div class="tab-content active" id="weeklyTab">
  <div class="summary-tables">
    <h3>Severity Details (Week-wise)</h3>
    <table id="severityDetailsTable">
      <thead><tr id="severityDetailsHeader"><th>Severity</th></tr></thead>
      <tbody id="severityDetailsBody"></tbody>
    </table>
    <h3>Issue Details (Week-wise)</h3>
    <table id="issueDetailsTable">
      <thead><tr id="issueDetailsHeader"><th>Issue</th></tr></thead>
      <tbody id="issueDetailsBody"></tbody>
    </table>
  </div>
</div>

<script>
  const issueDataUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR1F4V8WG1U4oYT6HwjZ2Mnv83l_90MYfjNFduCRl7lsx4GBVkFrmAVTwdXLiJgfc6eaykGb8Ygo_GD/pub?gid=0&single=true&output=csv';
const allDataUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTmm6um2dDueAholFhs2olel5wv2mqH9f1jCAfdL8Qi76mzqbTfzu7OYRea5PwSJP0eD0RLuF6XOkTy/pub?gid=0&single=true&output=csv';

  function getWeek(dateStr) {
    const d = new Date(dateStr);
    const onejan = new Date(d.getFullYear(), 0, 1);
    return d.getFullYear() + '-W' + String(Math.ceil((((d - onejan) / 86400000) + onejan.getDay() + 1) / 7)).padStart(2, '0');
  }

  Promise.all([fetch(issueDataUrl), fetch(allDataUrl)])
  .then(([res1, res2]) => Promise.all([res1.text(), res2.text()]))
  .then(([text1, text2]) => {
    Papa.parse(text1, {
      header: true,
      skipEmptyLines: true,
      complete: ({ data: issueData }) => {
        Papa.parse(text2, {
          header: true,
          skipEmptyLines: true,
          complete: ({ data: allData }) => {
            issueData.forEach(d => {
              const dt = new Date(d.Timestamp);
              d.Week = getWeek(dt);
            });
            renderSummaryTables(issueData, 'Week', 'severityDetailsHeader', 'severityDetailsBody', 'Severity');
            renderSummaryTables(issueData, 'Week', 'issueDetailsHeader', 'issueDetailsBody', 'Issue');
          }
        });
      }
    });
  });(text, {
        header: true,
        skipEmptyLines: true,
        complete: ({ data }) => {
          data.forEach(d => {
            const dt = new Date(d.Timestamp);
            d.Week = getWeek(dt);
          });
          renderSummaryTables(data, 'Week', 'severityDetailsHeader', 'severityDetailsBody', 'Severity');
          renderSummaryTables(data, 'Week', 'issueDetailsHeader', 'issueDetailsBody', 'Issue');
        }
      });
    });

  function renderSummaryTables(data, timeKey, headerId, bodyId, groupKey) {
    const timeLabels = Array.from(new Set(data.map(d => d[timeKey]))).sort();
    const categories = Array.from(new Set(data.map(d => d[groupKey])));
    const matrix = {};
    const totals = {};

    allData.forEach(row => {
      const dt = new Date(row.Timestamp);
      const time = getWeek(dt);
      totals[time] = (totals[time] || 0) + 1;
    });

    data.forEach(row => {
      const key = row[groupKey];
      const time = row[timeKey];
      if (!matrix[key]) matrix[key] = {};
      if (!matrix[key][time]) matrix[key][time] = 0;
      matrix[key][time]++;
      totals[time] = (totals[time] || 0) + 1;
    });

    document.getElementById(headerId).innerHTML = `<th>${groupKey}</th>` + timeLabels.map(m => `<th>${m}</th>`).join('');
    document.getElementById(bodyId).innerHTML = categories.map(c => {
      const cells = timeLabels.map(t => {
        const count = matrix[c]?.[t] || 0;
        const percent = ((count / (totals[t] || 1)) * 100).toFixed(1);
        return `<td>${count} <span style='font-size:0.6em;color:#888;'>(${percent}%)</span></td>`;
      });
      return `<tr><td>${c}</td>${cells.join('')}</tr>`;
    }).join('');
  }
</script>
</body>
</html>
