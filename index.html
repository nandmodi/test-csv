<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Team Performance Report</title>
  <link rel="icon" href="https://spyne-prod-ai.s3.us-east-1.amazonaws.com/ai-dataset/2025/favicon.ico" type="image/x-icon" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f4f7fa;
      padding: 20px;
    }
    .container {
      max-width: 1400px;
      margin: auto;
      background: #fff;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #333;
    }
    .filters {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      margin-bottom: 20px;
      gap: 15px;
    }
    .filters > div {
      flex: 1;
      min-width: 250px;
    }
    .dropdown-container {
      position: relative;
    }
    .dropdown-button {
      width: 100%;
      padding: 10px;
      background: #3498db;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .dropdown-menu {
      position: absolute;
      top: 45px;
      left: 0;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 5px;
      z-index: 1000;
      width: 100%;
      max-height: 300px;
      overflow-y: auto;
      display: none;
    }
    .dropdown-container.active .dropdown-menu {
      display: block;
    }
    .dropdown-menu label {
      display: block;
      padding: 8px 12px;
      cursor: pointer;
    }
    .dropdown-menu label:hover {
      background: #f0f0f0;
    }
    .stats-summary {
      display: flex;
      gap: 20px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    .stat-box {
      flex: 1;
      background: #e3f2fd;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: center;
    }
    th {
      background: #3498db;
      color: white;
      cursor: pointer;
    }
    .card {
      margin-top: 20px;
    }
    .card h3 {
      margin-bottom: 10px;
    }
    .card ul {
      list-style: none;
      padding: 0;
    }
    .card li {
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid #eee;
      padding: 6px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Team Performance Report</h1>

    <div class="stats-summary">
      <div class="stat-box">
        <h4>Team Members</h4>
        <div id="teamMembersCount">-</div>
      </div>
      <div class="stat-box">
        <h4>Average Productivity</h4>
        <div id="avgProductivity">-</div>
      </div>
      <div class="stat-box">
        <h4>Total QC Tool Uses</h4>
        <div id="totalQCToolUses">-</div>
      </div>
    </div>

    <div class="filters">
      <div class="dropdown-container">
        <button class="dropdown-button" onclick="toggleDropdown()">Select Team Members</button>
        <div id="dropdownMenu" class="dropdown-menu"></div>
      </div>
      <div>
        <label for="monthYear">Select Month</label>
        <input type="month" id="monthYear">
      </div>
      <div>
        <button onclick="applyFilters()">Apply Filters</button>
      </div>
    </div>

    <div class="card">
      <h3>Top 10 - QC Tool Uses</h3>
      <ul id="topQCToolUses"></ul>
    </div>

    <table id="reportTable">
      <thead>
        <tr>
          <th onclick="sortTable(0)">Name</th>
          <th onclick="sortTable(1)">Working Days</th>
          <th onclick="sortTable(2)">Leaves</th>
          <th onclick="sortTable(3)">Avg Min</th>
          <th onclick="sortTable(4)">Total Min</th>
          <th onclick="sortTable(5)">OT</th>
          <th onclick="sortTable(6)">QC Tool</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

<script>
    const ATTENDANCE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQn-Rg3Sc617Qnm7C0tlc26xfIdGmAZn6FTb7ntuyyhqqP5DETr0f2U_mxFOff2LWNQ8TkKlmKgB03b/pub?gid=0&single=true&output=csv';
    const QC_TOOL_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQn-Rg3Sc617Qnm7C0tlc26xfIdGmAZn6FTb7ntuyyhqqP5DETr0f2U_mxFOff2LWNQ8TkKlmKgB03b/pub?gid=79264188&single=true&output=csv';
    const MAPPING_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQn-Rg3Sc617Qnm7C0tlc26xfIdGmAZn6FTb7ntuyyhqqP5DETr0f2U_mxFOff2LWNQ8TkKlmKgB03b/pub?gid=986458321&single=true&output=csv';

let allData = [], qcToolData = [], nameEmailMap = {}, selectedNames = [], sortDirection = [true, true, true, true, true, true, true];

async function fetchCSVData(url) {
  try {
    const response = await fetch(url);
    const text = await response.text();
    return new Promise(resolve => {
      Papa.parse(text, {
        header: true,
        complete: results => resolve(results.data)
      });
    });
  } catch (error) {
    console.error('Error fetching data:', error);
    return [];
  }
}

// âœ… Fixed: Match email_id
function getQCToolCount(name) {
  const email = nameEmailMap[name];
  if (!email) return 0;
  const count = qcToolData.filter(row =>
    row.email_id && row.email_id.toLowerCase() === email &&
    row.qc_tool !== undefined && row.qc_tool !== null
  ).length;
  return count;
}

function toggleDropdown() {
  document.querySelector('.dropdown-container').classList.toggle('active');
}

function renderDropdown() {
  const container = document.getElementById("dropdownMenu");
  container.innerHTML = '';
  const names = [...new Set(allData.map(row => row.Name))].filter(Boolean);
  names.forEach(name => {
    const label = document.createElement("label");
    label.innerHTML = `<input type="checkbox" value="${name}" checked onchange="updateSelection()"> ${name}`;
    container.appendChild(label);
  });
  selectedNames = names;
}

function updateSelection() {
  selectedNames = Array.from(document.querySelectorAll("#dropdownMenu input:checked")).map(cb => cb.value);
}

function getTopTen(data, key) {
  return Object.keys(data).map(name => ({
    name,
    value: data[name][key]
  })).sort((a, b) => b.value - a.value).slice(0, 10);
}

function updateTopCards(id, data) {
  const ul = document.getElementById(id);
  ul.innerHTML = '';
  data.forEach(item => {
    const li = document.createElement("li");
    li.innerHTML = `<span>${item.name}</span><span>${item.value}</span>`;
    ul.appendChild(li);
  });
}

function sortTable(index) {
  const tbody = document.getElementById("tableBody");
  const rows = Array.from(tbody.rows);
  const asc = sortDirection[index];
  sortDirection[index] = !asc;
  rows.sort((a, b) => {
    const A = a.cells[index].textContent;
    const B = b.cells[index].textContent;
    return asc ? A.localeCompare(B, undefined, {numeric: true}) : B.localeCompare(A, undefined, {numeric: true});
  });
  tbody.innerHTML = '';
  rows.forEach(row => tbody.appendChild(row));
}

async function initApp() {
  [allData, qcToolData, mappingData] = await Promise.all([
    fetchCSVData(ATTENDANCE_SHEET_URL),
    fetchCSVData(QC_TOOL_SHEET_URL),
    fetchCSVData(MAPPING_SHEET_URL)
  ]);

  mappingData.forEach(row => {
    if (row.Name && row.Email) nameEmailMap[row.Name] = row.Email.toLowerCase();
  });

  document.getElementById("monthYear").value = new Date().toISOString().slice(0,7);
  renderDropdown();
  applyFilters();
}

function applyFilters() {
  const month = document.getElementById("monthYear").value;
  const filtered = allData.filter(row => {
    if (!selectedNames.includes(row.Name)) return false;
    if (month) {
      const rowMonth = new Date(row.Date);
      const ym = rowMonth.toISOString().slice(0,7);
      return ym === month;
    }
    return true;
  });

  const grouped = {};
  filtered.forEach(row => {
    const name = row.Name;
    if (!grouped[name]) {
      grouped[name] = { workingDays: 0, leaves: 0, totalMinutes: 0, ot: 0, count: 0 };
    }
    if (row.P === "P") grouped[name].workingDays++;
    if (row.Leave === "Leave" || row.Absent === "Absent") grouped[name].leaves++;
    const mins = parseFloat(row["New Working Mins."]);
    if (!isNaN(mins)) {
      grouped[name].totalMinutes += mins;
      grouped[name].count++;
    }
    const ot = parseFloat(row.OT || 0);
    if (!isNaN(ot)) grouped[name].ot += ot;
  });

  Object.keys(grouped).forEach(name => {
    const g = grouped[name];
    g.avgMinutes = g.count ? (g.totalMinutes / g.count).toFixed(1) : 0;
    g.qc = getQCToolCount(name);
  });

  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = '';
  Object.entries(grouped).forEach(([name, g]) => {
    const row = `<tr>
      <td>${name}</td>
      <td>${g.workingDays}</td>
      <td>${g.leaves}</td>
      <td>${g.avgMinutes}</td>
      <td>${g.totalMinutes.toFixed(1)}</td>
      <td>${g.ot}</td>
      <td>${g.qc}</td>
    </tr>`;
    tbody.insertAdjacentHTML("beforeend", row);
  });

  document.getElementById("teamMembersCount").textContent = Object.keys(grouped).length;
  document.getElementById("avgProductivity").textContent = Math.round(
    Object.values(grouped).reduce((a,b) => a + parseFloat(b.avgMinutes), 0) / Object.keys(grouped).length
  ) + " min";
  document.getElementById("totalQCToolUses").textContent = Object.values(grouped).reduce((a,b) => a + b.qc, 0);

  updateTopCards("topQCToolUses", getTopTen(grouped, "qc"));
}

document.addEventListener("DOMContentLoaded", initApp);
</script>
</body>
</html>
