<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>360 Issue Weekly Summary</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f8f9fa; padding: 20px; margin: 0; }
    h2 { margin-top: 40px; color: #333; }
    table { width: 100%; border-collapse: collapse; background: #fff; margin-top: 10px; border-radius: 6px; overflow: hidden; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: center; }
    th { background-color: #f1f1f1; color: #000; font-weight: bold; }
    tr:nth-child(even) { background-color: #fafafa; }
    td span { font-size: 0.75em; color: #666; }
  </style>
</head>
<body>
  <h2>Severity Details (Week-wise)</h2>
  <table id="severityDetailsTable">
    <thead><tr id="severityDetailsHeader"><th>Severity</th></tr></thead>
    <tbody id="severityDetailsBody"></tbody>
  </table>

  <h2>Issue Details (Week-wise)</h2>
  <table id="issueDetailsTable">
    <thead><tr id="issueDetailsHeader"><th>Issue</th></tr></thead>
    <tbody id="issueDetailsBody"></tbody>
  </table>

  <script>
    const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTaSxWZ-Y3M-wyNiCdN7FSH5kAMMy1cox7D_YRn2sWNkGfo1j4WCGbaedRXgnUKvELK5eAMv334UCaD/pub?gid=0&single=true&output=csv';
    let rawData = [];

    function getWeekRange(date) {
      const d = new Date(date);
      const day = d.getDay();
      const monday = new Date(d);
      monday.setDate(d.getDate() - ((day + 6) % 7));
      const sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);
      return `${monday.toISOString().slice(0,10)} to ${sunday.toISOString().slice(0,10)}`;
    }

    function renderTables() {
      const severityBody = document.getElementById('severityDetailsBody');
      const issueBody = document.getElementById('issueDetailsBody');
      const severityHeader = document.getElementById('severityDetailsHeader');
      const issueHeader = document.getElementById('issueDetailsHeader');

      const severityMatrix = {};
      const issueMatrix = {};
      const totals = {};
      const weeks = [];

      rawData.forEach(row => {
        const date = row.date;
        if (!date) return;
        const sev = row.severity || row.Severity || 'Low';
        const allReasons = `${row.Blocker_Reason || ''},${row.High_Reason || ''},${row.Low_Reason || ''}`;
        const reasonList = allReasons.split(',').map(r => r.trim()).filter(Boolean);
        const week = getWeekRange(date);

        if (!weeks.includes(week)) weeks.push(week);

        if (!severityMatrix[sev]) severityMatrix[sev] = {};
        if (!severityMatrix[sev][week]) severityMatrix[sev][week] = 0;
        severityMatrix[sev][week]++;

        reasonList.forEach(r => {
          if (!issueMatrix[r]) issueMatrix[r] = {};
          if (!issueMatrix[r][week]) issueMatrix[r][week] = 0;
          issueMatrix[r][week]++;
        });

        totals[week] = (totals[week] || 0) + 1;
      });

      weeks.sort().reverse().slice(0, 3).forEach(week => {
        severityHeader.innerHTML += `<th>${week}</th>`;
        issueHeader.innerHTML += `<th>${week}</th>`;
      });

      Object.keys(severityMatrix).forEach(sev => {
        let row = `<tr><td>${sev}</td>`;
        weeks.slice(-3).forEach(week => {
          const count = severityMatrix[sev][week] || 0;
          const total = totals[week] || 1;
          const pct = ((count / total) * 100).toFixed(1);
          row += `<td><b>${count}</b> <span>(${pct}%)</span></td>`;
        });
        row += '</tr>';
        severityBody.innerHTML += row;
      });

      Object.keys(issueMatrix).forEach(issue => {
        let row = `<tr><td>${issue}</td>`;
        weeks.slice(-3).forEach(week => {
          const count = issueMatrix[issue][week] || 0;
          const total = totals[week] || 1;
          const pct = ((count / total) * 100).toFixed(1);
          row += `<td><b>${count}</b> <span>(${pct}%)</span></td>`;
        });
        row += '</tr>';
        issueBody.innerHTML += row;
      });
    }

    function loadCSV() {
      fetch(sheetUrl)
        .then(response => response.text())
        .then(csv => {
          Papa.parse(csv, {
            header: true,
            skipEmptyLines: true,
            complete: result => {
              rawData = result.data;
              renderTables();
            }
          });
        });
    }

    document.addEventListener('DOMContentLoaded', loadCSV);
  </script>
</body>
</html>
