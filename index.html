<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QC Review Dashboard</title>
  <link rel="icon" href="https://spyne-prod-ai.s3.us-east-1.amazonaws.com/ai-dataset/2025/logo/unnamed.png" type="image/x-icon">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    :root {
      --primary: #007BFF;
      --primary-dark: #0056b3;
      --primary-light: #e6f2ff;
      --secondary: #6c757d;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
      --bg: #f9fafb;
      --text: #333;
      --text-light: #666;
      --card-bg: #ffffff;
      --border: #e1e4e8;
      --border-dark: #d1d5da;
      --font: 'Segoe UI', system-ui, -apple-system, sans-serif;
      --shadow: 0 1px 3px rgba(0,0,0,0.1);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
      --radius: 8px;
      --radius-lg: 12px;
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: var(--font);
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    
    .dashboard-container {
      max-width: 1400px;
      width: 100%;
    }
    
    header {
      text-align: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border);
    }
    
    header h1 {
      margin: 0;
      color: var(--primary-dark);
      font-size: 2.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }
    
    header h1 img {
      height: 50px;
      width: auto;
    }
    
    .container {
      width: 100%;
      background: var(--card-bg);
      padding: 25px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      margin-bottom: 25px;
    }
    
    h2 {
      color: var(--text);
      margin-bottom: 15px;
      font-size: 1.75rem;
      font-weight: 600;
      border-bottom: 1px solid var(--border);
      padding-bottom: 10px;
    }
    
    label {
      font-weight: 600;
      display: block;
      margin-top: 15px;
      margin-bottom: 8px;
      font-size: 0.95rem;
      color: var(--text);
    }
    
    select, input, textarea {
      padding: 10px 12px;
      width: 100%;
      max-width: 300px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 14px;
      font-family: var(--font);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    select:focus, input:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-light);
    }
    
    textarea {
      width: 100%;
      height: 120px;
      resize: vertical;
      line-height: 1.5;
      max-width: 100%;
    }
    
    button {
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 500;
      border-radius: var(--radius);
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
      box-shadow: var(--shadow);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    button:hover {
      background-color: var(--primary-dark);
      transform: translateY(-1px);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-secondary {
      background-color: var(--secondary);
    }
    
    .btn-secondary:hover {
      background-color: #5a6268;
    }
    
    .btn-success {
      background-color: var(--success);
    }
    
    .btn-success:hover {
      background-color: #218838;
    }
    
    .filters, .form-section {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      align-items: flex-start;
    }
    
    .top-bar {
      background: var(--primary-light);
      padding: 15px;
      border-radius: var(--radius);
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      width: 100%;
    }
    
    .top-bar div {
      min-width: 150px;
      flex: 1 1 200px;
      word-wrap: break-word;
      font-size: 0.95rem;
    }
    
    .top-bar strong {
      color: var(--primary-dark);
      font-weight: 600;
      display: block;
      margin-bottom: 5px;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .top-bar span {
      color: var(--text);
      font-weight: 500;
    }
    
    .images {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin: 20px 0;
      width: 100%;
    }
    
    .images img {
      width: 100%;
      aspect-ratio: 4 / 3;
      object-fit: contain;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: #f8f9fa;
      box-shadow: var(--shadow);
      transition: transform 0.2s;
    }
    
    .images img:hover {
      transform: scale(1.02);
    }
    
    .image-label {
      display: block;
      text-align: center;
      margin-top: 8px;
      font-size: 0.9rem;
      color: var(--text-light);
      font-weight: 500;
    }
    
    .form-section {
      flex-direction: column;
      gap: 15px;
      margin-top: 15px;
      width: 100%;
    }
    
    .nav-buttons {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      justify-content: flex-start;
      margin-top: 20px;
      width: 100%;
    }
    
    .nav-buttons button {
      min-width: 120px;
    }
    
    .source-toggle {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
      background: var(--primary-light);
      padding: 15px;
      border-radius: var(--radius);
      flex-wrap: wrap;
    }
    
    .source-toggle label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-weight: 500;
      margin-top: 0;
      color: var(--text);
      white-space: nowrap;
    }
    
    .source-toggle input {
      width: auto;
      max-width: none;
      margin: 0;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0,0,0,.1);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
      margin-left: 10px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .status-message {
      margin-top: 15px;
      padding: 12px 15px;
      border-radius: var(--radius);
      font-size: 0.95rem;
    }
    
    .error {
      background-color: #ffebee;
      color: #c62828;
      border-left: 4px solid #c62828;
    }
    
    .success {
      background-color: #e8f5e9;
      color: #2e7d32;
      border-left: 4px solid #2e7d32;
    }
    
    .warning {
      background-color: #fff8e1;
      color: #ff8f00;
      border-left: 4px solid #ff8f00;
    }
    
    .image-container {
      display: flex;
      flex-direction: column;
      background: white;
      padding: 15px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    
    .progress-indicator {
      margin: 15px 0;
      font-size: 0.9rem;
      color: var(--text-light);
      font-weight: 500;
      padding: 10px;
      background: #f0f8ff;
      border-radius: var(--radius);
    }
    
    #review-section, #meet-review-section {
      display: none;
      width: 100%;
    }
    
    .meet-review-filter {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
      padding: 15px;
      background-color: #f0f8ff;
      border-radius: var(--radius);
    }
    
    .meet-review-filter > div {
      min-width: 200px;
      flex: 1;
    }
    
    .dashboard-actions {
      display: flex;
      gap: 15px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    
    .logo-badge {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
      font-size: 0.9rem;
      color: var(--text-light);
    }
    
    .logo-badge img {
      height: 30px;
      width: auto;
    }
    
    @media screen and (max-width: 768px) {
      .top-bar div {
        flex: 1 1 100%;
      }
      
      .nav-buttons button {
        flex: 1 1 100%;
      }
      
      .images {
        grid-template-columns: 1fr;
      }
      
      .source-toggle {
        flex-direction: column;
        gap: 10px;
      }
      
      .meet-review-filter > div {
        flex: 1 1 100%;
      }
      
      .dashboard-actions {
        flex-direction: column;
      }
      
      .container {
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <header>
      <h1>
        <img src="https://spyne-prod-ai.s3.us-east-1.amazonaws.com/ai-dataset/2025/logo/unnamed.png" alt="Spyne AI Logo">
        QC Review Dashboard
      </h1>
    </header>
    
    <div class="container" id="login-section">
      <h2>QC Review Login</h2>
      
      <div class="source-toggle">
        <label>
          <input type="radio" name="dataSource" value="qc" checked> QC-Pass
        </label>
        <label>
          <input type="radio" name="dataSource" value="edited"> Re-Edit
        </label>
        <label>
          <input type="radio" name="dataSource" value="qc_tool"> QC-Tool
        </label>
      </div>
      
      <label for="loginID">Login ID</label>
      <select id="loginID">
        <option value="">Select Login ID</option>
        <option>Nand Kishor</option>
        <option>Ranbir Manoranjan</option>
        <option>Nitin kumar</option>
        <option>Praveen Agarwal</option>
        <option>Raj Tripatrhi</option>
        <option>Rohit Chahuhan</option>
        <option>Saurabh Pandey</option>
      </select>
      
      <div class="filters">
        <div>
          <label>Date</label>
          <select id="dateFilter"><option value="">ALL</option></select>
        </div>
        <div>
          <label>Enterprise</label>
          <select id="enterpriseFilter"><option value="">ALL</option></select>
        </div>
        <div>
          <label>QC User</label>
          <select id="qcUserFilter"><option value="">ALL</option></select>
        </div>
        <div id="editingUserFilterContainer" style="display: none;">
          <label>Editing User</label>
          <select id="editingUserFilter"><option value="">ALL</option></select>
        </div>
        <div id="issueFilterContainer" style="display: none;">
          <label>Issue</label>
          <select id="issueFilter"><option value="">ALL</option></select>
        </div>
      </div>
      
      <div class="dashboard-actions">
        <button id="startButton" onclick="loadFilteredData()">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
            <path d="M6.271 5.055a.5.5 0 0 1 .52.038l3.5 2.5a.5.5 0 0 1 0 .814l-3.5 2.5A.5.5 0 0 1 6 10.5v-5a.5.5 0 0 1 .271-.445z"/>
          </svg>
          Start QC
        </button>
        <button id="meetReviewButton" onclick="loadMeetReviewData()" class="btn-secondary">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
          </svg>
          Meet Review
        </button>
      </div>
      
      <div id="loadingIndicator" style="display: none; margin-top: 20px;">
        <span class="loading"></span> Loading data...
      </div>
      
      <div id="statusMessage" class="status-message" style="display: none;"></div>
    </div>

    <div class="container" id="review-section" style="display:none">
      <h2>Review Details</h2>
      
      <div class="top-bar">
        <div><strong>Enterprise</strong> <span id="enterprise"></span></div>
        <div id="qcUsersContainer"><strong>QC Users</strong> <span id="qcUsers"></span></div>
        <div id="userContainer"><strong>User</strong> <span id="user"></span></div>
        <div id="editingUserContainer"><strong>Editing User</strong> <span id="editingUser"></span></div>
        <div id="issueContainer"><strong>Issue</strong> <span id="issue"></span></div>
        <div><strong>SKU ID</strong> <span id="sku"></span></div>
        <div><strong>Image ID</strong> <span id="imageID"></span></div>
      </div>
      
      <div class="progress-indicator">
        Reviewing <span id="currentIndexDisplay">1</span> of <span id="totalCountDisplay">0</span>
      </div>
      
      <div class="images">
        <div class="image-container">
          <img id="left" src="https://via.placeholder.com/600x450/cccccc/999999?text=Input+Image" alt="Input Image">
          <span class="image-label">Input Image</span>
        </div>
        <div class="image-container">
          <img id="middle" src="https://via.placeholder.com/600x450/eeeeee/999999?text=AI+Image" alt="AI Image">
          <span class="image-label">AI Image</span>
        </div>
        <div class="image-container">
          <img id="right" src="https://via.placeholder.com/600x450/f5f5f5/999999?text=Final+Image" alt="Final Image">
          <span class="image-label">Final Image</span>
        </div>
      </div>
      
      <div class="form-section">
        <div>
          <label for="qcComment">QC Comment</label>
          <textarea id="qcComment" placeholder="Enter your detailed comments here..."></textarea>
        </div>
        
        <div class="nav-buttons">
          <button onclick="prevEntry()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/>
            </svg>
            Previous
          </button>
          <button onclick="submitAndNext()" class="btn-success">
            Next
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
            </svg>
          </button>
          <button onclick="exitToLogin()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path d="M12.5 0c-.157 0-.311.01-.565.027A1 1 0 0 0 11 1.02V10h8.975a1 1 0 0 0 1-.935c.013-.188.028-.374.028-.565A8.51 8.51 0 0 0 12.5 0z"/>
              <path d="M11.5 0A7.5 7.5 0 0 0 4 7.5V8H1.5A1.5 1.5 0 0 0 0 9.5v5A1.5 1.5 0 0 0 1.5 16h5A1.5 1.5 0 0 0 8 14.5v-5A1.5 1.5 0 0 0 6.5 8H5v-.5a3.5 3.5 0 1 1 7 0V8h-1V6.5a5.5 5.5 0 1 0-11 0V8H0v-.5A7.5 7.5 0 0 1 7.5 0h4z"/>
            </svg>
            Exit
          </button>
        </div>
      </div>
    </div>

    <div class="container" id="meet-review-section" style="display:none">
      <h2>Meet Review Details</h2>
      
      <div class="meet-review-filter">
        <div>
          <label for="meetDateFilter">Date</label>
          <select id="meetDateFilter"><option value="">ALL</option></select>
        </div>
        <div>
          <label for="meetEnterpriseFilter">Enterprise</label>
          <select id="meetEnterpriseFilter"><option value="">ALL</option></select>
        </div>
        <div>
          <label for="meetQcUserFilter">QC User</label>
          <select id="meetQcUserFilter"><option value="">ALL</option></select>
        </div>
        <div>
          <label for="meetEditingUserFilter">Editing User</label>
          <select id="meetEditingUserFilter"><option value="">ALL</option></select>
        </div>
      </div>
      
      <div class="top-bar">
        <div><strong>Date</strong> <span id="meetDate"></span></div>
        <div><strong>Enterprise</strong> <span id="meetEnterprise"></span></div>
        <div><strong>QC User</strong> <span id="meetQcUser"></span></div>
        <div><strong>Editing User</strong> <span id="meetEditingUser"></span></div>
        <div><strong>SKU ID</strong> <span id="meetSku"></span></div>
        <div><strong>Image ID</strong> <span id="meetImageID"></span></div>
      </div>
      
      <div class="top-bar">
        <div><strong>Issue</strong> <span id="meetIssue"></span></div>
        <div><strong>Comment</strong> <span id="meetComment"></span></div>
      </div>
      
      <div class="progress-indicator">
        Reviewing <span id="meetCurrentIndexDisplay">1</span> of <span id="meetTotalCountDisplay">0</span>
      </div>
      
      <div class="images">
        <div class="image-container">
          <img id="meetLeft" src="https://via.placeholder.com/600x450/cccccc/999999?text=Input+Image" alt="Input Image">
          <span class="image-label">Input Image</span>
        </div>
        <div class="image-container">
          <img id="meetMiddle" src="https://via.placeholder.com/600x450/eeeeee/999999?text=AI+Image" alt="AI Image">
          <span class="image-label">AI Image</span>
        </div>
        <div class="image-container">
          <img id="meetRight" src="https://via.placeholder.com/600x450/f5f5f5/999999?text=Final+Image" alt="Final Image">
          <span class="image-label">Final Image</span>
        </div>
      </div>
      
      <div class="nav-buttons">
        <button onclick="prevMeetEntry()">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/>
          </svg>
          Previous
        </button>
        <button onclick="nextMeetEntry()" class="btn-success">
          Next
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
          </svg>
        </button>
        <button onclick="exitToLogin()">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M12.5 0c-.157 0-.311.01-.565.027A1 1 0 0 0 11 1.02V10h8.975a1 1 0 0 0 1-.935c.013-.188.028-.374.028-.565A8.51 8.51 0 0 0 12.5 0z"/>
            <path d="M11.5 0A7.5 7.5 0 0 0 4 7.5V8H1.5A1.5 1.5 0 0 0 0 9.5v5A1.5 1.5 0 0 0 1.5 16h5A1.5 1.5 0 0 0 8 14.5v-5A1.5 1.5 0 0 0 6.5 8H5v-.5a3.5 3.5 0 1 1 7 0V8h-1V6.5a5.5 5.5 0 1 0-11 0V8H0v-.5A7.5 7.5 0 0 1 7.5 0h4z"/>
          </svg>
          Exit
        </button>
      </div>
    </div>
    
    <div class="logo-badge">
      <img src="https://spyne-prod-ai.s3.us-east-1.amazonaws.com/ai-dataset/2025/logo/unnamed.png" alt="Spyne AI">
      <span>Quality Control Dashboard v2.0</span>
    </div>
  </div>

  <script>
    // Google Sheets URLs
    const QC_PASS_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSWW7muoNyeY_1VOLhybuT7ChNHtkhAscxDikyiCPQChIWqi1m3KXsd9e0_i_UFE7bDrW_7kfH-vIhL/pub?gid=1717039169&single=true&output=csv";
    const RE_EDIT_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSWW7muoNyeY_1VOLhybuT7ChNHtkhAscxDikyiCPQChIWqi1m3KXsd9e0_i_UFE7bDrW_7kfH-vIhL/pub?gid=320301246&single=true&output=csv";
    const MEET_REVIEW_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSWW7muoNyeY_1VOLhybuT7ChNHtkhAscxDikyiCPQChIWqi1m3KXsd9e0_i_UFE7bDrW_7kfH-vIhL/pub?gid=1880564018&single=true&output=csv";

    // Field mapping configuration
    const FIELD_MAPPING = {
      qc: {
        'enterprise': 'enterprise_name',
        't1.image_id': 'ai.image_id',
        't1.sku_id': 'sku_id',
        'left_path': 'input_image_hres_url',
        'middle_path': 'output_image_hres_url',
        'right_path': 'manual_image_hres_url',
        'user': 'qc_user_name',
        'first_qc_user': '',
        'last_qc_user': '',
        'last_editor_user': '',
        'issue': '',
        'date': 'qc_completed_time',
        'status': 'status'
      },
      edited: {
        'enterprise': 'enterprise_name',
        't1.image_id': 'ai.image_id',
        't1.sku_id': 'sku_id',
        'left_path': 'input_image_hres_url',
        'middle_path': 'ai_output',
        'right_path': 'final_output',
        'user': 'last_qc_user',
        'first_qc_user': 'first_qc_user',
        'last_qc_user': 'last_qc_user',
        'last_editor_user': 'last_editor_user',
        'issue': 'rejected_comments',
        'date': 'qc_completed_time',
        'status': 'status',
        'latest_image_action': 'latest_image_action'
      },
      qc_tool: {
        'enterprise': 'enterprise_name',
        't1.image_id': 'ai.image_id',
        't1.sku_id': 'sku_id',
        'left_path': 'input_image_hres_url',
        'middle_path': 'ai_output',
        'right_path': 'final_output',
        'user': 'last_qc_user',
        'first_qc_user': 'first_qc_user',
        'last_qc_user': 'last_qc_user',
        'last_editor_user': 'last_editor_user',
        'issue': 'rejected_comments',
        'date': 'qc_completed_time',
        'status': 'status',
        'latest_image_action': 'latest_image_action'
      }
    };

    let rawData = [];
    let groupedData = [];
    let currentIndex = 0;

    let meetReviewData = [];
    let filteredMeetData = [];
    let meetReviewCurrentIndex = 0;

    // DOM elements
    const loginSection = document.getElementById('login-section');
    const reviewSection = document.getElementById('review-section');
    const meetReviewSection = document.getElementById('meet-review-section');
    const statusMessage = document.getElementById('statusMessage');
    const loadingIndicator = document.getElementById('loadingIndicator');

    function showLoading(show) {
      const button = document.getElementById('startButton');
      const meetButton = document.getElementById('meetReviewButton');
      if (show) {
        button.disabled = true;
        meetButton.disabled = true;
        loadingIndicator.style.display = 'block';
      } else {
        button.disabled = false;
        meetButton.disabled = false;
        loadingIndicator.style.display = 'none';
      }
    }

    function showStatus(message, isError = false, isWarning = false) {
      statusMessage.textContent = message;
      statusMessage.className = 'status-message ' + 
        (isError ? 'error' : isWarning ? 'warning' : 'success');
      statusMessage.style.display = 'block';
      
      if (!isError && !isWarning) {
        setTimeout(() => {
          statusMessage.style.display = 'none';
        }, 3000);
      }
    }

    function getDataSource() {
      const selected = document.querySelector('input[name="dataSource"]:checked');
      return selected ? selected.value : 'qc';
    }

    function getDataSourceUrl() {
      return getDataSource() === 'qc' ? QC_PASS_URL : RE_EDIT_URL;
    }

    function toggleAdditionalFilters() {
      const sourceType = getDataSource();
      const editingUserContainer = document.getElementById('editingUserFilterContainer');
      const issueContainer = document.getElementById('issueFilterContainer');
      
      if (sourceType === 'edited' || sourceType === 'qc_tool') {
        editingUserContainer.style.display = 'block';
        issueContainer.style.display = 'block';
      } else {
        editingUserContainer.style.display = 'none';
        issueContainer.style.display = 'none';
      }
    }

    function normalizeData(rawData, sourceType) {
      const mapping = FIELD_MAPPING[sourceType];
      return rawData.map(row => {
        const normalized = {};
        
        // Map all fields according to the configuration
        for (const [targetField, sourceField] of Object.entries(mapping)) {
          if (sourceField) {
            normalized[targetField] = row[sourceField] || '';
          }
        }
        
        // Ensure required fields exist
        normalized['status'] = normalized['status'] || '';
        
        return normalized;
      });
    }

    function populateDropdowns(data) {
      const dates = new Set(), enterprises = new Set(), users = new Set();
      const editingUsers = new Set(), issues = new Set();
      
      data.forEach(row => {
        if (row["date"]) dates.add(row["date"]);
        if (row["enterprise"]) enterprises.add(row["enterprise"]);
        if (row["user"]) users.add(row["user"]);
        if (row["last_editor_user"]) editingUsers.add(row["last_editor_user"]);
        
        // Enhanced issue processing - split comma-separated values
        if (row["issue"]) {
          const issueList = row["issue"].split(',')
            .map(issue => issue.trim())
            .filter(issue => issue.length > 0);
          issueList.forEach(issue => issues.add(issue));
        }
      });
      
      fillSelect("dateFilter", [...dates]);
      fillSelect("enterpriseFilter", [...enterprises]);
      fillSelect("qcUserFilter", [...users]);
      fillSelect("editingUserFilter", [...editingUsers]);
      fillSelect("issueFilter", [...issues]);
    }

    function fillSelect(id, options) {
      const select = document.getElementById(id);
      // Clear existing options except the first one
      while (select.options.length > 1) {
        select.remove(1);
      }
      
      // Sort options
      const sortedOptions = [...options].sort();
      
      sortedOptions.forEach(opt => {
        const option = document.createElement("option");
        option.value = opt;
        option.text = opt;
        select.appendChild(option);
      });
    }

    function loadFilteredData() {
      const loginID = document.getElementById('loginID').value.trim().toLowerCase();
      if (!loginID) {
        showStatus('Please select a Login ID', true);
        return;
      }

      showLoading(true);
      
      const date = document.getElementById('dateFilter').value.trim();
      const enterprise = document.getElementById('enterpriseFilter').value.trim().toLowerCase();
      const qcUser = document.getElementById('qcUserFilter').value.trim().toLowerCase();
      const editingUser = document.getElementById('editingUserFilter').value.trim().toLowerCase();
      const issue = document.getElementById('issueFilter').value.trim().toLowerCase();
      const sourceType = getDataSource();

      const filteredRaw = rawData.filter(row => {
        const rowDate = (row["date"] || '').trim();
        const rowEnterprise = (row["enterprise"] || '').trim().toLowerCase();
        const rowUser = (row["user"] || '').trim().toLowerCase();
        const rowEditingUser = (row["last_editor_user"] || '').trim().toLowerCase();
        const rowIssues = (row["issue"] || '').split(',').map(i => i.trim().toLowerCase());
        const status = (row["status"] || '').trim().toLowerCase();
        const latestImageAction = (row["latest_image_action"] || '').trim().toLowerCase();

        // Common filters for all data sources
        let shouldInclude = (
          (status === '' || status === 'null' || status === null) && // Only include blank/null status
          (!date || rowDate === date) &&
          (!enterprise || rowEnterprise === enterprise) &&
          (!qcUser || rowUser === qcUser)
        );

        // Additional filters for Re-Edit and QC-Tool
        if (sourceType === 'edited' || sourceType === 'qc_tool') {
          shouldInclude = shouldInclude && 
            (!editingUser || rowEditingUser === editingUser) &&
            (!issue || rowIssues.includes(issue)); // Changed to check if any issue matches
        }

        // Additional filters based on data source
        if (sourceType === 'qc_tool') {
          shouldInclude = shouldInclude && (latestImageAction === 'qc_editingtool');
        } else if (sourceType === 'edited') {
          shouldInclude = shouldInclude && (latestImageAction !== 'qc_editingtool');
        }

        return shouldInclude;
      });

      const map = new Map();
      for (const row of filteredRaw) {
        const imageId = row["t1.image_id"];
        if (!imageId) continue;

        if (!map.has(imageId)) {
          map.set(imageId, {
            ...row,
            users: new Set([row["user"]]),
            first_qc_users: new Set([row["first_qc_user"]]),
            last_qc_users: new Set([row["last_qc_user"]]),
            issues: new Set(row["issue"].split(',').map(i => i.trim()).filter(i => i))
          });
        } else {
          const existing = map.get(imageId);
          existing.users.add(row["user"]);
          existing.first_qc_users.add(row["first_qc_user"]);
          existing.last_qc_users.add(row["last_qc_user"]);
          row["issue"].split(',').map(i => i.trim()).filter(i => i).forEach(i => existing.issues.add(i));
        }
      }

      groupedData = Array.from(map.values()).map(item => ({
        ...item,
        user: Array.from(item.users).filter(Boolean).join(", "),
        first_qc_user: Array.from(item.first_qc_users).filter(Boolean).join(", "),
        last_qc_user: Array.from(item.last_qc_users).filter(Boolean).join(", "),
        issue: Array.from(item.issues).filter(Boolean).join(", ")
      }));

      // Shuffle the groupedData array for random display
      for (let i = groupedData.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [groupedData[i], groupedData[j]] = [groupedData[j], groupedData[i]];
      }

      showLoading(false);

      if (groupedData.length > 0) {
        currentIndex = 0;
        showReview();
        loginSection.style.display = "none";
        reviewSection.style.display = "block";
        showStatus(`Loaded ${groupedData.length} records to review`);
      } else {
        showStatus('No matching records found.', true);
      }
    }

    function formatQCUsers(firstQC, lastQC) {
      if (!firstQC && !lastQC) return "";

      // Clean up the values
      firstQC = (firstQC || "").trim();
      lastQC = (lastQC || "").trim();

      // If firstQC is N/A or empty, use lastQC
      if (!firstQC || firstQC.toLowerCase() === "n/a") {
        return lastQC || "";
      }

      // If lastQC is N/A or empty, use firstQC
      if (!lastQC || lastQC.toLowerCase() === "n/a") {
        return firstQC || "";
      }

      // If both are the same, return just one
      if (firstQC === lastQC) {
        return firstQC;
      }

      // Otherwise return both, ensuring no duplicates
      const users = [firstQC, lastQC];
      const uniqueUsers = Array.from(new Set(users)).join(", ");
      return uniqueUsers;
    }

    function showReview() {
      const row = groupedData[currentIndex];
      const sourceType = getDataSource();
      
      // Update progress indicator
      document.getElementById('currentIndexDisplay').textContent = currentIndex + 1;
      document.getElementById('totalCountDisplay').textContent = groupedData.length;

      // Show/hide fields based on data source
      document.getElementById('qcUsersContainer').style.display = (sourceType === 'edited' || sourceType === 'qc_tool') ? 'block' : 'none';
      document.getElementById('userContainer').style.display = (sourceType === 'qc') ? 'block' : 'none';
      document.getElementById('editingUserContainer').style.display = (sourceType === 'edited' || sourceType === 'qc_tool') ? 'block' : 'none';
      document.getElementById('issueContainer').style.display = (sourceType === 'edited' || sourceType === 'qc_tool') ? 'block' : 'none';

      // Set values only if they're not "N/A"
      const setValue = (elementId, value) => {
        const element = document.getElementById(elementId);
        element.textContent = value && value.trim() && value.trim().toLowerCase() !== "n/a" ? value.trim() : "";
        element.parentElement.style.display = element.textContent ? "block" : "none";
      };
      
      setValue('enterprise', row["enterprise"]);
      setValue('sku', row["t1.sku_id"]);
      setValue('imageID', row["t1.image_id"]);
      setValue('issue', row["issue"]);
      setValue('editingUser', row["last_editor_user"]);

      // Format QC users specially for Re-Edit and QC-Tool
      const firstQC = row["first_qc_user"] || "";
      const lastQC = row["last_qc_user"] || "";
      const qcUsersDisplay = formatQCUsers(firstQC, lastQC);
      setValue('qcUsers', qcUsersDisplay);

      // For QC-Pass, show the single user
      setValue('user', row["user"]);

      // Set image sources with error handling
      const setImage = (elementId, path) => {
        const img = document.getElementById(elementId);
        if (path) {
          img.src = path;
          img.onerror = () => {
            img.src = 'https://via.placeholder.com/400x300?text=Image+Not+Available';
            showStatus(`Error loading image: ${path}`, true);
          };
        } else {
          img.src = 'https://via.placeholder.com/400x300?text=Image+Not+Available';
        }
      };
      
      setImage('left', row["left_path"]);
      setImage('middle', row["middle_path"]);
      setImage('right', row["right_path"]);
      
      document.getElementById('qcComment').value = "";
    }

    function submitAndNext() {
      const row = groupedData[currentIndex];
      const loginUser = document.getElementById('loginID').value || "";
      let comment = document.getElementById('qcComment').value.trim();
      if (!comment) comment = "Done";

      const sourceType = getDataSource();
      
      // Prepare form data based on source type
      let qcUserField = "";
      let editingUserField = "";
      
      if (sourceType === 'qc') {
        // For QC-Pass, use the single user field
        qcUserField = row["user"] || "";
        editingUserField = ""; // No editing user for QC-Pass
      } else {
        // For Re-Edit and QC-Tool, combine first and last QC users
        const firstQC = row["first_qc_user"] || "";
        const lastQC = row["last_qc_user"] || "";
        qcUserField = formatQCUsers(firstQC, lastQC);
        editingUserField = row["last_editor_user"] || "";
      }

      const url = new URL("https://docs.google.com/forms/d/e/1FAIpQLSdrjhynjWITfOqHpkgKX8enCmDKg1b3s0Ij05Cux36kPmZEUA/formResponse");
      const params = new URLSearchParams({
        "entry.890284089": row["enterprise"] || "", // Enterprise
        "entry.5932044": qcUserField, // QC User (varies by source)
        "entry.1880389842": editingUserField, // Editing User (for Re-Edit/QC-Tool)
        "entry.1139236247": row["t1.sku_id"] || "", // SKU ID
        "entry.661750446": row["t1.image_id"] || "", // Image ID
        "entry.1317530325": row["issue"] || "", // Issue
        "entry.1455673211": row["left_path"] || "", // Input Image
        "entry.772576827": row["middle_path"] || "", // AI Image
        "entry.780536997": row["right_path"] || "", // Final Image
        "entry.865196657": loginUser, // Login User
        "entry.778698303": comment // Comment
      });

      fetch(`${url}?${params.toString()}`, { method: 'POST', mode: 'no-cors' })
        .then(() => {
          if (currentIndex < groupedData.length - 1) {
            currentIndex++;
            showReview();
          } else {
            showStatus('All entries reviewed. Returning to login screen.');
            setTimeout(exitToLogin, 2000);
          }
        })
        .catch(error => {
          console.error('Submission error:', error);
          showStatus('Error submitting data', true);
        });
    }

    function prevEntry() {
      if (currentIndex > 0) {
        currentIndex--;
        showReview();
      }
    }

    function exitToLogin() {
      reviewSection.style.display = "none";
      meetReviewSection.style.display = "none";
      loginSection.style.display = "block";
      showStatus('Returned to login screen', false, true);
    }

    // Meet Review Functions
    function loadMeetReviewData() {
      showLoading(true);
      showStatus('Loading meet review data...');
      
      // Clear previous meet review data
      meetReviewData = [];
      filteredMeetData = [];
      
      Papa.parse(MEET_REVIEW_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          showLoading(false);
          
          if (results.data && results.data.length > 0) {
            showStatus('Meet review data loaded successfully!');
            
            // Filter out records where Comment is "Done" or similar
            meetReviewData = results.data.filter(row => {
              const comment = (row["Comment"] || "").trim().toLowerCase();
              return !comment.includes("done") && comment !== "";
            });
            
            if (meetReviewData.length === 0) {
              showStatus('No meet review records available (all are done)', true);
              return;
            }
            
            // Populate meet review filters
            const dates = new Set(), 
                  enterprises = new Set(), 
                  qcUsers = new Set(), 
                  editingUsers = new Set();
                  
            meetReviewData.forEach(row => {
              if (row["Timestamp"]) dates.add(row["Timestamp"]);
              if (row["Enterprise"]) enterprises.add(row["Enterprise"]);
              if (row["qc-user"]) qcUsers.add(row["qc-user"]);
              if (row["editing user"]) editingUsers.add(row["editing user"]);
            });
            
            fillSelect("meetDateFilter", [...dates]);
            fillSelect("meetEnterpriseFilter", [...enterprises]);
            fillSelect("meetQcUserFilter", [...qcUsers]);
            fillSelect("meetEditingUserFilter", [...editingUsers]);
            
            // Apply initial filtering
            filterMeetReviewData();
          } else {
            showStatus('No meet review data found in the file.', true);
          }
        },
        error: function(error) {
          showLoading(false);
          console.error("Error loading meet review data:", error);
          showStatus('Error loading meet review data. Please try again. ' + error.message, true);
        }
      });
    }

    function filterMeetReviewData() {
      const date = document.getElementById("meetDateFilter").value.trim();
      const enterprise = document.getElementById("meetEnterpriseFilter").value.trim().toLowerCase();
      const qcUser = document.getElementById("meetQcUserFilter").value.trim().toLowerCase();
      const editingUser = document.getElementById("meetEditingUserFilter").value.trim().toLowerCase();
      
      filteredMeetData = meetReviewData.filter(row => {
        const rowDate = (row["Timestamp"] || "").trim();
        const rowEnterprise = (row["Enterprise"] || "").trim().toLowerCase();
        const rowQcUser = (row["qc-user"] || "").trim().toLowerCase();
        const rowEditingUser = (row["editing user"] || "").trim().toLowerCase();
        
        return (
          (!date || rowDate === date) &&
          (!enterprise || rowEnterprise === enterprise) &&
          (!qcUser || rowQcUser === qcUser) &&
          (!editingUser || rowEditingUser === editingUser)
        );
      });
      
      if (filteredMeetData.length > 0) {
        meetReviewCurrentIndex = 0;
        showMeetReview();
        loginSection.style.display = "none";
        meetReviewSection.style.display = "block";
        document.getElementById("meetTotalCountDisplay").textContent = filteredMeetData.length;
        showStatus(`Showing ${filteredMeetData.length} meet review records`);
      } else {
        showStatus('No matching records found for meet review.', true);
      }
    }

    function showMeetReview() {
      if (filteredMeetData.length === 0) return;
      
      const row = filteredMeetData[meetReviewCurrentIndex];
      
      // Update progress indicator
      document.getElementById("meetCurrentIndexDisplay").textContent = meetReviewCurrentIndex + 1;
      document.getElementById("meetTotalCountDisplay").textContent = filteredMeetData.length;
      
      // Set values
      document.getElementById("meetDate").textContent = row["Timestamp"] || "";
      document.getElementById("meetEnterprise").textContent = row["Enterprise"] || "";
      document.getElementById("meetQcUser").textContent = row["qc-user"] || "";
      document.getElementById("meetEditingUser").textContent = row["editing user"] || "";
      document.getElementById("meetSku").textContent = row["sku_id"] || "";
      document.getElementById("meetImageID").textContent = row["image_id"] || "";
      document.getElementById("meetIssue").textContent = row["Issue"] || "";
      document.getElementById("meetComment").textContent = row["Comment"] || "";
      
      // Set image sources with error handling
      const setImage = (elementId, path) => {
        const img = document.getElementById(elementId);
        if (path) {
          img.src = path;
          img.onerror = () => {
            img.src = 'https://via.placeholder.com/400x300?text=Image+Not+Available';
            showStatus(`Error loading image: ${path}`, true);
          };
        } else {
          img.src = 'https://via.placeholder.com/400x300?text=Image+Not+Available';
        }
      };
      
      setImage('meetLeft', row["input image"]);
      setImage('meetMiddle', row["Ai image"]);
      setImage('meetRight', row["Final Image"]);
    }

    function prevMeetEntry() {
      if (meetReviewCurrentIndex > 0) {
        meetReviewCurrentIndex--;
        showMeetReview();
      }
    }

    function nextMeetEntry() {
      if (meetReviewCurrentIndex < filteredMeetData.length - 1) {
        meetReviewCurrentIndex++;
        showMeetReview();
      }
    }

    // Add event listeners for meet review filters
    document.getElementById("meetDateFilter").addEventListener("change", filterMeetReviewData);
    document.getElementById("meetEnterpriseFilter").addEventListener("change", filterMeetReviewData);
    document.getElementById("meetQcUserFilter").addEventListener("change", filterMeetReviewData);
    document.getElementById("meetEditingUserFilter").addEventListener("change", filterMeetReviewData);

    // Event listeners
    document.addEventListener('keydown', function(event) {
      if (reviewSection.style.display !== "none") {
        if (event.key === "Enter") {
          event.preventDefault();
          submitAndNext();
        } else if (event.key === "p" || event.key === "P") {
          event.preventDefault();
          prevEntry();
        } else if (event.key === "Escape") {
          event.preventDefault();
          exitToLogin();
        }
      }
      else if (meetReviewSection.style.display !== "none") {
        if (event.key === "ArrowLeft") {
          event.preventDefault();
          prevMeetEntry();
        } else if (event.key === "ArrowRight") {
          event.preventDefault();
          nextMeetEntry();
        } else if (event.key === "Escape") {
          event.preventDefault();
          exitToLogin();
        }
      }
    });

    // Listen for data source changes
    document.querySelectorAll('input[name="dataSource"]').forEach(radio => {
      radio.addEventListener('change', function() {
        loadData();
        toggleAdditionalFilters();
      });
    });

    // Initialize on load
    window.onload = () => {
      // Load initial data for QC-Pass
      loadData();
    };

    function loadData() {
      showLoading(true);
      const url = getDataSourceUrl();
      const sourceType = getDataSource();
      
      Papa.parse(url, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          showLoading(false);
          if (results.data && results.data.length > 0) {
            rawData = normalizeData(results.data, sourceType);
            populateDropdowns(rawData);
            toggleAdditionalFilters();
            showStatus(`Successfully loaded ${rawData.length} records from ${sourceType === 'qc' ? 'QC-Pass' : sourceType === 'edited' ? 'Re-Edit' : 'QC-Tool'}`);
          } else {
            showStatus('No data found in the selected source', true);
          }
        },
        error: function(error) {
          showLoading(false);
          console.error("Error loading data:", error);
          showStatus('Error loading data. Please try again.', true);
        }
      });
    }
  </script>
</body>
</html>
