<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>360 Issue Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="https://spyne-prod-ai.s3.us-east-1.amazonaws.com/ai-dataset/2025/favicon.ico" type="image/x-icon" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f8f9fa; margin: 0; padding: 20px; }
    .header-bar { position: fixed; top: 0; left: 0; right: 0; background: #fff; padding: 10px 0; text-align: center; font-weight: bold; font-size: 22px; z-index: 10000; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .tabs { position: fixed; top: 48px; left: 0; right: 0; background: #fff; display: flex; border-bottom: 2px solid #ccc; z-index: 10000; }
    .tab { padding: 12px 20px; cursor: pointer; font-weight: bold; color: #555; border-bottom: 3px solid transparent; user-select: none; }
    .tab.active { color: #007bff; border-color: #007bff; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .main-content { margin-top: 220px; padding: 0 20px; }
    .filters { position: fixed; top: 88px; left: 0; right: 0; background: #f8f9fa; padding: 10px 20px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; border-bottom: 1px solid #ccc; z-index: 9999; }
    .filters select, .filters button, .filters input { padding: 6px 10px; font-size: 14px; border-radius: 4px; border: 1px solid #ccc; cursor: pointer; }
    .summary-bar { position: fixed; top: 130px; left: 0; right: 0; background: #e2e6ea; z-index: 9998; padding: 10px 20px; display: flex; justify-content: space-between; font-weight: bold; border-top: 1px solid #ccc; border-bottom: 2px solid #ccc; }
    .summary-section { position: fixed; top: 175px; left: 0; right: 0; background: #fff; z-index: 9997; padding: 10px 20px; display: flex; gap: 20px; justify-content: center; border-bottom: 1px solid #ccc; font-weight: 600; user-select: none; }
    .summary-item { flex: 1; text-align: center; font-size: 16px; color: #333; }
    .summary-value { font-size: 22px; color: #007bff; display: block; margin-top: 4px; }
    .chart-row { display: flex; gap: 20px; justify-content: space-between; margin: 20px 0; flex-wrap: wrap; }
    .chart-box.issue { flex: 2; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    .chart-box.pie { flex: 1; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    .dual-table-row { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
    .full-width-table { flex: 1; max-height: 400px; overflow-y: auto; background: #fff; padding: 10px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    .bottom-row { display: flex; gap: 20px; flex-wrap: wrap; }
    .table-box { flex: 1; max-height: 320px; overflow-y: auto; background: #fff; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    .iframe-box { flex: 2; background: #fff; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); overflow: hidden; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px 12px; text-align: center; }
    th { background-color: #0057a3; color: white; position: sticky; top: 0; z-index: 1; }
    tr:nth-child(even) { background-color: #f2f2f2; }
    .summary-tables { margin-top: 30px; background: white; padding: 10px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    .chart-container { background: #fff; padding: 15px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); flex: 1; min-width: 300px; }
    canvas { width: 100% !important; height: auto !important; }
    .week-label { font-weight: bold; color: #0057a3; margin-bottom: 5px; }
  </style>
</head>
<body>
  <div class="header-bar">360 Issue Dashboard</div>
  <div class="filters" id="dashboardFilters">...</div>
  <div class="tabs">
    <div class="tab active" data-tab="dashboardTab">Dashboard</div>
    <div class="tab" data-tab="summaryTab">Summary</div>
    <div class="tab" data-tab="qcReportTab">QC Report</div>
  </div>
  <div class="main-content tab-content active" id="dashboardTab">
    <!-- Dashboard content remains the same -->
  </div>
  
  <!-- Summary Tab with Week-wise Data -->
  <div class="main-content tab-content" id="summaryTab">
    <div class="chart-row">
      <div class="chart-container">
        <h3>Severity Trend by Week (%)</h3>
        <canvas id="severityTrendChart"></canvas>
      </div>
      <div class="chart-container">
        <h3>Issue Trend by Week (%)</h3>
        <canvas id="issueTrendChart"></canvas>
      </div>
    </div>
    <div class="summary-tables">
      <h3>Severity Details (Week-wise)</h3>
      <table id="severityDetailsTable">
        <thead><tr id="severityDetailsHeader"><th onclick="sortTable(this)">Severity</th></tr></thead>
        <tbody id="severityDetailsBody"></tbody>
      </table>
      <h3>Issue Details (Week-wise)</h3>
      <table id="issueDetailsTable">
        <thead><tr id="issueDetailsHeader"><th onclick="sortTable(this)">Issue</th></tr></thead>
        <tbody id="issueDetailsBody"></tbody>
      </table>
    </div>
  </div>
  
  <div class="main-content tab-content" id="qcReportTab">
    <!-- QC Report content remains the same -->
  </div>
  
  <script>
    const qcSheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTaSxWZ-Y3M-wyNiCdN7FSH5kAMMy1cox7D_YRn2sWNkGfo1j4WCGbaedRXgnUKvELK5eAMv334UCaD/pub?gid=0&single=true&output=csv';
    const totalDataUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTmm6um2dDueAholFhs2olel5wv2mqH9f1jCAfdL8Qi76mzqbTfzu7OYRea5PwSJP0eD0RLuF6XOkTy/pub?gid=0&single=true&output=csv';

    let globalData = [];
    let totalDataGlobal = [];
    let weekLabels = [];
    let weekStartDates = [];

    // Helper to get week starting Monday for a given date
    function getWeekStart(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1); // adjust when day is Sunday
      return new Date(d.setDate(diff));
    }

    // Format date as "YYYY-MM-DD"
    function formatDate(date) {
      return date.toISOString().split('T')[0];
    }

    // Get week label as "Mon DD - Sun DD"
    function getWeekLabel(startDate) {
      const start = new Date(startDate);
      const end = new Date(start);
      end.setDate(start.getDate() + 6);
      
      const startStr = start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      const endStr = end.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      
      return `${startStr} - ${endStr}`;
    }

    // Generate week labels for the last 4 weeks
    function generateWeekLabels() {
      weekLabels = [];
      weekStartDates = [];
      const today = new Date();
      
      for (let i = 3; i >= 0; i--) {
        const weekStart = new Date(today);
        weekStart.setDate(today.getDate() - today.getDay() - 6 - (i * 7));
        weekStartDates.push(formatDate(weekStart));
        weekLabels.push(getWeekLabel(weekStart));
      }
    }

    // Get week index for a given date
    function getWeekIndex(dateStr) {
      const date = new Date(dateStr);
      for (let i = 0; i < weekStartDates.length; i++) {
        const weekStart = new Date(weekStartDates[i]);
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 6);
        
        if (date >= weekStart && date <= weekEnd) {
          return i;
        }
      }
      return -1; // Not in the last 4 weeks
    }

    // Render week-wise severity trend chart
    function renderSeverityTrendChart(data) {
      const severities = ['Blocker', 'High', 'Low'];
      const datasets = severities.map(severity => {
        const counts = weekLabels.map(() => 0);
        const totals = weekLabels.map(() => 0);
        
        data.forEach(row => {
          const weekIndex = getWeekIndex(row.Date);
          if (weekIndex >= 0 && row.Severity === severity) {
            counts[weekIndex]++;
            totals[weekIndex]++;
          } else if (weekIndex >= 0) {
            totals[weekIndex]++;
          }
        });
        
        const percentages = counts.map((count, i) => 
          totals[i] > 0 ? ((count / totals[i]) * 100).toFixed(1) : 0
        );
        
        return {
          label: severity,
          data: percentages,
          borderColor: severity === 'Blocker' ? '#FF6384' : 
                     severity === 'High' ? '#FF9F40' : '#36A2EB',
          fill: false,
          tension: 0.4
        };
      });
      
      new Chart(document.getElementById('severityTrendChart'), {
        type: 'line',
        data: {
          labels: weekLabels,
          datasets: datasets
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            title: {
              display: true,
              text: 'Severity Distribution by Week (%)'
            }
          },
          scales: {
            y: {
              min: 0,
              max: 100,
              ticks: {
                callback: function(value) {
                  return value + '%';
                }
              }
            }
          }
        }
      });
    }

    // Render week-wise issue trend chart
    function renderIssueTrendChart(data) {
      // Get top 5 issues
      const issueCounts = {};
      data.forEach(row => {
        const issue = row.Issue || 'Other';
        issueCounts[issue] = (issueCounts[issue] || 0) + 1;
      });
      
      const topIssues = Object.entries(issueCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5)
        .map(entry => entry[0]);
      
      const datasets = topIssues.map(issue => {
        const counts = weekLabels.map(() => 0);
        const totals = weekLabels.map(() => 0);
        
        data.forEach(row => {
          const weekIndex = getWeekIndex(row.Date);
          if (weekIndex >= 0) {
            totals[weekIndex]++;
            if (row.Issue === issue) {
              counts[weekIndex]++;
            }
          }
        });
        
        const percentages = counts.map((count, i) => 
          totals[i] > 0 ? ((count / totals[i]) * 100).toFixed(1) : 0
        );
        
        return {
          label: issue,
          data: percentages,
          borderColor: getRandomColor(),
          fill: false,
          tension: 0.4
        };
      });
      
      new Chart(document.getElementById('issueTrendChart'), {
        type: 'line',
        data: {
          labels: weekLabels,
          datasets: datasets
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            title: {
              display: true,
              text: 'Top 5 Issues by Week (%)'
            }
          },
          scales: {
            y: {
              min: 0,
              max: 100,
              ticks: {
                callback: function(value) {
                  return value + '%';
                }
              }
            }
          }
        }
      });
    }

    // Render week-wise severity details table
    function renderSeverityDetailsTable(data) {
      const header = document.getElementById('severityDetailsHeader');
      const body = document.getElementById('severityDetailsBody');
      const severities = ['Blocker', 'High', 'Low'];
      
      // Create header
      let headerHtml = '<th>Severity</th>';
      weekLabels.forEach(label => {
        headerHtml += `<th>${label}</th>`;
      });
      header.innerHTML = headerHtml;
      
      // Create body
      body.innerHTML = '';
      severities.forEach(severity => {
        const row = document.createElement('tr');
        let rowHtml = `<td>${severity}</td>`;
        
        weekLabels.forEach((_, weekIndex) => {
          let count = 0;
          let total = 0;
          
          data.forEach(row => {
            const rowWeekIndex = getWeekIndex(row.Date);
            if (rowWeekIndex === weekIndex) {
              total++;
              if (row.Severity === severity) {
                count++;
              }
            }
          });
          
          const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
          rowHtml += `<td>${count} <span style='font-size:0.8em;color:#888;'>(${percentage}%)</span></td>`;
        });
        
        row.innerHTML = rowHtml;
        body.appendChild(row);
      });
    }

    // Render week-wise issue details table
    function renderIssueDetailsTable(data) {
      const header = document.getElementById('issueDetailsHeader');
      const body = document.getElementById('issueDetailsBody');
      
      // Get top 10 issues
      const issueCounts = {};
      data.forEach(row => {
        const issue = row.Issue || 'Other';
        issueCounts[issue] = (issueCounts[issue] || 0) + 1;
      });
      
      const topIssues = Object.entries(issueCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10)
        .map(entry => entry[0]);
      
      // Create header
      let headerHtml = '<th>Issue</th>';
      weekLabels.forEach(label => {
        headerHtml += `<th>${label}</th>`;
      });
      header.innerHTML = headerHtml;
      
      // Create body
      body.innerHTML = '';
      topIssues.forEach(issue => {
        const row = document.createElement('tr');
        let rowHtml = `<td>${issue}</td>`;
        
        weekLabels.forEach((_, weekIndex) => {
          let count = 0;
          let total = 0;
          
          data.forEach(row => {
            const rowWeekIndex = getWeekIndex(row.Date);
            if (rowWeekIndex === weekIndex) {
              total++;
              if (row.Issue === issue) {
                count++;
              }
            }
          });
          
          const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
          rowHtml += `<td>${count} <span style='font-size:0.8em;color:#888;'>(${percentage}%)</span></td>`;
        });
        
        row.innerHTML = rowHtml;
        body.appendChild(row);
      });
    }

    // Helper function to generate random colors
    function getRandomColor() {
      const letters = '0123456789ABCDEF';
      let color = '#';
      for (let i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
      }
      return color;
    }

    // Tab switching functionality
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', function() {
        // Remove active class from all tabs and tab contents
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
        
        // Add active class to clicked tab and corresponding content
        this.classList.add('active');
        const tabContentId = this.dataset.tab;
        document.getElementById(tabContentId).classList.add('active');
        
        // If Summary tab is clicked, render week-wise data
        if (tabContentId === 'summaryTab') {
          generateWeekLabels();
          renderSeverityTrendChart(globalData);
          renderIssueTrendChart(globalData);
          renderSeverityDetailsTable(globalData);
          renderIssueDetailsTable(globalData);
        }
      });
    });

    // Data loading and initialization
    async function loadAndRender() {
      const [qcData, totalData] = await Promise.all([
        loadCSV('https://docs.google.com/spreadsheets/d/e/2PACX-1vQTc7M9RhXdcyXaJPPgedw4uWSTamAPlokhDyXfDMhPxEbJkd7Ff73QCBaSLmDjLAXGSZNrD_6QlDuD/pub?gid=0&single=true&output=csv'),
        loadCSV(totalDataUrl)
      ]);
      
      globalData = qcData;
      totalDataGlobal = totalData;
      
      // Add date fields if needed
      globalData.forEach(row => {
        if (!row.Date) {
          // Generate a random date in the last 4 weeks for demo
          const daysAgo = Math.floor(Math.random() * 28);
          const date = new Date();
          date.setDate(date.getDate() - daysAgo);
          row.Date = formatDate(date);
        }
      });
    }

    function loadCSV(url) {
      return fetch(url).then(res => res.text()).then(text =>
        new Promise(resolve => {
          Papa.parse(text, {
            header: true,
            skipEmptyLines: true,
            complete: results => resolve(results.data)
          });
        })
      );
    }

    // Initialize on page load
    window.onload = async () => {
      await loadAndRender();
      generateWeekLabels();
    };
  </script>
</body>
</html>
