<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>QC Review Dashboard</title>
  <link rel="icon" href="https://spyne-prod-ai.s3.us-east-1.amazonaws.com/ai-dataset/2025/logo/unnamed.png" type="image/x-icon"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
:root {
  --primary: #007BFF;
  --primary-dark: #0056b3;
  --bg: #f9fafb;
  --text: #333;
  --card-bg: #ffffff;
  --border: #ccc;
  --font: 'Segoe UI', sans-serif;
}
body {
  font-family: var(--font);
  margin: 0;
  padding: 0;
  background: var(--bg);
}
.container {
  width: 98%;
  margin: 20px auto;
  background: var(--card-bg);
  padding: 30px;
  border-radius: 12px;
  box-shadow: 0 0 12px rgba(0, 0, 0, 0.08);
  box-sizing: border-box;
}
h2 {
  color: var(--text);
  margin-bottom: 20px;
  font-size: 1.5rem;
}
label {
  font-weight: 600;
  display: block;
  margin-top: 15px;
  margin-bottom: 5px;
  font-size: 0.95rem;
}
select, input, textarea {
  padding: 10px;
  width: 100%;
  max-width: 300px;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 14px;
  box-sizing: border-box;
  font-family: var(--font);
}
textarea {
  width: 100%;
  height: 100px;
  resize: vertical;
}
button {
  background-color: var(--primary);
  color: white;
  border: none;
  padding: 10px 20px;
  font-size: 14px;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.3s;
}
button:hover {
  background-color: var(--primary-dark);
}
button:disabled {
  background-color: #cccccc;
  cursor: not-allowed;
}
.filters, .top-bar, .form-section {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  align-items: flex-start;
}
.top-bar div {
  min-width: 150px;
  flex: 1 1 30%;
  word-wrap: break-word;
  font-size: 0.95rem;
}
.images {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
  gap: 10px;
  margin: 20px 0;
}
.images img {
  width: 100%;
  aspect-ratio: 4 / 3;
  object-fit: cover;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: #f0f0f0;
  margin: 0;
  padding: 0;
}
.form-section {
  flex-direction: column;
  gap: 20px;
  margin-top: 20px;
  width: 100%;
}
.nav-buttons {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  justify-content: flex-start;
}
.nav-buttons button {
  min-width: 120px;
}
.source-toggle {
  display: flex;
  gap: 15px;
  margin-bottom: 20px;
}
.source-toggle label {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  font-weight: normal;
  margin-top: 0;
}
.source-toggle input {
  width: auto;
  max-width: none;
}
.loading {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(0,0,0,.3);
  border-radius: 50%;
  border-top-color: var(--primary);
  animation: spin 1s ease-in-out infinite;
  margin-left: 10px;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}
.status-message {
  margin-top: 10px;
  padding: 10px;
  border-radius: 4px;
}
.error {
  background-color: #ffebee;
  color: #c62828;
}
.success {
  background-color: #e8f5e9;
  color: #2e7d32;
}
@media screen and (max-width: 768px) {
  .top-bar div {
    flex: 1 1 100%;
  }
  .nav-buttons button {
    flex: 1 1 auto;
  }
  .images {
    grid-template-columns: 1fr;
  }
}
  </style>
</head>
<body>
  <div class="container" id="login-section">
    <h2>QC Review Login</h2>
    
    <div class="source-toggle">
      <label>
        <input type="radio" name="dataSource" value="qc" checked> QC-Pass
      </label>
      <label>
        <input type="radio" name="dataSource" value="edited"> Re-Edit
      </label>
      <label>
        <input type="radio" name="dataSource" value="qc_tool"> QC-Tool
      </label>
    </div>
    
    <label for="loginID">Login ID</label>
    <select id="loginID">
      <option value="">Select Login ID</option>
      <option>Nand Kishor</option>
      <option>Ranbir Manoranjan</option>
      <option>Nitin kumar</option>
      <option>Praveen Agarwal</option>
      <option>Raj Tripatrhi</option>
      <option>Rohit Chahuhan</option>
      <option>Saurabh Pandey</option>
    </select>
    <div class="filters">
      <div>
        <label>Date</label>
        <select id="dateFilter"><option value="">ALL</option></select>
      </div>
      <div>
        <label>Enterprise</label>
        <select id="enterpriseFilter"><option value="">ALL</option></select>
      </div>
      <div>
        <label>QC User</label>
        <select id="qcUserFilter"><option value="">ALL</option></select>
      </div>
      <div id="editingUserFilterContainer" style="display: none;">
        <label>Editing User</label>
        <select id="editingUserFilter"><option value="">ALL</option></select>
      </div>
      <div id="issueFilterContainer" style="display: none;">
        <label>Issue</label>
        <select id="issueFilter"><option value="">ALL</option></select>
      </div>
    </div>
    <button id="startButton" onclick="loadFilteredData()">Start QC</button>
    <div id="loadingIndicator" style="display: none;"><span class="loading"></span> Loading data...</div>
    <div id="statusMessage" class="status-message" style="display: none;"></div>
  </div>

  <div class="container" id="review-section" style="display:none">
    <h2>Review Details</h2>
    <div class="top-bar">
      <div><strong>User:</strong> <span id="userName"></span></div>
      <div><strong>QC Users:</strong> <span id="qcUsers"></span></div>
      <div><strong>Editing User:</strong> <span id="editingUser"></span></div>
      <div><strong>Enterprise:</strong> <span id="enterprise"></span></div>
      <div><strong>Date:</strong> <span id="date"></span></div>
      <div><strong>SKU ID:</strong> <span id="sku"></span></div>
      <div><strong>Image ID:</strong> <span id="imageID"></span></div>
      <div><strong>Issue:</strong> <span id="issue"></span></div>
    </div>
    <div class="images">
      <img id="left" src="" alt="Input Image">
      <img id="middle" src="" alt="AI Image">
      <img id="right" src="" alt="Final Image">
    </div>
    <div class="form-section">
      <div>
        <label for="qcComment">QC Comment</label>
        <textarea id="qcComment" placeholder="Write your comment here..."></textarea>
      </div>
      <div class="nav-buttons">
        <button onclick="prevEntry()">Previous</button>
        <button onclick="submitAndNext()">Next</button>
        <button onclick="exitToLogin()">Exit</button>
      </div>
    </div>
  </div>

<script>
const QC_PASS_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSWW7muoNyeY_1VOLhybuT7ChNHtkhAscxDikyiCPQChIWqi1m3KXsd9e0_i_UFE7bDrW_7kfH-vIhL/pub?gid=1717039169&single=true&output=csv";
const RE_EDIT_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSWW7muoNyeY_1VOLhybuT7ChNHtkhAscxDikyiCPQChIWqi1m3KXsd9e0_i_UFE7bDrW_7kfH-vIhL/pub?gid=320301246&single=true&output=csv";

// Field mapping configuration
const FIELD_MAPPING = {
  qc: {
    'enterprise': 'enterprise_name',
    't1.image_id': 'ai.image_id',
    't1.sku_id': 'sku_id',
    'left_path': 'input_image_hres_url',
    'middle_path': 'output_image_hres_url',
    'right_path': 'manual_image_hres_url',
    'user': 'qc_user_name',
    'first_qc_user': '',
    'last_qc_user': '',
    'last_editor_user': '',
    'issue': '',
    'date': 'qc_completed_time',
    'status': 'status'
  },
  edited: {
    'enterprise': 'enterprise_name',
    't1.image_id': 'ai.image_id',
    't1.sku_id': 'sku_id',
    'left_path': 'input_image_hres_url',
    'middle_path': 'ai_output',
    'right_path': 'final_output',
    'user': 'last_qc_user',
    'first_qc_user': 'first_qc_user',
    'last_qc_user': 'last_qc_user',
    'last_editor_user': 'last_editor_user',
    'issue': 'rejected_comments',
    'date': 'qc_completed_time',
    'status': 'status',
    'latest_image_action': 'latest_image_action'
  },
  qc_tool: {
    'enterprise': 'enterprise_name',
    't1.image_id': 'ai.image_id',
    't1.sku_id': 'sku_id',
    'left_path': 'input_image_hres_url',
    'middle_path': 'ai_output',
    'right_path': 'final_output',
    'user': 'last_qc_user',
    'first_qc_user': 'first_qc_user',
    'last_qc_user': 'last_qc_user',
    'last_editor_user': 'last_editor_user',
    'issue': 'rejected_comments',
    'date': 'qc_completed_time',
    'status': 'status',
    'latest_image_action': 'latest_image_action'
  }
};

let rawData = [];
let groupedData = [];
let currentIndex = 0;

function showLoading(show) {
  const button = document.getElementById('startButton');
  const loading = document.getElementById('loadingIndicator');
  if (show) {
    button.disabled = true;
    loading.style.display = 'block';
  } else {
    button.disabled = false;
    loading.style.display = 'none';
  }
}

function showStatus(message, isError = false) {
  const statusElement = document.getElementById('statusMessage');
  statusElement.textContent = message;
  statusElement.className = isError ? 'status-message error' : 'status-message success';
  statusElement.style.display = 'block';
  
  if (!isError) {
    setTimeout(() => {
      statusElement.style.display = 'none';
    }, 3000);
  }
}

function getDataSource() {
  const selected = document.querySelector('input[name="dataSource"]:checked');
  return selected ? selected.value : 'qc';
}

function getDataSourceUrl() {
  return getDataSource() === 'qc' ? QC_PASS_URL : RE_EDIT_URL;
}

function toggleAdditionalFilters() {
  const sourceType = getDataSource();
  const editingUserContainer = document.getElementById('editingUserFilterContainer');
  const issueContainer = document.getElementById('issueFilterContainer');
  
  if (sourceType === 'edited' || sourceType === 'qc_tool') {
    editingUserContainer.style.display = 'block';
    issueContainer.style.display = 'block';
  } else {
    editingUserContainer.style.display = 'none';
    issueContainer.style.display = 'none';
  }
}

function normalizeData(rawData, sourceType) {
  const mapping = FIELD_MAPPING[sourceType];
  return rawData.map(row => {
    const normalized = {};
    
    // Map all fields according to the configuration
    for (const [targetField, sourceField] of Object.entries(mapping)) {
      if (sourceField) {
        normalized[targetField] = row[sourceField] || '';
      }
    }
    
    // Ensure required fields exist
    normalized['status'] = normalized['status'] || '';
    
    return normalized;
  });
}

function loadFilteredData() {
  const loginID = document.getElementById('loginID').value.trim().toLowerCase();
  if (!loginID) {
    showStatus('Please select a Login ID', true);
    return;
  }

  showLoading(true);
  
  const date = document.getElementById('dateFilter').value.trim();
  const enterprise = document.getElementById('enterpriseFilter').value.trim().toLowerCase();
  const qcUser = document.getElementById('qcUserFilter').value.trim().toLowerCase();
  const editingUser = document.getElementById('editingUserFilter').value.trim().toLowerCase();
  const issue = document.getElementById('issueFilter').value.trim().toLowerCase();
  const sourceType = getDataSource();

  const filteredRaw = rawData.filter(row => {
    const rowDate = (row["date"] || '').trim();
    const rowEnterprise = (row["enterprise"] || '').trim().toLowerCase();
    const rowUser = (row["user"] || '').trim().toLowerCase();
    const rowEditingUser = (row["last_editor_user"] || '').trim().toLowerCase();
    const rowIssue = (row["issue"] || '').trim().toLowerCase();
    const status = (row["status"] || '').trim().toLowerCase();
    const latestImageAction = (row["latest_image_action"] || '').trim().toLowerCase();

    // Common filters for all data sources
    let shouldInclude = (
      status === '' &&
      (!date || rowDate === date) &&
      (!enterprise || rowEnterprise === enterprise) &&
      (!qcUser || rowUser === qcUser)
    );

    // Additional filters for Re-Edit and QC-Tool
    if (sourceType === 'edited' || sourceType === 'qc_tool') {
      shouldInclude = shouldInclude && 
        (!editingUser || rowEditingUser === editingUser) &&
        (!issue || rowIssue === issue);
    }

    // Additional filters based on data source
    if (sourceType === 'qc_tool') {
      shouldInclude = shouldInclude && (latestImageAction === 'qc_editingtool');
    } else if (sourceType === 'edited') {
      shouldInclude = shouldInclude && (latestImageAction !== 'qc_editingtool');
    }

    return shouldInclude;
  });

  const map = new Map();
  for (const row of filteredRaw) {
    const imageId = row["t1.image_id"];
    if (!imageId) continue;

    if (!map.has(imageId)) {
      map.set(imageId, {
        ...row,
        users: new Set([row["user"]]),
        issues: new Set([row["issue"]])
      });
    } else {
      const existing = map.get(imageId);
      existing.users.add(row["user"]);
      existing.issues.add(row["issue"]);
    }
  }

  groupedData = Array.from(map.values()).map(item => ({
    ...item,
    user: Array.from(item.users).filter(Boolean).join(", "),
    issue: Array.from(item.issues).filter(Boolean).join(", ")
  }));

  showLoading(false);

  if (groupedData.length > 0) {
    currentIndex = 0;
    showReview();
    document.getElementById("login-section").style.display = "none";
    document.getElementById("review-section").style.display = "block";
    showStatus(`Loaded ${groupedData.length} records to review`);
  } else {
    showStatus('No matching records found.', true);
  }
}

function showReview() {
  const row = groupedData[currentIndex];
  document.getElementById('userName').textContent = row["user"] || "N/A";
  
  // Format QC users with (1) and (2) if different
  const firstQC = row["first_qc_user"] || '';
  const lastQC = row["last_qc_user"] || '';
  let qcUsersDisplay = '';
  if (firstQC && lastQC) {
    if (firstQC === lastQC) {
      qcUsersDisplay = firstQC;
    } else {
      qcUsersDisplay = `${firstQC} (1), ${lastQC} (2)`;
    }
  } else if (firstQC) {
    qcUsersDisplay = firstQC;
  } else if (lastQC) {
    qcUsersDisplay = lastQC;
  }
  document.getElementById('qcUsers').textContent = qcUsersDisplay || "N/A";
  
  document.getElementById('editingUser').textContent = row["last_editor_user"] || "N/A";
  document.getElementById('enterprise').textContent = row["enterprise"] || "N/A";
  document.getElementById('date').textContent = row["date"] || "N/A";
  document.getElementById('sku').textContent = row["t1.sku_id"] || "N/A";
  document.getElementById('imageID').textContent = row["t1.image_id"] || "N/A";
  document.getElementById('issue').textContent = row["issue"] || "N/A";
  
  // Set image sources with error handling
  const setImage = (elementId, path) => {
    const img = document.getElementById(elementId);
    img.src = path || '';
    img.onerror = () => {
      img.src = 'https://via.placeholder.com/400x300?text=Image+Not+Available';
    };
  };
  
  setImage('left', row["left_path"]);
  setImage('middle', row["middle_path"]);
  setImage('right', row["right_path"]);
  
  document.getElementById('qcComment').value = "";
}

function submitAndNext() {
  const row = groupedData[currentIndex];
  const loginUser = document.getElementById('loginID').value || "";
  let comment = document.getElementById('qcComment').value.trim();
  if (!comment) comment = "Done";

  const url = new URL("https://docs.google.com/forms/d/e/1FAIpQLSdrjhynjWITfOqHpkgKX8enCmDKg1b3s0Ij05Cux36kPmZEUA/formResponse");
  const params = new URLSearchParams({
    "entry.890284089": row["enterprise"] || "",
    "entry.5932044": row["user"] || "",
    "entry.1139236247": row["t1.sku_id"] || "",
    "entry.661750446": row["t1.image_id"] || "",
    "entry.1317530325": row["issue"] || "",
    "entry.1455673211": row["left_path"] || "",
    "entry.772576827": row["middle_path"] || "",
    "entry.780536997": row["right_path"] || "",
    "entry.865196657": loginUser,
    "entry.778698303": comment
  });

  fetch(`${url}?${params.toString()}`, { method: 'POST', mode: 'no-cors' })
    .then(() => {
      if (currentIndex < groupedData.length - 1) {
        currentIndex++;
        showReview();
      } else {
        showStatus('All entries reviewed. Returning to login screen.');
        setTimeout(exitToLogin, 2000);
      }
    })
    .catch(error => {
      console.error('Submission error:', error);
      showStatus('Error submitting data', true);
    });
}

function prevEntry() {
  if (currentIndex > 0) {
    currentIndex--;
    showReview();
  }
}

function exitToLogin() {
  document.getElementById("review-section").style.display = "none";
  document.getElementById("login-section").style.display = "block";
}

document.addEventListener('keydown', function(event) {
  if (document.getElementById("review-section").style.display !== "none") {
    if (event.key === "Enter") {
      event.preventDefault();
      submitAndNext();
    } else if (event.key === "p" || event.key === "P") {
      event.preventDefault();
      prevEntry();
    } else if (event.key === "Escape") {
      event.preventDefault();
      exitToLogin();
    }
  }
});

function populateDropdowns(data) {
  const dates = new Set(), enterprises = new Set(), users = new Set();
  const editingUsers = new Set(), issues = new Set();
  
  data.forEach(row => {
    if (row["date"]) dates.add(row["date"]);
    if (row["enterprise"]) enterprises.add(row["enterprise"]);
    if (row["user"]) users.add(row["user"]);
    if (row["last_editor_user"]) editingUsers.add(row["last_editor_user"]);
    if (row["issue"]) issues.add(row["issue"]);
  });
  
  fillSelect("dateFilter", [...dates]);
  fillSelect("enterpriseFilter", [...enterprises]);
  fillSelect("qcUserFilter", [...users]);
  fillSelect("editingUserFilter", [...editingUsers]);
  fillSelect("issueFilter", [...issues]);
}

function fillSelect(id, options) {
  const select = document.getElementById(id);
  // Clear existing options except the first one
  while (select.options.length > 1) {
    select.remove(1);
  }
  options.sort().forEach(opt => {
    const option = document.createElement("option");
    option.value = opt;
    option.text = opt;
    select.appendChild(option);
  });
}

function loadData() {
  showLoading(true);
  const url = getDataSourceUrl();
  const sourceType = getDataSource();
  
  Papa.parse(url, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
      showLoading(false);
      if (results.data && results.data.length > 0) {
        rawData = normalizeData(results.data, sourceType);
        populateDropdowns(rawData);
        toggleAdditionalFilters();
        showStatus(`Successfully loaded ${rawData.length} records from ${sourceType === 'qc' ? 'QC-Pass' : sourceType === 'edited' ? 'Re-Edit' : 'QC-Tool'}`);
      } else {
        showStatus('No data found in the selected source', true);
      }
    },
    error: function(error) {
      showLoading(false);
      console.error("Error loading data:", error);
      showStatus('Error loading data. Please try again.', true);
    }
  });
}

// Listen for data source changes
document.querySelectorAll('input[name="dataSource"]').forEach(radio => {
  radio.addEventListener('change', function() {
    loadData();
    toggleAdditionalFilters();
  });
});

window.onload = () => {
  // Load initial data
  loadData();
};
</script>
</body>
</html>
