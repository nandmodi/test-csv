<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live User Tracking</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      position: relative;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border: 1px solid #ddd;
    }
    th {
      background-color: #f2f2f2;
    }
    .live {
      color: green;
    }
    .offline {
      color: red;
    }
    #live-time {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 16px;
      background-color: #f1f1f1;
      padding: 5px 10px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body>

  <h1>User Live Status</h1>

  <!-- Current live time display -->
  <div id="live-time"></div>

  <table>
    <thead>
      <tr>
        <th>User</th>
        <th>Last Log</th>
        <th>Status</th>
        <th>Time Difference (minutes)</th>
      </tr>
    </thead>
    <tbody id="user-status-table">
      <!-- Data will be populated dynamically -->
    </tbody>
  </table>

  <script>
    const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSo76L7XI-AHGphJRHyTXCwMVuizeUUfb23MlzOvKRJBXF4JccS_gl5koNEzy6I61crp7dLXYPvYP2W/pub?gid=0&single=true&output=csv';

    // Function to fetch the CSV data from the Google Sheet URL
    async function fetchData() {
      try {
        const response = await fetch(sheetUrl);
        const csvText = await response.text();
        const data = parseCSV(csvText);
        loadUserData(data);
      } catch (error) {
        console.error('Error fetching CSV:', error);
      }
    }

    // Function to parse CSV text into an array of objects
    function parseCSV(csvText) {
      const rows = csvText.split('\n').map(row => row.split(','));
      const headers = rows[0]; // The first row contains column names
      const data = rows.slice(1).map(row => {
        let userData = {};
        headers.forEach((header, index) => {
          userData[header.trim()] = row[index]?.trim();
        });
        return userData;
      });
      return data;
    }

    // Function to check if the user is live based on the last log time and current IST time
    function checkUserStatus(lastLog) {
      const userLastLogDate = new Date(lastLog); // Convert the last log time to a Date object
      
      // Adjust the current time to IST (Indian Standard Time)
      const istOffset = 5.5 * 60 * 60 * 1000; // IST offset is UTC+5:30
      const currentTime = new Date(new Date().getTime() + istOffset); // Current time in IST

      // Calculate the difference in minutes
      const diffMilliseconds = currentTime - userLastLogDate;
      const diffMinutes = diffMilliseconds / (1000 * 60); // Convert milliseconds to minutes

      // User is live if the difference is <= 4 minutes, else offline
      const status = diffMinutes <= 4 ? 'ðŸŸ¢' : 'ðŸ”´';
      return { status, diffMinutes, currentTime };
    }

    // Function to load and update user data in the table
    function loadUserData(data) {
      const tableBody = document.getElementById('user-status-table');
      data.forEach((user) => {
        const { status, diffMinutes } = checkUserStatus(user['Last Log']); // Check if the user is live based on 'Last Log'
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${user['User']}</td>
          <td>${user['Last Log']}</td>
          <td class="${status === 'ðŸŸ¢' ? 'live' : 'offline'}">${status}</td>
          <td>${diffMinutes.toFixed(2)}</td> <!-- Display difference in minutes -->
        `;
        tableBody.appendChild(row);
      });

      updateLiveTime();
    }

    // Function to update the live time on the page
    function updateLiveTime() {
      const istOffset = 5.5 * 60 * 60 * 1000; // IST offset is UTC+5:30
      const currentTime = new Date(new Date().getTime() + istOffset); // Current time in IST
      const hours = currentTime.getHours().toString().padStart(2, '0');
      const minutes = currentTime.getMinutes().toString().padStart(2, '0');
      const seconds = currentTime.getSeconds().toString().padStart(2, '0');
      const formattedTime = `${hours}:${minutes}:${seconds}`;

      const liveTimeElement = document.getElementById('live-time');
      liveTimeElement.textContent = `Current Live Time (IST): ${formattedTime}`;
    }

    // Call fetchData when the page loads
    fetchData();
    // Update the live time every second
    setInterval(updateLiveTime, 1000);
  </script>

</body>
</html>
