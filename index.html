<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>360 Issue Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="https://spyne-prod-ai.s3.us-east-1.amazonaws.com/ai-dataset/2025/favicon.ico" type="image/x-icon" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: #f5f7fa; 
      margin: 0; 
      padding: 20px; 
      color: #333;
    }
    .header-bar { 
      position: fixed; 
      top: 0; 
      left: 0; 
      right: 0; 
      background: linear-gradient(135deg, #0057a3, #003d75); 
      padding: 15px 0; 
      text-align: center; 
      font-weight: bold; 
      font-size: 24px; 
      z-index: 10000; 
      box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
      color: white;
    }
    .tabs { 
      position: fixed; 
      top: 64px; 
      left: 0; 
      right: 0; 
      background: #fff; 
      display: flex; 
      border-bottom: 2px solid #ddd; 
      z-index: 10000; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .tab { 
      padding: 14px 25px; 
      cursor: pointer; 
      font-weight: 600; 
      color: #555; 
      border-bottom: 3px solid transparent; 
      user-select: none; 
      transition: all 0.3s ease;
    }
    .tab:hover { 
      background-color: #f0f5ff; 
      color: #007bff;
    }
    .tab.active { 
      color: #007bff; 
      border-color: #007bff; 
      background-color: #e6f0ff;
    }
    .tab-content { 
      display: none; 
    }
    .tab-content.active { 
      display: block; 
    }
    .main-content { 
      margin-top: 200px; 
      padding: 0 20px; 
    }
    .filters { 
      position: fixed; 
      top: 110px; 
      left: 0; 
      right: 0; 
      background: #fff; 
      padding: 15px 20px; 
      display: flex; 
      flex-wrap: wrap; 
      gap: 15px; 
      justify-content: center; 
      border-bottom: 1px solid #ddd; 
      z-index: 9999; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .filters select, .filters button, .filters input { 
      padding: 8px 15px; 
      font-size: 14px; 
      border-radius: 6px; 
      border: 1px solid #ccc; 
      cursor: pointer; 
      background: white;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .filters select { 
      min-width: 200px; 
    }
    .summary-bar { 
      position: fixed; 
      top: 165px; 
      left: 0; 
      right: 0; 
      background: #e2e6ea; 
      z-index: 9998; 
      padding: 12px 20px; 
      display: flex; 
      justify-content: space-between; 
      font-weight: bold; 
      border-top: 1px solid #ccc; 
      border-bottom: 2px solid #ccc; 
    }
    .summary-section { 
      position: fixed; 
      top: 210px; 
      left: 0; 
      right: 0; 
      background: #fff; 
      z-index: 9997; 
      padding: 15px 20px; 
      display: flex; 
      gap: 25px; 
      justify-content: center; 
      border-bottom: 1px solid #ddd; 
      font-weight: 600; 
      user-select: none; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .summary-item { 
      flex: 1; 
      text-align: center; 
      font-size: 16px; 
      color: #333; 
    }
    .summary-value { 
      font-size: 24px; 
      color: #007bff; 
      display: block; 
      margin-top: 8px; 
      font-weight: bold;
    }
    .chart-row { 
      display: flex; 
      gap: 25px; 
      justify-content: space-between; 
      margin: 25px 0; 
      flex-wrap: wrap; 
    }
    .chart-box.issue { 
      flex: 2; 
      background: #fff; 
      padding: 25px; 
      border-radius: 12px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
      min-width: 500px;
    }
    .chart-box.pie { 
      flex: 1; 
      background: #fff; 
      padding: 25px; 
      border-radius: 12px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
      min-width: 300px;
    }
    .dual-table-row { 
      display: flex; 
      gap: 25px; 
      margin-bottom: 25px; 
      flex-wrap: wrap; 
    }
    .full-width-table { 
      flex: 1; 
      max-height: 400px; 
      overflow-y: auto; 
      background: #fff; 
      padding: 15px; 
      border-radius: 12px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
      min-width: 500px;
    }
    .bottom-row { 
      display: flex; 
      gap: 25px; 
      flex-wrap: wrap; 
    }
    .table-box { 
      flex: 1; 
      max-height: 350px; 
      overflow-y: auto; 
      background: #fff; 
      border-radius: 12px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
      min-width: 300px;
    }
    .iframe-box { 
      flex: 2; 
      background: #fff; 
      border-radius: 12px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
      overflow: hidden; 
      min-width: 500px;
    }
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 15px; 
    }
    th, td { 
      border: 1px solid #e0e0e0; 
      padding: 12px 15px; 
      text-align: center; 
    }
    th { 
      background: linear-gradient(to bottom, #0057a3, #004a8a); 
      color: white; 
      position: sticky; 
      top: 0; 
      z-index: 1; 
      font-weight: 600;
    }
    tr:nth-child(even) { 
      background-color: #f8fafd; 
    }
    tr:hover {
      background-color: #eef5ff;
    }
    .summary-tables { 
      margin-top: 35px; 
      background: white; 
      padding: 20px; 
      border-radius: 12px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
    }
    .chart-container { 
      background: #fff; 
      padding: 20px; 
      border-radius: 12px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
      flex: 1; 
      min-width: 400px; 
    }
    canvas { 
      width: 100% !important; 
      height: auto !important; 
    }
    .week-label { 
      font-weight: bold; 
      color: #0057a3; 
      margin-bottom: 5px; 
    }
    h3 {
      color: #004a8a;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 10px;
      margin-top: 0;
    }
    .clickable {
      cursor: pointer;
      color: #007bff;
      text-decoration: underline;
    }
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0, 87, 163, 0.3);
      border-radius: 50%;
      border-top-color: #0057a3;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .status-message {
      text-align: center;
      padding: 20px;
      color: #666;
    }
    .last-updated {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 12px;
      color: #777;
    }
    .mtd-container {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      padding: 20px;
      margin-top: 25px;
    }
    .mtd-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    .mtd-title {
      font-size: 18px;
      font-weight: bold;
      color: #0057a3;
    }
    .mtd-summary {
      display: flex;
      justify-content: space-around;
      text-align: center;
      margin-bottom: 20px;
    }
    .mtd-item {
      flex: 1;
    }
    .mtd-value {
      font-size: 24px;
      font-weight: bold;
      color: #007bff;
    }
    .mtd-label {
      font-size: 14px;
      color: #666;
    }
    .mtd-tables {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    .mtd-table-container {
      flex: 1;
      min-width: 300px;
      background: #f9fbfd;
      border-radius: 8px;
      padding: 15px;
      box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
    }
    .mtd-table-title {
      text-align: center;
      font-weight: bold;
      margin-bottom: 10px;
      color: #0057a3;
    }
    .mtd-table {
      width: 100%;
      border-collapse: collapse;
    }
    .mtd-table th {
      background: #e6f0ff;
      color: #004a8a;
      padding: 8px;
      font-size: 14px;
    }
    .mtd-table td {
      padding: 8px;
      border-bottom: 1px solid #eee;
    }
    .mtd-table tr:last-child td {
      border-bottom: none;
    }
    .severity-Blocker {
      color: #ff0000;
      font-weight: bold;
    }
    .severity-High {
      color: #ff8800;
      font-weight: bold;
    }
    .severity-Low {
      color: #008800;
    }
  </style>
</head>
<body>
  <div class="header-bar">360 Issue Dashboard</div>
  <div class="last-updated" id="lastUpdated"></div>
  
  <div class="filters" id="dashboardFilters">
    <select id="enterpriseFilter">
      <option value="">All Enterprises</option>
    </select>
    <select id="severityFilter">
      <option value="">All Severities</option>
      <option>Blocker</option>
      <option>High</option>
      <option>Low</option>
    </select>
    <select id="issueFilter">
      <option value="">All Issues</option>
    </select>
    <button onclick="applyFiltersForDashboard()">Apply Filters</button>
    <button onclick="resetFilters()">Reset</button>
  </div>
  
  <div class="tabs">
    <div class="tab active" data-tab="dashboardTab">Dashboard</div>
    <div class="tab" data-tab="summaryTab">Summary</div>
    <div class="tab" data-tab="qcReportTab">QC Report</div>
  </div>
  
  <div class="main-content tab-content active" id="dashboardTab">
    <div class="summary-section">
      <div class="summary-item">Total Issues <span class="summary-value" id="totalIssues">0</span></div>
      <div class="summary-item">Blocker <span class="summary-value" id="blockerCount">0</span></div>
      <div class="summary-item">High <span class="summary-value" id="highCount">0</span></div>
      <div class="summary-item">Low <span class="summary-value" id="lowCount">0</span></div>
    </div>
    
    <div class="chart-row">
      <div class="chart-box issue">
        <h3>Issue Distribution</h3>
        <canvas id="issueChart"></canvas>
      </div>
      <div class="chart-box pie">
        <h3>Severity Distribution</h3>
        <canvas id="severityPie"></canvas>
      </div>
    </div>
    
    <div class="dual-table-row">
      <div class="full-width-table">
        <h3>Issue Summary</h3>
        <table id="issueSummary">
          <thead>
            <tr>
              <th>Issue</th><th>Total (%)</th><th>Blocker (%)</th><th>High (%)</th><th>Low (%)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="full-width-table">
        <h3>Enterprise Summary</h3>
        <table id="enterpriseSummary">
          <thead>
            <tr>
              <th>Enterprise</th><th>Total (%)</th><th>Blocker (%)</th><th>High (%)</th><th>Low (%)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    
    <div class="bottom-row">
      <div class="table-box">
        <h3>Recent Issues</h3>
        <table id="spinTable">
          <thead>
            <tr>
              <th>Spin ID</th><th>Issue</th><th>Severity</th><th>Enterprise</th><th>Date</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="iframe-box">
        <h3>Spin Preview</h3>
        <iframe id="spinIframe" title="Spin Preview" style="width:100%; height:500px; border:none;"></iframe>
      </div>
    </div>
  </div>
  
  <div class="main-content tab-content" id="summaryTab">
    <div class="status-message" id="summaryStatus">
      <div class="spinner"></div> Loading summary data...
    </div>
    
    <div class="summary-section" id="mtdSummary" style="display: none;">
      <div class="summary-item">MTD Total Issues <span class="summary-value" id="mtdTotalIssues">0</span></div>
      <div class="summary-item">MTD Blocker <span class="summary-value" id="mtdBlockerCount">0</span></div>
      <div class="summary-item">MTD High <span class="summary-value" id="mtdHighCount">0</span></div>
      <div class="summary-item">MTD Low <span class="summary-value" id="mtdLowCount">0</span></div>
    </div>
    
    <div class="chart-row" style="display:none;" id="summaryCharts">
      <div class="chart-container">
        <h3>Severity Trend by Week (%)</h3>
        <canvas id="severityTrendChart"></canvas>
      </div>
      <div class="chart-container">
        <h3>Issue Trend by Week (%)</h3>
        <canvas id="issueTrendChart"></canvas>
      </div>
    </div>
    
    <div class="summary-tables" style="display:none;" id="summaryTables">
      <h3>Severity Details (Week-wise)</h3>
      <table id="severityDetailsTable">
        <thead><tr id="severityDetailsHeader"></tr></thead>
        <tbody id="severityDetailsBody"></tbody>
      </table>
      
      <h3>Issue Details (Week-wise)</h3>
      <table id="issueDetailsTable">
        <thead><tr id="issueDetailsHeader"></tr></thead>
        <tbody id="issueDetailsBody"></tbody>
      </table>
    </div>
    
    <div class="mtd-container" id="mtdContainer" style="display: none;">
      <div class="mtd-header">
        <div class="mtd-title">Month Till Date (MTD) Analysis</div>
        <div class="mtd-date-range" id="mtdDateRange"></div>
      </div>
      
      <div class="mtd-summary">
        <div class="mtd-item">
          <div class="mtd-value" id="mtdTotal">0</div>
          <div class="mtd-label">Total Issues</div>
        </div>
        <div class="mtd-item">
          <div class="mtd-value" id="mtdBlocker">0</div>
          <div class="mtd-label">Blocker Issues</div>
        </div>
        <div class="mtd-item">
          <div class="mtd-value" id="mtdHigh">0</div>
          <div class="mtd-label">High Issues</div>
        </div>
        <div class="mtd-item">
          <div class="mtd-value" id="mtdLow">0</div>
          <div class="mtd-label">Low Issues</div>
        </div>
      </div>
      
      <div class="mtd-tables">
        <div class="mtd-table-container">
          <div class="mtd-table-title">Top Issues This Month</div>
          <table class="mtd-table" id="mtdIssueTable">
            <thead>
              <tr>
                <th>Issue</th>
                <th>Count</th>
                <th>% of Total</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        
        <div class="mtd-table-container">
          <div class="mtd-table-title">Top Enterprises This Month</div>
          <table class="mtd-table" id="mtdEnterpriseTable">
            <thead>
              <tr>
                <th>Enterprise</th>
                <th>Count</th>
                <th>% of Total</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  <div class="main-content tab-content" id="qcReportTab">
    <div class="status-message" id="qcStatus">
      <div class="spinner"></div> Loading QC report data...
    </div>
    
    <div style="display:none;" id="qcContent">
      <!-- QC Report content remains unchanged -->
    </div>
  </div>
  
  <script>
    // Configuration
    const qcSheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQTc7M9RhXdcyXaJPPgedw4uWSTamAPlokhDyXfDMhPxEbJkd7Ff73QCBaSLmDjLAXGSZNrD_6QlDuD/pub?gid=0&single=true&output=csv';
    const totalDataUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTmm6um2dDueAholFhs2olel5wv2mqH9f1jCAfdL8Qi76mzqbTfzu7OYRea5PwSJP0eD0RLuF6XOkTy/pub?gid=0&single=true&output=csv';
    
    // Global data storage
    let globalData = [];
    let filteredData = [];
    let weekLabels = [];
    let weekStartDates = [];
    let lastUpdated = new Date();
    
    // Helper to get week starting Monday for a given date
    function getWeekStart(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1); // adjust when day is Sunday
      return new Date(d.setDate(diff));
    }
    
    // Format date as "YYYY-MM-DD"
    function formatDate(date) {
      return date.toISOString().split('T')[0];
    }
    
    // Get week label as "Mon DD - Sun DD"
    function getWeekLabel(startDate) {
      const start = new Date(startDate);
      const end = new Date(start);
      end.setDate(start.getDate() + 6);
      
      const startStr = start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      const endStr = end.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      
      return `${startStr} - ${endStr}`;
    }
    
    // Generate week labels for the last 4 weeks
    function generateWeekLabels() {
      weekLabels = [];
      weekStartDates = [];
      const today = new Date();
      
      // Start from the most recent Monday
      const lastMonday = getWeekStart(today);
      
      for (let i = 0; i < 4; i++) {
        const weekStart = new Date(lastMonday);
        weekStart.setDate(lastMonday.getDate() - (i * 7));
        weekStartDates.push(formatDate(weekStart));
        weekLabels.push(getWeekLabel(weekStart));
      }
      
      // Reverse so the most recent week is last
      weekLabels.reverse();
      weekStartDates.reverse();
    }
    
    // Improved date parsing for spreadsheet format (MM/DD/YYYY)
    function parseSpreadsheetDate(dateStr) {
      const parts = dateStr.split('/');
      if (parts.length === 3) {
        return new Date(parts[2], parts[0] - 1, parts[1]);
      }
      return new Date(dateStr);
    }
    
    // Get week index for a given date
    function getWeekIndex(dateStr) {
      const date = parseSpreadsheetDate(dateStr);
      if (isNaN(date.getTime())) return -1;
      
      for (let i = 0; i < weekStartDates.length; i++) {
        const weekStart = new Date(weekStartDates[i]);
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 6);
        
        if (date >= weekStart && date <= weekEnd) {
          return i;
        }
      }
      return -1; // Not in the last 4 weeks
    }
    
    // Render week-wise severity trend chart
    function renderSeverityTrendChart(data) {
      const severities = ['Blocker', 'High', 'Low'];
      const datasets = severities.map(severity => {
        const counts = weekLabels.map(() => 0);
        const totals = weekLabels.map(() => 0);
        
        data.forEach(row => {
          const weekIndex = getWeekIndex(row.Date);
          if (weekIndex >= 0 && row.Severity === severity) {
            counts[weekIndex]++;
            totals[weekIndex]++;
          } else if (weekIndex >= 0) {
            totals[weekIndex]++;
          }
        });
        
        const percentages = counts.map((count, i) => 
          totals[i] > 0 ? ((count / totals[i]) * 100).toFixed(1) : 0
        );
        
        return {
          label: severity,
          data: percentages,
          borderColor: severity === 'Blocker' ? '#FF6384' : 
                     severity === 'High' ? '#FF9F40' : '#36A2EB',
          backgroundColor: severity === 'Blocker' ? 'rgba(255, 99, 132, 0.2)' : 
                          severity === 'High' ? 'rgba(255, 159, 64, 0.2)' : 'rgba(54, 162, 235, 0.2)',
          borderWidth: 2,
          fill: false,
          tension: 0.3
        };
      });
      
      const ctx = document.getElementById('severityTrendChart').getContext('2d');
      if (ctx) {
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: weekLabels,
            datasets: datasets
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'top' },
              title: {
                display: true,
                text: 'Severity Distribution by Week (%)',
                font: { size: 16 }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return `${context.dataset.label}: ${context.parsed.y}%`;
                  }
                }
              }
            },
            scales: {
              y: {
                min: 0,
                max: 100,
                ticks: {
                  callback: function(value) {
                    return value + '%';
                  }
                }
              }
            }
          }
        });
      }
    }
    
    // Render week-wise issue trend chart
    function renderIssueTrendChart(data) {
      // Get top 5 issues
      const issueCounts = {};
      data.forEach(row => {
        const issue = row.Issue || 'Other';
        issueCounts[issue] = (issueCounts[issue] || 0) + 1;
      });
      
      const topIssues = Object.entries(issueCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5)
        .map(entry => entry[0]);
      
      const datasets = topIssues.map(issue => {
        const counts = weekLabels.map(() => 0);
        const totals = weekLabels.map(() => 0);
        
        data.forEach(row => {
          const weekIndex = getWeekIndex(row.Date);
          if (weekIndex >= 0) {
            totals[weekIndex]++;
            if (row.Issue === issue) {
              counts[weekIndex]++;
            }
          }
        });
        
        const percentages = counts.map((count, i) => 
          totals[i] > 0 ? ((count / totals[i]) * 100).toFixed(1) : 0
        );
        
        return {
          label: issue,
          data: percentages,
          borderColor: getRandomColor(),
          borderWidth: 2,
          fill: false,
          tension: 0.3
        };
      });
      
      const ctx = document.getElementById('issueTrendChart').getContext('2d');
      if (ctx) {
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: weekLabels,
            datasets: datasets
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'top' },
              title: {
                display: true,
                text: 'Top 5 Issues by Week (%)',
                font: { size: 16 }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return `${context.dataset.label}: ${context.parsed.y}%`;
                  }
                }
              }
            },
            scales: {
              y: {
                min: 0,
                max: 100,
                ticks: {
                  callback: function(value) {
                    return value + '%';
                  }
                }
              }
            }
          }
        });
      }
    }
    
    // Render week-wise severity details table
    function renderSeverityDetailsTable(data) {
      const header = document.getElementById('severityDetailsHeader');
      const body = document.getElementById('severityDetailsBody');
      const severities = ['Blocker', 'High', 'Low'];
      
      if (header && body) {
        // Create header
        let headerHtml = '<th>Severity</th>';
        weekLabels.forEach(label => {
          headerHtml += `<th>${label}</th>`;
        });
        header.innerHTML = headerHtml;
        
        // Create body
        body.innerHTML = '';
        severities.forEach(severity => {
          const row = document.createElement('tr');
          let rowHtml = `<td style="font-weight:bold;">${severity}</td>`;
          
          weekLabels.forEach((_, weekIndex) => {
            let count = 0;
            let total = 0;
            
            data.forEach(row => {
              const rowWeekIndex = getWeekIndex(row.Date);
              if (rowWeekIndex === weekIndex) {
                total++;
                if (row.Severity === severity) {
                  count++;
                }
              }
            });
            
            const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
            rowHtml += `<td>${count} <span style='font-size:0.9em;color:#888;'>(${percentage}%)</span></td>`;
          });
          
          row.innerHTML = rowHtml;
          body.appendChild(row);
        });
      }
    }
    
    // Render week-wise issue details table
    function renderIssueDetailsTable(data) {
      const header = document.getElementById('issueDetailsHeader');
      const body = document.getElementById('issueDetailsBody');
      
      if (header && body) {
        // Get top 10 issues
        const issueCounts = {};
        data.forEach(row => {
          const issue = row.Issue || 'Other';
          issueCounts[issue] = (issueCounts[issue] || 0) + 1;
        });
        
        const topIssues = Object.entries(issueCounts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 10)
          .map(entry => entry[0]);
        
        // Create header
        let headerHtml = '<th>Issue</th>';
        weekLabels.forEach(label => {
          headerHtml += `<th>${label}</th>`;
        });
        header.innerHTML = headerHtml;
        
        // Create body
        body.innerHTML = '';
        topIssues.forEach(issue => {
          const row = document.createElement('tr');
          let rowHtml = `<td style="font-weight:bold;">${issue}</td>`;
          
          weekLabels.forEach((_, weekIndex) => {
            let count = 0;
            let total = 0;
            
            data.forEach(row => {
              const rowWeekIndex = getWeekIndex(row.Date);
              if (rowWeekIndex === weekIndex) {
                total++;
                if (row.Issue === issue) {
                  count++;
                }
              }
            });
            
            const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
            rowHtml += `<td>${count} <span style='font-size:0.9em;color:#888;'>(${percentage}%)</span></td>`;
          });
          
          row.innerHTML = rowHtml;
          body.appendChild(row);
        });
      }
    }
    
    // Helper function to generate random colors
    function getRandomColor() {
      const letters = '0123456789ABCDEF';
      let color = '#';
      for (let i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
      }
      return color;
    }
    
    // Tab switching functionality
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', function() {
        // Remove active class from all tabs and tab contents
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
        
        // Add active class to clicked tab and corresponding content
        this.classList.add('active');
        const tabContentId = this.dataset.tab;
        document.getElementById(tabContentId).classList.add('active');
        
        // If Summary tab is clicked, render week-wise data
        if (tabContentId === 'summaryTab') {
          generateWeekLabels();
          renderSeverityTrendChart(filteredData);
          renderIssueTrendChart(filteredData);
          renderSeverityDetailsTable(filteredData);
          renderIssueDetailsTable(filteredData);
          updateMTDSummary(filteredData);
        }
      });
    });
    
    // Data loading and initialization
    async function loadAndRender() {
      try {
        document.getElementById('lastUpdated').textContent = 'Loading data...';
        
        // Load data from Google Sheets
        const [qcData, totalData] = await Promise.all([
          loadCSV(qcSheetUrl),
          loadCSV(totalDataUrl)
        ]);
        
        globalData = qcData;
        filteredData = [...globalData];
        
        lastUpdated = new Date();
        document.getElementById('lastUpdated').textContent = `Last updated: ${lastUpdated.toLocaleTimeString()}`;
        
        // Update filters
        updateFilters();
        
        // Render initial dashboard
        applyFiltersForDashboard();
        
        // Hide loading messages and show content
        document.getElementById('summaryStatus').style.display = 'none';
        document.getElementById('summaryCharts').style.display = 'flex';
        document.getElementById('summaryTables').style.display = 'block';
        document.getElementById('mtdSummary').style.display = 'flex';
        document.getElementById('mtdContainer').style.display = 'block';
        
        document.getElementById('qcStatus').style.display = 'none';
        document.getElementById('qcContent').style.display = 'block';
        
      } catch (error) {
        console.error('Error loading data:', error);
        document.getElementById('lastUpdated').textContent = 'Error loading data';
      }
    }
    
    function loadCSV(url) {
      return fetch(url).then(res => res.text()).then(text =>
        new Promise(resolve => {
          Papa.parse(text, {
            header: true,
            skipEmptyLines: true,
            complete: results => resolve(results.data)
          });
        })
      );
    }
    
    function updateFilters() {
      // Update enterprise filter
      const enterprises = [...new Set(globalData.map(row => row.Enterprise))];
      const enterpriseSelect = document.getElementById('enterpriseFilter');
      enterpriseSelect.innerHTML = '<option value="">All Enterprises</option>';
      enterprises.forEach(ent => {
        if (ent) enterpriseSelect.innerHTML += `<option value="${ent}">${ent}</option>`;
      });
      
      // Update issue filter
      const issues = [...new Set(globalData.map(row => row.Issue))];
      const issueSelect = document.getElementById('issueFilter');
      issueSelect.innerHTML = '<option value="">All Issues</option>';
      issues.forEach(issue => {
        if (issue) issueSelect.innerHTML += `<option value="${issue}">${issue}</option>`;
      });
    }
    
    function applyFiltersForDashboard() {
      const enterprise = document.getElementById('enterpriseFilter').value;
      const severity = document.getElementById('severityFilter').value;
      const issue = document.getElementById('issueFilter').value;
      
      filteredData = globalData.filter(row => {
        return (!enterprise || row.Enterprise === enterprise) &&
               (!severity || row.Severity === severity) &&
               (!issue || row.Issue === issue);
      });
      
      renderDashboard();
    }
    
    function resetFilters() {
      document.getElementById('enterpriseFilter').value = '';
      document.getElementById('severityFilter').value = '';
      document.getElementById('issueFilter').value = '';
      applyFiltersForDashboard();
    }
    
    function renderDashboard() {
      // Update summary counts
      const blockerCount = filteredData.filter(row => row.Severity === 'Blocker').length;
      const highCount = filteredData.filter(row => row.Severity === 'High').length;
      const lowCount = filteredData.filter(row => row.Severity === 'Low').length;
      
      document.getElementById('totalIssues').textContent = filteredData.length;
      document.getElementById('blockerCount').textContent = blockerCount;
      document.getElementById('highCount').textContent = highCount;
      document.getElementById('lowCount').textContent = lowCount;
      
      // Render charts
      renderPieChart(filteredData);
      renderBarChart(filteredData);
      
      // Render tables
      renderIssueTable(filteredData);
      renderEnterpriseIssueTable(filteredData);
      renderSpinTable(filteredData);
    }
    
    function renderPieChart(data) {
      const sevCount = { Blocker: 0, High: 0, Low: 0 };
      data.forEach(row => sevCount[row['Severity']] = (sevCount[row['Severity']] || 0) + 1);
      
      const ctx = document.getElementById('severityPie').getContext('2d');
      if (ctx) {
        new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: Object.keys(sevCount),
            datasets: [{
              data: Object.values(sevCount), 
              backgroundColor: ['#FF6384', '#FF9F40', '#36A2EB'],
              borderWidth: 1
            }]
          },
          options: { 
            plugins: { 
              legend: { position: 'right' },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const value = context.parsed;
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = Math.round((value / total) * 100);
                    return `${context.label}: ${value} (${percentage}%)`;
                  }
                }
              }
            } 
          }
        });
      }
    }
    
    function renderBarChart(data) {
      const issueCounts = {};
      data.forEach(row => {
        const issue = row['Issue'] || 'Other';
        issueCounts[issue] = (issueCounts[issue] || 0) + 1;
      });
      
      // Sort issues by count
      const sortedIssues = Object.entries(issueCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10); // Limit to top 10
      
      const issueNames = sortedIssues.map(item => item[0]);
      const issueValues = sortedIssues.map(item => item[1]);
      
      const ctx = document.getElementById('issueChart').getContext('2d');
      if (ctx) {
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: issueNames,
            datasets: [{
              label: 'Issue Count', 
              data: issueValues, 
              backgroundColor: '#007bff',
              borderWidth: 1
            }]
          },
          options: { 
            scales: { 
              y: { 
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Number of Issues'
                }
              },
              x: {
                title: {
                  display: true,
                  text: 'Issue Type'
                }
              }
            },
            plugins: {
              legend: {
                display: false
              }
            }
          }
        });
      }
    }
    
    function renderIssueTable(data) {
      const tbody = document.getElementById('issueSummary').querySelector('tbody');
      const issueMap = {};
      data.forEach(row => {
        const issue = row['Issue'] || 'Other';
        const sev = row['Severity'] || 'Low';
        if (!issueMap[issue]) issueMap[issue] = { Blocker: 0, High: 0, Low: 0, Total: 0 };
        issueMap[issue][sev]++;
        issueMap[issue].Total++;
      });
      
      if (tbody) {
        tbody.innerHTML = '';
        const total = data.length;
        
        // Sort issues by total count
        const sortedIssues = Object.entries(issueMap)
          .sort((a, b) => b[1].Total - a[1].Total);
        
        sortedIssues.forEach(([issue, s]) => {
          tbody.innerHTML += `<tr>
            <td>${issue}</td>
            <td><b>${((s.Total / total) * 100).toFixed(1)}%</b> <span style="font-size: 0.9em; color: #666;">(${s.Total})</span></td>
            <td><b>${((s.Blocker / s.Total) * 100).toFixed(1)}%</b> <span style="font-size: 0.9em; color: #666;">(${s.Blocker})</span></td>
            <td><b>${((s.High / s.Total) * 100).toFixed(1)}%</b> <span style="font-size: 0.9em; color: #666;">(${s.High})</span></td>
            <td><b>${((s.Low / s.Total) * 100).toFixed(1)}%</b> <span style="font-size: 0.9em; color: #666;">(${s.Low})</span></td>
          </tr>`;
        });
      }
    }
    
    function renderEnterpriseIssueTable(data) {
      const tbody = document.getElementById('enterpriseSummary').querySelector('tbody');
      const enterpriseMap = {};
      data.forEach(row => {
        const ent = row['Enterprise'] || 'Unknown';
        const sev = row['Severity'] || 'Low';
        if (!enterpriseMap[ent]) enterpriseMap[ent] = { Blocker: 0, High: 0, Low: 0, Total: 0 };
        enterpriseMap[ent][sev]++;
        enterpriseMap[ent].Total++;
      });
      
      if (tbody) {
        tbody.innerHTML = '';
        const total = data.length;
        
        // Sort enterprises by total count
        const sortedEnterprises = Object.entries(enterpriseMap)
          .sort((a, b) => b[1].Total - a[1].Total);
        
        sortedEnterprises.forEach(([ent, s]) => {
          tbody.innerHTML += `<tr>
            <td>${ent}</td>
            <td><b>${((s.Total / total) * 100).toFixed(1)}%</b> <span style="font-size: 0.9em; color: #666;">(${s.Total})</span></td>
            <td><b>${((s.Blocker / s.Total) * 100).toFixed(1)}%</b> <span style="font-size: 0.9em; color: #666;">(${s.Blocker})</span></td>
            <td><b>${((s.High / s.Total) * 100).toFixed(1)}%</b> <span style="font-size: 0.9em; color: #666;">(${s.High})</span></td>
            <td><b>${((s.Low / s.Total) * 100).toFixed(1)}%</b> <span style="font-size: 0.9em; color: #666;">(${s.Low})</span></td>
          </tr>`;
        });
      }
    }
    
    function renderSpinTable(data) {
      const tbody = document.getElementById('spinTable').querySelector('tbody');
      if (tbody) {
        tbody.innerHTML = '';
        
        // Sort by date, most recent first
        const sortedData = [...data].sort((a, b) => 
          new Date(parseSpreadsheetDate(b.Date)) - new Date(parseSpreadsheetDate(a.Date))
        ).slice(0, 20); // Show only 20 most recent
        
        sortedData.forEach(row => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="clickable" onclick="showSpin('${row['Spin'] || '#'}')">${row['Spin_id']}</td>
            <td>${row['Issue']}</td>
            <td><span class="severity-${row['Severity']}">${row['Severity']}</span></td>
            <td>${row['Enterprise']}</td>
            <td>${row.Date ? new Date(parseSpreadsheetDate(row.Date)).toLocaleDateString() : ''}</td>
          `;
          tbody.appendChild(tr);
        });
      }
    }
    
    function showSpin(url) {
      document.getElementById('spinIframe').src = url;
    }
    
    // Update MTD summary
    function updateMTDSummary(data) {
      const today = new Date();
      const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
      
      // Format dates for display
      const firstDayStr = firstDayOfMonth.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      const todayStr = today.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      document.getElementById('mtdDateRange').textContent = `${firstDayStr} - ${todayStr}`;
      
      // Filter data for current month
      const mtdData = data.filter(row => {
        const rowDate = parseSpreadsheetDate(row.Date);
        return rowDate >= firstDayOfMonth && rowDate <= today;
      });
      
      // Calculate counts
      const blocker = mtdData.filter(row => row.Severity === 'Blocker').length;
      const high = mtdData.filter(row => row.Severity === 'High').length;
      const low = mtdData.filter(row => row.Severity === 'Low').length;
      const total = mtdData.length;
      
      // Update summary values
      document.getElementById('mtdTotalIssues').textContent = total;
      document.getElementById('mtdBlockerCount').textContent = blocker;
      document.getElementById('mtdHighCount').textContent = high;
      document.getElementById('mtdLowCount').textContent = low;
      
      // Update MTD summary in the container
      document.getElementById('mtdTotal').textContent = total;
      document.getElementById('mtdBlocker').textContent = blocker;
      document.getElementById('mtdHigh').textContent = high;
      document.getElementById('mtdLow').textContent = low;
      
      // Update MTD tables
      updateMTDIssueTable(mtdData);
      updateMTDEnterpriseTable(mtdData);
    }
    
    function updateMTDIssueTable(data) {
      const tbody = document.getElementById('mtdIssueTable').querySelector('tbody');
      if (tbody) {
        tbody.innerHTML = '';
        
        // Count issues
        const issueCounts = {};
        data.forEach(row => {
          const issue = row.Issue || 'Other';
          issueCounts[issue] = (issueCounts[issue] || 0) + 1;
        });
        
        // Sort by count
        const sortedIssues = Object.entries(issueCounts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5); // Top 5 issues
        
        const total = data.length;
        
        sortedIssues.forEach(([issue, count]) => {
          const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
          tbody.innerHTML += `
            <tr>
              <td>${issue}</td>
              <td>${count}</td>
              <td>${percentage}%</td>
            </tr>
          `;
        });
      }
    }
    
    function updateMTDEnterpriseTable(data) {
      const tbody = document.getElementById('mtdEnterpriseTable').querySelector('tbody');
      if (tbody) {
        tbody.innerHTML = '';
        
        // Count enterprises
        const enterpriseCounts = {};
        data.forEach(row => {
          const ent = row.Enterprise || 'Unknown';
          enterpriseCounts[ent] = (enterpriseCounts[ent] || 0) + 1;
        });
        
        // Sort by count
        const sortedEnterprises = Object.entries(enterpriseCounts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5); // Top 5 enterprises
        
        const total = data.length;
        
        sortedEnterprises.forEach(([ent, count]) => {
          const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
          tbody.innerHTML += `
            <tr>
              <td>${ent}</td>
              <td>${count}</td>
              <td>${percentage}%</td>
            </tr>
          `;
        });
      }
    }
    
    // Initialize on page load
    window.onload = async () => {
      await loadAndRender();
      generateWeekLabels();
      
      // Set up auto-refresh every 5 minutes
      setInterval(() => {
        document.getElementById('lastUpdated').textContent = 'Refreshing data...';
        loadAndRender();
      }, 300000); // 5 minutes
    };
  </script>
</body>
</html>
