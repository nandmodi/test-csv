<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" href="https://spyne-prod-ai.s3.amazonaws.com/ai-dataset/2025/favicon.ico" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Live User Tracker - ECG View</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #0c0f1c;
      margin: 0;
      padding: 20px;
      color: #fff;
    }

    h1 {
      text-align: center;
      font-weight: 600;
      margin-bottom: 20px;
    }

    .user-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      max-width: 900px;
      margin: auto;
    }

    .user-card {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      background-color: #1a1f2e;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.1);
    }

    .user-info {
      flex: 0 0 200px;
    }

    .user-info .name {
      font-size: 18px;
      font-weight: bold;
    }

    .user-info .time {
      font-size: 14px;
      color: #ccc;
    }

    .ecg {
      flex: 1;
      height: 60px;
      position: relative;
    }

    .ecg svg {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <div class="clock" id="liveClock">--:--:--</div>
  <h1>User Live Status - Lifeline</h1>
  <div style="text-align: center; margin-bottom: 20px;">
    <button class="dropdown-button" onclick="toggleDropdown()">Select Users</button>
    <div class="dropdown-menu" id="dropdownMenu"></div>
  </div>
  <div class="user-container" id="userContainer"></div>

  <script>
    const METABASE_URL = 'https://metabase.spyne.ai';  // Metabase instance URL
    const LIVE_THRESHOLD_SECONDS = 240;  // Threshold for live user status
    let users = [];
    let latest = {};
    let selectedUsers = JSON.parse(localStorage.getItem('selectedUsers') || '[]');
    let sessionToken = ''; // Will hold the session token

    // Step 1: Authenticate and get session token
    function authenticateMetabase(username, password) {
      return fetch(`${METABASE_URL}/api/session`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          username: username,
          password: password,
        }),
      })
        .then(res => res.json())
        .then(data => {
          sessionToken = data.id; // Store the session token for later requests
          console.log('Authenticated! Session Token:', sessionToken);
        })
        .catch(error => console.error('Authentication failed:', error));
    }

    // Step 2: List all Databases
    function listDatabases() {
      return fetch(`${METABASE_URL}/api/database`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'X-Metabase-Session': sessionToken,
        },
      })
        .then(res => res.json())
        .then(data => {
          console.log('Databases:', data);
          return data;  // Return list of databases
        })
        .catch(error => console.error('Error fetching databases:', error));
    }

    // Step 3: Execute SQL Query
    function executeSQLQuery(databaseId, query) {
      return fetch(`${METABASE_URL}/api/dataset`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Metabase-Session': sessionToken,
        },
        body: JSON.stringify({
          database: databaseId,
          type: 'native',
          native: {
            query: query,
            'template-tags': {},
          },
        }),
      })
        .then(res => res.json())
        .then(data => {
          console.log('SQL Query Result:', data);
          return data;  // Return query result
        })
        .catch(error => console.error('Error executing SQL query:', error));
    }

    // Step 4: Get Database Tables (Metadata)
    function getDatabaseMetadata(databaseId) {
      return fetch(`${METABASE_URL}/api/database/${databaseId}/metadata`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'X-Metabase-Session': sessionToken,
        },
      })
        .then(res => res.json())
        .then(data => {
          console.log('Database Metadata:', data);
          return data;  // Return table metadata
        })
        .catch(error => console.error('Error fetching database metadata:', error));
    }

    // Toggle the dropdown visibility
    function toggleDropdown() {
      const menu = document.getElementById('dropdownMenu');
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    }

    // Save selected users to local storage
    function saveSelection() {
      const checkboxes = document.querySelectorAll('#dropdownMenu input[type="checkbox"]');
      selectedUsers = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
      localStorage.setItem('selectedUsers', JSON.stringify(selectedUsers));
      renderUsers();
      closeDropdown();
    }

    // Close the dropdown menu
    function closeDropdown() {
      document.getElementById('dropdownMenu').style.display = 'none';
    }

    // Render the dropdown menu with users
    function renderDropdown() {
      const container = document.getElementById('dropdownMenu');
      container.innerHTML = '';
      const selectAllLabel = document.createElement('label');
      selectAllLabel.innerHTML = `<input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)"> Select All`;
      container.appendChild(selectAllLabel);
      users.sort().forEach(user => {
        const label = document.createElement('label');
        label.innerHTML = `<input type="checkbox" value="${user}" ${selectedUsers.includes(user) ? 'checked' : ''}> ${user}`;
        container.appendChild(label);
      });
      const footer = document.createElement('div');
      footer.className = 'footer';
      footer.innerHTML = `<button onclick="closeDropdown()">Cancel</button><button onclick="saveSelection()">OK</button>`;
      container.appendChild(footer);
    }

    // Toggle select all checkboxes in the dropdown
    function toggleSelectAll(checkbox) {
      const inputs = document.querySelectorAll('#dropdownMenu input[type="checkbox"]');
      inputs.forEach(cb => { if (cb !== checkbox) cb.checked = checkbox.checked; });
    }

    // Render user data on the screen
    function renderUsers() {
      const container = document.querySelector('.user-container');
      container.innerHTML = '';
      const now = new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' }));

      const renderList = (selectedUsers.length ? selectedUsers : users)
        .map(user => {
          const lastLog = latest[user];
          const lastLogDate = new Date(lastLog);
          let diffSec = !isNaN(lastLogDate) ? Math.floor((now - lastLogDate) / 1000) : Infinity;
          return {
            user,
            diffSec,
            status: diffSec <= LIVE_THRESHOLD_SECONDS ? 'live' : 'offline',
            diffText: !isFinite(diffSec) || diffSec < 0
              ? '??:??'
              : `${String(Math.floor(diffSec / 60)).padStart(2, '0')}:${String(diffSec % 60).padStart(2, '0')}`
          };
        }).sort((a, b) => a.diffSec - b.diffSec);

      renderList.forEach(({ user, diffText, status }) => {
        const card = document.createElement('div');
        card.className = 'user-card';

        const info = document.createElement('div');
        info.className = 'user-info';
        info.innerHTML = `<div class="name">${user}</div><div class="time">Time: ${diffText}</div>`;

        const ecg = document.createElement('div');
        ecg.className = `ecg ${status}`;
        ecg.innerHTML = status === 'offline'
          ? `<svg viewBox="0 0 1600 60" preserveAspectRatio="none"><polyline class="flatline" points="0,30 1600,30" /></svg>`
          : `<svg viewBox="0 0 1600 20" preserveAspectRatio="none"><polyline class="wave" points="0,10 10,10 15,5 20,15 25,10 40,10 50,2 55,10 60,10 100,10 110,10 115,5 120,15 125,10 140,10 150,2 155,10 160,10 200,10 210,10 215,5 220,15 225,10 240,10 250,2 255,10 260,10 300,10 310,10 315,5 320,15 325,10 340,10 350,2 355,10 360,10 400,10 410,10 415,5 420,15 425,10 440,10 450,2 455,10 460,10 500,10 510,10 515,5 520,15 525,10 540,10 550,2 555,10 560,10 600,10 610,10 615,5 620,15 625,10 640,10 650,2 655,10 660,10 700,10 710,10 715,5 720,15 725,10 740,10 750,2 755,10 760,10 800,10 810,10 815,5 820,15 825,10 840,10 850,2 855,10 860,10 900,10 910,10 915,5 920,15 925,10 940,10 950,2 955,10 960,10 1000,10 1010,10 1015,5 1020,15 1025,10 1040,10 1050,2 1055,10 1060,10 1100,10 1110,10 1115,5 1120,15 1125,10 1140,10 1150,2 1155,10 1160,10 1200,10 1210,10 1215,5 1220,15 1225,10 1240,10 1250,2 1255,10 1260,10 1300,10 1310,10 1315,5 1320,15 1325,10 1340,10 1350,2 1355,10 1360,10 1400,10 1410,10 1415,5 1420,15 1425,10 1440,10 1450,2 1455,10 1460,10 1500,10 1510,10 1515,5 1520,15 1525,10 1540,10 1550,2 1555,10 1560,10 1600,10"/></svg>`;

        card.appendChild(info);
        card.appendChild(ecg);
        container.appendChild(card);
      });
    }

    // Initialize Metabase credentials (you can hardcode or prompt for login)
    const username = 'kishor@spyne.ai'; // Replace with your Metabase username
    const password = 'Event1l@1812$Pyne'; // Replace with your Metabase password

    // Authenticate and render data
    authenticateMetabase(username, password)
      .then(() => {
        listDatabases() // Fetch list of databases
          .then(databases => {
            console.log('Available Databases:', databases);
            // Example: Get database metadata for database ID 8138
            const databaseId = 8138;  // Replace with your database ID
            getDatabaseMetadata(databaseId)
              .then(data => {
                console.log('Database Metadata:', data);
                // You can further render or manipulate this metadata as needed
              });
          })
          .catch(error => console.error('Error fetching databases:', error));
      })
      .catch(error => console.error('Authentication failed:', error));

    // Set up clock update interval
    setInterval(() => {
      const now = new Date().toLocaleTimeString('en-IN', { hour12: false });
      document.getElementById('liveClock').textContent = now;
    }, 1000);
  </script>
</body>
</html>
