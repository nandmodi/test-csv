<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Live User Tracker</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #0c0f1c;
      margin: 0;
      padding: 20px;
      color: #fff;
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
      font-weight: 600;
    }

    .filter-wrapper {
      text-align: center;
      margin-bottom: 20px;
    }

    .dropdown-button {
      background-color: #1a1f2e;
      color: white;
      padding: 10px 20px;
      border: 1px solid #444;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
    }

    .dropdown-menu {
      display: none;
      position: absolute;
      background-color: #fff;
      color: #000;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      padding: 10px;
      z-index: 1000;
      max-height: 300px;
      overflow-y: auto;
      max-width: fit-content;
      left: 50%;
      transform: translateX(-50%);
    }

    .dropdown-menu label {
      display: block;
      padding: 6px 10px;
      cursor: pointer;
      text-align: left;
    }

    .dropdown-menu .footer {
      display: flex;
      justify-content: flex-end;
      margin-top: 10px;
    }

    .dropdown-menu .footer button {
      padding: 6px 12px;
      margin-left: 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .user-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      max-width: 900px;
      margin: auto;
    }

    .user-card {
      display: flex;
      align-items: center;
      background-color: #1a1f2e;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.1);
      width: 100%;
    }

    .user-info {
      flex: 0 0 200px;
    }

    .user-info .name {
      font-size: 18px;
      font-weight: bold;
      text-align: left;
    }

    .user-info .time {
      font-size: 14px;
      color: #ccc;
      text-align: left;
    }

    .ecg {
      flex: 1;
      height: 40px;
    }

    .ecg polyline {
      fill: none;
      stroke-width: 2;
      stroke-linejoin: round;
      stroke-linecap: round;
    }

    .ecg.live polyline {
      stroke: #00ffcc;
      stroke-dasharray: 200;
      stroke-dashoffset: 200;
      animation: dash 1.5s linear infinite;
    }

    .ecg.offline polyline {
      stroke: red;
    }

    @keyframes dash {
      to {
        stroke-dashoffset: 0;
      }
    }
  </style>
</head>
<body>
  <h1>User Live Status</h1>
  <div class="filter-wrapper">
    <button class="dropdown-button" onclick="toggleDropdown()">Select Users</button>
    <div class="dropdown-menu" id="dropdownMenu"></div>
  </div>
  <div class="user-container" id="userContainer"></div>

  <script>
    const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSo76L7XI-AHGphJRHyTXCwMVuizeUUfb23MlzOvKRJBXF4JccS_gl5koNEzy6I61crp7dLXYPvYP2W/pub?gid=0&single=true&output=csv';

    let selectedUsers = JSON.parse(localStorage.getItem('selectedUsers') || '[]');
    let allUsers = [];

    function toggleDropdown() {
      const menu = document.getElementById('dropdownMenu');
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    }

    function closeDropdown() {
      document.getElementById('dropdownMenu').style.display = 'none';
    }

    function saveSelection() {
      const checkboxes = document.querySelectorAll('#dropdownMenu input[type="checkbox"]');
      selectedUsers = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
      localStorage.setItem('selectedUsers', JSON.stringify(selectedUsers));
      updateData();
      closeDropdown();
    }

    function cancelSelection() {
      closeDropdown();
    }

    function renderDropdown(users) {
      const container = document.getElementById('dropdownMenu');
      container.innerHTML = '';
      users.sort((a, b) => a.localeCompare(b)).forEach(user => {
        const label = document.createElement('label');
        label.innerHTML = `<input type="checkbox" value="${user}" ${selectedUsers.includes(user) ? 'checked' : ''}> ${user}`;
        container.appendChild(label);
      });
      const footer = document.createElement('div');
      footer.className = 'footer';
      footer.innerHTML = `<button onclick="cancelSelection()">Cancel</button><button onclick="saveSelection()">OK</button>`;
      container.appendChild(footer);
    }

    async function fetchCSVData() {
      const res = await fetch(sheetUrl);
      const text = await res.text();
      const rows = text.trim().split('\n').map(row => row.split(','));
      const headers = rows[0];
      const data = rows.slice(1).map(row => {
        let obj = {};
        headers.forEach((h, i) => obj[h.trim()] = row[i]?.trim());
        return obj;
      });
      return data;
    }

    function calculateTimeDiff(lastLog) {
      const [date, time] = lastLog.split(' ');
      const last = new Date(`${date}T${time}`);
      const now = new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' }));
      if (isNaN(last)) return { status: 'offline', diff: '??:??' };
      const diffSec = Math.floor((now - last) / 1000);
      const mins = String(Math.floor(diffSec / 60)).padStart(2, '0');
      const secs = String(diffSec % 60).padStart(2, '0');
      const status = diffSec <= 240 ? 'live' : 'offline';
      return { status, diff: `${mins}:${secs}` };
    }

    function createECGSVG(status) {
      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.setAttribute('class', `ecg ${status}`);
      svg.setAttribute('viewBox', '0 0 100 20');
      const polyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
      polyline.setAttribute('points', status === 'live' ? '0,10 10,10 15,5 20,15 25,10 40,10 50,2 55,10 60,10 100,10' : '0,10 100,10');
      svg.appendChild(polyline);
      return svg;
    }

    function renderUsers(data) {
      const container = document.getElementById('userContainer');
      container.innerHTML = '';

      const latestLogs = {};
      data.forEach(row => {
        const user = row['User'];
        const log = row['Last Log'];
        if (!latestLogs[user] || new Date(log) > new Date(latestLogs[user]['Last Log'])) {
          latestLogs[user] = row;
        }
      });

      const filtered = selectedUsers.length > 0
        ? Object.entries(latestLogs).filter(([user]) => selectedUsers.includes(user))
        : Object.entries(latestLogs);

      filtered.forEach(([user, info]) => {
        const { status, diff } = calculateTimeDiff(info['Last Log']);
        const card = document.createElement('div');
        card.className = 'user-card';
        const infoDiv = document.createElement('div');
        infoDiv.className = 'user-info';
        infoDiv.innerHTML = `<div class="name">${user}</div><div class="time">Time: ${diff}</div>`;
        const svg = createECGSVG(status);
        card.appendChild(infoDiv);
        card.appendChild(svg);
        container.appendChild(card);
      });
    }

    function updateDropdown(data) {
      allUsers = [...new Set(data.map(d => d['User']))];
      renderDropdown(allUsers);
    }

    async function updateData() {
      const data = await fetchCSVData();
      updateDropdown(data);
      renderUsers(data);
    }

    updateData();
    setInterval(updateData, 60000);
  </script>
</body>
</html>
